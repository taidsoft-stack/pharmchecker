<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PharmChecker ìš´ì˜ ëŒ€ì‹œë³´ë“œ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { background-color: #f5f5f5; }
    .navbar { box-shadow: 0 2px 4px rgba(0,0,0,.08); }
    .sidebar {
      min-height: calc(100vh - 52px);
      background: white;
      border-right: 1px solid #dbdbdb;
      padding: 1.5rem 0;
    }
    .menu-label {
      padding: 0 1rem;
      text-transform: uppercase;
      font-size: 0.75rem;
      font-weight: 700;
      color: #7a7a7a;
    }
    .menu-list a {
      border-radius: 0;
      padding: 0.75rem 1.5rem;
    }
    .menu-list a.is-active {
      background-color: #3273dc;
      color: white;
    }
    .stat-card {
      background: white;
      border-radius: 6px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      margin-bottom: 1.5rem;
    }
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #3273dc;
    }
    .stat-label {
      color: #7a7a7a;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
    .content-area {
      padding: 2rem;
    }
    .quick-action {
      transition: transform 0.2s;
    }
    .quick-action:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="navbar is-white" role="navigation">
    <div class="navbar-brand">
      <div class="navbar-item">
        <strong>ğŸ¥ PharmChecker ìš´ì˜ ëŒ€ì‹œë³´ë“œ</strong>
      </div>
    </div>
    
    <div class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
            <i class="fas fa-user-shield"></i>
            <span id="adminName"><%= typeof adminName !== 'undefined' ? adminName : 'ê´€ë¦¬ì' %></span>
          </a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="columns is-gapless">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="column is-2 sidebar">
      <aside class="menu">
        <p class="menu-label">ë©”ì¸</p>
        <ul class="menu-list">
          <li><a class="is-active" onclick="window.location.reload()">
            <i class="fas fa-home"></i> ëŒ€ì‹œë³´ë“œ
          </a></li>
        </ul>

        <p class="menu-label">êµ¬ë… ê´€ë¦¬</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('users')">
            <i class="fas fa-users"></i> íšŒì› ê´€ë¦¬
          </a></li>
          <li><a onclick="window.location.href='/admin/mobile'">
            <i class="fas fa-mobile-alt"></i> ëª¨ë°”ì¼ ì¡°íšŒ
          </a></li>
          <li><a onclick="loadPage('subscriptions')">
            <i class="fas fa-credit-card"></i> êµ¬ë… í˜„í™©
          </a></li>
          <li><a onclick="loadPage('payments')">
            <i class="fas fa-receipt"></i> ê²°ì œ ë‚´ì—­
          </a></li>
        </ul>

        <p class="menu-label">ê³ ê° ë¬¸ì˜ ê´€ë¦¬</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('support-tickets')">
            <i class="fas fa-headset"></i> ë¬¸ì˜ ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('remote-support')">
            <i class="fas fa-desktop"></i> ì›ê²© ì§€ì› ê´€ë¦¬
          </a></li>
        </ul>

        <p class="menu-label">í”„ë¡œëª¨ì…˜</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('promotions')">
            <i class="fas fa-gift"></i> í”„ë¡œëª¨ì…˜ ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('referral-codes')">
            <i class="fas fa-ticket-alt"></i> ì¶”ì²œì¸ ì½”ë“œ
          </a></li>
          <li><a onclick="loadPage('assign-promotion')">
            <i class="fas fa-user-tag"></i> í”„ë¡œëª¨ì…˜ í• ë‹¹
          </a></li>
        </ul>

        <p class="menu-label">ì‹œìŠ¤í…œ</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('plans')">
            <i class="fas fa-layer-group"></i> í”Œëœ ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('activity-logs')">
            <i class="fas fa-history"></i> í™œë™ ë¡œê·¸
          </a></li>
          <li><a onclick="loadPage('settings')">
            <i class="fas fa-cog"></i> ì„¤ì •
          </a></li>
        </ul>
      </aside>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="column content-area">
      <div id="mainContent">
        <!-- ëŒ€ì‹œë³´ë“œ í†µê³„ -->
        <h1 class="title">ëŒ€ì‹œë³´ë“œ</h1>
        
        <div class="columns is-multiline">
          <!-- í†µê³„ ì¹´ë“œë“¤ -->
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="totalUsers">-</div>
              <div class="stat-label">ì „ì²´ íšŒì›</div>
            </div>
          </div>
          
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="activeSubscriptions">-</div>
              <div class="stat-label">í™œì„± êµ¬ë…</div>
            </div>
          </div>
          
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="monthlyRevenue">-</div>
              <div class="stat-label">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div>
            </div>
          </div>
          
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="activePromotions">-</div>
              <div class="stat-label">í™œì„± í”„ë¡œëª¨ì…˜</div>
            </div>
          </div>
        </div>

        <!-- ë¹ ë¥¸ ì‘ì—… -->
        <h2 class="title is-4 mt-5">ë¹ ë¥¸ ì‘ì—…</h2>
        <div class="columns is-multiline">
          <div class="column is-4">
            <div class="box quick-action" onclick="loadPage('promotions')">
              <div class="media">
                <div class="media-left">
                  <span class="icon is-large has-text-info">
                    <i class="fas fa-2x fa-gift"></i>
                  </span>
                </div>
                <div class="media-content">
                  <p class="title is-5">í”„ë¡œëª¨ì…˜ ìƒì„±</p>
                  <p class="subtitle is-6">ìƒˆë¡œìš´ í• ì¸/ë¬´ë£Œ í”„ë¡œëª¨ì…˜</p>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-4">
            <div class="box quick-action" onclick="loadPage('assign-promotion')">
              <div class="media">
                <div class="media-left">
                  <span class="icon is-large has-text-success">
                    <i class="fas fa-2x fa-user-tag"></i>
                  </span>
                </div>
                <div class="media-content">
                  <p class="title is-5">í”„ë¡œëª¨ì…˜ í• ë‹¹</p>
                  <p class="subtitle is-6">íšŒì›ì—ê²Œ í”„ë¡œëª¨ì…˜ ë¶€ì—¬</p>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-4">
            <div class="box quick-action" onclick="loadPage('users')">
              <div class="media">
                <div class="media-left">
                  <span class="icon is-large has-text-warning">
                    <i class="fas fa-2x fa-users"></i>
                  </span>
                </div>
                <div class="media-content">
                  <p class="title is-5">íšŒì› ì¡°íšŒ</p>
                  <p class="subtitle is-6">íšŒì› ì •ë³´ ë° êµ¬ë… ìƒíƒœ</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ìµœê·¼ í™œë™ -->
        <h2 class="title is-4 mt-5">ìµœê·¼ í™œë™</h2>
        <div class="box">
          <table class="table is-fullwidth is-hoverable">
            <thead>
              <tr>
                <th>ì‹œê°„</th>
                <th>í™œë™</th>
                <th>ëŒ€ìƒ</th>
                <th>ê´€ë¦¬ì</th>
              </tr>
            </thead>
            <tbody id="recentActivities">
              <tr>
                <td colspan="4" class="has-text-centered">ë¡œë”© ì¤‘...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- íšŒì› ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
  <div class="modal" id="userDetailModal">
    <div class="modal-background" onclick="closeUserDetailModal()"></div>
    <div class="modal-card" style="width: 90%; max-width: 1200px;">
      <header class="modal-card-head">
        <p class="modal-card-title">
          <i class="fas fa-user-circle"></i> <span id="modalUserName">íšŒì› ìƒì„¸ ì •ë³´</span>
        </p>
        <button class="delete" aria-label="close" onclick="closeUserDetailModal()"></button>
      </header>
      <section class="modal-card-body" style="max-height: 80vh; overflow-y: auto;">
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tabs is-boxed">
          <ul>
            <li class="is-active" data-tab="basic">
              <a onclick="switchTab('basic')">
                <span class="icon is-small"><i class="fas fa-info-circle"></i></span>
                <span>ê¸°ë³¸ ì •ë³´</span>
              </a>
            </li>
            <li data-tab="subscription">
              <a onclick="switchTab('subscription')">
                <span class="icon is-small"><i class="fas fa-credit-card"></i></span>
                <span>êµ¬ë… ë‚´ì—­</span>
              </a>
            </li>
            <li data-tab="payment">
              <a onclick="switchTab('payment')">
                <span class="icon is-small"><i class="fas fa-money-bill-wave"></i></span>
                <span>ê²°ì œ ë‚´ì—­</span>
              </a>
            </li>
            <li data-tab="promotion">
              <a onclick="switchTab('promotion')">
                <span class="icon is-small"><i class="fas fa-gift"></i></span>
                <span>í”„ë¡œëª¨ì…˜</span>
              </a>
            </li>
            <li data-tab="activity">
              <a onclick="switchTab('activity')">
                <span class="icon is-small"><i class="fas fa-history"></i></span>
                <span>í™œë™ ë¡œê·¸</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- íƒ­ ì»¨í…ì¸  -->
        <div id="tabContent">
          <!-- ê¸°ë³¸ ì •ë³´ íƒ­ -->
          <div id="tab-basic" class="tab-content is-active">
            <h5 class="title is-5"><i class="fas fa-user"></i> íšŒì› ê¸°ë³¸ ì •ë³´</h5>
            <div class="columns is-multiline">
              <div class="column is-6">
                <div class="field">
                  <label class="label">ì•½êµ­ëª…</label>
                  <div class="control">
                    <input class="input" id="detailPharmacyName" readonly>
                  </div>
                </div>
              </div>
              <div class="column is-6">
                <div class="field">
                  <label class="label">ê°€ì…ì¼</label>
                  <div class="control">
                    <input class="input" id="detailCreatedAt" readonly>
                  </div>
                </div>
              </div>
              <div class="column is-8">
                <div class="field">
                  <label class="label">ì•½êµ­ ì£¼ì†Œ</label>
                  <div class="control">
                    <input class="input" id="detailAddress" readonly>
                  </div>
                </div>
              </div>
              <div class="column is-4">
                <div class="field">
                  <label class="label">ê³„ì • ìƒíƒœ</label>
                  <div class="control">
                    <span id="detailAccountStatus" class="tag is-medium"></span>
                  </div>
                </div>
              </div>
            </div>
            
            <hr>
            <h5 class="title is-5"><i class="fas fa-sticky-note"></i> ê´€ë¦¬ì ë©”ëª¨ ë° ë¹„ê³ </h5>
            
            <!-- ìƒˆ ë©”ëª¨/ë¹„ê³  ì‘ì„± -->
            <div class="box" style="background-color: #f5f5f5;">
              <h6 class="subtitle is-6">ìƒˆ ë©”ëª¨/ë¹„ê³  ì‘ì„±</h6>
              <div class="field">
                <label class="label">ë©”ëª¨</label>
                <div class="control">
                  <textarea class="textarea" id="newMemoText" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
                </div>
              </div>
              <div class="field">
                <label class="label">ë¹„ê³  (ê°„ë‹¨í•œ ìš”ì•½, 200ì ì´ë‚´)</label>
                <div class="control">
                  <input class="input" type="text" id="newRemarksText" maxlength="200" placeholder="ë¹„ê³ ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                </div>
              </div>
              <div class="field">
                <div class="control">
                  <button class="button is-primary" onclick="saveNewMemo()">
                    <i class="fas fa-save"></i> ì €ì¥
                  </button>
                </div>
              </div>
            </div>
            
            <!-- ë©”ëª¨ ë‚´ì—­ -->
            <h6 class="subtitle is-6">ë©”ëª¨ ë‚´ì—­</h6>
            <div id="memoList"></div>
          </div>

          <!-- êµ¬ë… ë‚´ì—­ íƒ­ -->
          <div id="tab-subscription" class="tab-content" style="display: none;">
            <div id="subscriptionList"></div>
          </div>

          <!-- ê²°ì œ ë‚´ì—­ íƒ­ -->
          <div id="tab-payment" class="tab-content" style="display: none;">
            <div class="table-container">
              <table class="table is-fullwidth is-hoverable">
                <thead>
                  <tr>
                    <th>ê²°ì œì¼</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ê²°ì œ ìˆ˜ë‹¨</th>
                    <th>ìƒíƒœ</th>
                    <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                    <th>ì‹¤íŒ¨ ì‚¬ìœ </th>
                  </tr>
                </thead>
                <tbody id="paymentList"></tbody>
              </table>
            </div>
          </div>

          <!-- í”„ë¡œëª¨ì…˜ íƒ­ -->
          <div id="tab-promotion" class="tab-content" style="display: none;">
            <div class="table-container">
              <table class="table is-fullwidth is-hoverable">
                <thead>
                  <tr>
                    <th>í”„ë¡œëª¨ì…˜ íƒ€ì…</th>
                    <th>í• ì¸ìœ¨</th>
                    <th>ë¬´ë£Œ ê°œì›”</th>
                    <th>ì‹œì‘ì¼</th>
                    <th>ë§Œë£Œì¼</th>
                    <th>ìƒíƒœ</th>
                  </tr>
                </thead>
                <tbody id="promotionList"></tbody>
              </table>
            </div>
          </div>

          <!-- í™œë™ ë¡œê·¸ íƒ­ -->
          <div id="tab-activity" class="tab-content" style="display: none;">
            <div class="table-container">
              <table class="table is-fullwidth is-hoverable is-narrow" style="font-size: 0.85rem;">
                <thead>
                  <tr>
                    <th>ì‹œê°„</th>
                    <th>í™œë™</th>
                    <th>ê´€ë¦¬ì</th>
                    <th>ìƒì„¸</th>
                  </tr>
                </thead>
                <tbody id="activityList"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button" onclick="closeUserDetailModal()">ë‹«ê¸°</button>
      </footer>
    </div>
  </div>

  <script>
    // URLì„ /adminìœ¼ë¡œ ë³€ê²½
    if (window.location.pathname !== '/admin') {
      window.history.replaceState(null, '', '/admin');
    }
    
    // ë¡œê·¸ì¸ í™•ì¸
    function checkAuth() {
      const sessionToken = localStorage.getItem('admin_session_token');
      if (!sessionToken) {
        window.location.href = '/admin';
        return;
      }
      loadAdminInfo();
    }

    // ê´€ë¦¬ì ì •ë³´ ë¡œë“œ
    async function loadAdminInfo() {
      try {
        // ì¿ í‚¤ì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
        const cookies = document.cookie.split(';').reduce((acc, cookie) => {
          const trimmed = cookie.trim();
          const eqIndex = trimmed.indexOf('=');
          if (eqIndex > 0) {
            const key = trimmed.substring(0, eqIndex);
            const value = trimmed.substring(eqIndex + 1);
            acc[key] = value;
          }
          return acc;
        }, {});
        const token = cookies['admin_session_token'] || localStorage.getItem('admin_session_token');
        
        if (!token) {
          throw new Error('í† í° ì—†ìŒ');
        }
        
        // localStorageì—ë„ ì €ì¥ (í˜¸í™˜ì„±)
        localStorage.setItem('admin_session_token', token);
        
        const response = await fetch('/admin/api/me', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        if (!response.ok) {
          throw new Error('ì¸ì¦ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        document.getElementById('adminName').textContent = data.admin_name + ' (' + data.email + ')';
      } catch (error) {
        console.error('ê´€ë¦¬ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ëª¨ë“  ì„¸ì…˜ ì •ë³´ ì‚­ì œ
        localStorage.removeItem('admin_session_token');
        
        // ì¿ í‚¤ ì‚­ì œ
        const cookiesToDelete = [
          'admin_session_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
          'admin_session_token=; path=/admin; expires=Thu, 01 Jan 1970 00:00:00 GMT',
          'admin_session_token=; domain=' + window.location.hostname + '; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
        ];
        cookiesToDelete.forEach(cookie => document.cookie = cookie);
        
        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        window.location.href = '/admin';
      }
    }

    // ëŒ€ì‹œë³´ë“œ í†µê³„ ë¡œë“œ
    async function loadDashboardStats() {
      try {
        const token = localStorage.getItem('admin_session_token');
        console.log('í†µê³„ API í˜¸ì¶œ ì‹œì‘, í† í°:', token ? 'ì¡´ì¬' : 'ì—†ìŒ');
        
        const response = await fetch('/admin/api/dashboard/stats', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        console.log('í†µê³„ API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
        
        if (!response.ok) {
          // ì¸ì¦ ì˜¤ë¥˜ë©´ ì„¸ì…˜ ë§Œë£Œë¡œ ì²˜ë¦¬
          if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('admin_session_token');
            const cookiesToDelete = [
              'admin_session_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
              'admin_session_token=; path=/admin; expires=Thu, 01 Jan 1970 00:00:00 GMT'
            ];
            cookiesToDelete.forEach(cookie => document.cookie = cookie);
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            window.location.href = '/admin';
            return;
          }
          
          const errorText = await response.text();
          console.error('í†µê³„ API ì˜¤ë¥˜:', errorText);
          throw new Error('í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ' + response.status);
        }
        
        const stats = await response.json();
        
        console.log('ëŒ€ì‹œë³´ë“œ í†µê³„:', stats);
        
        document.getElementById('totalUsers').textContent = stats.totalUsers.toLocaleString();
        document.getElementById('activeSubscriptions').textContent = stats.activeSubscriptions.toLocaleString();
        document.getElementById('monthlyRevenue').textContent = `${(stats.monthlyRevenue / 10000).toFixed(0)}ë§Œì›`;
        document.getElementById('activePromotions').textContent = stats.activePromotions.toLocaleString();
        
      } catch (error) {
        console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('totalUsers').textContent = 'ì˜¤ë¥˜';
        document.getElementById('activeSubscriptions').textContent = 'ì˜¤ë¥˜';
        document.getElementById('monthlyRevenue').textContent = 'ì˜¤ë¥˜';
        document.getElementById('activePromotions').textContent = 'ì˜¤ë¥˜';
      }
    }

    // ìµœê·¼ í™œë™ ë¡œë“œ
    async function loadRecentActivities() {
      try {
        const response = await fetch('/admin/api/activities/recent', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const activities = await response.json();
        const tbody = document.getElementById('recentActivities');
        
        if (activities.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="has-text-centered">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }
        
        tbody.innerHTML = activities.map(act => `
          <tr>
            <td>${new Date(act.created_at).toLocaleString('ko-KR')}</td>
            <td><span class="tag">${act.action_type}</span></td>
            <td>${act.target_type || '-'}</td>
            <td>${act.admin_name}</td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('í™œë™ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // í˜ì´ì§€ ì „í™˜
    function loadPage(page) {
      // ë©”ë‰´ í™œì„±í™” ìƒíƒœ ë³€ê²½
      document.querySelectorAll('.menu-list a').forEach(a => a.classList.remove('is-active'));
      const menuLink = event?.target?.closest('a');
      if (menuLink) {
        menuLink.classList.add('is-active');
      }
      
      if (page === 'dashboard') {
        // ëŒ€ì‹œë³´ë“œëŠ” í˜„ì¬ í˜ì´ì§€ ë¦¬ë¡œë“œ
        location.reload();
        return;
      }
      
      if (page === 'users') {
        loadUsersPage();
        return;
      }
      
      if (page === 'subscriptions') {
        loadSubscriptionsPage();
        return;
      }
      
      if (page === 'payments') {
        loadPaymentsPage();
        return;
      }
      
      if (page === 'support-tickets') {
        loadSupportTicketsPage();
        return;
      }
      
      if (page === 'remote-support') {
        loadRemoteSupportPage();
        return;
      }
      
      // ticket-detail í˜ì´ì§€ëŠ” loadTicketDetailPageì—ì„œ ì²˜ë¦¬
      
      // TODO: í˜ì´ì§€ë³„ ì»¨í…ì¸  ë¡œë“œ
      alert(`${page} í˜ì´ì§€ ê°œë°œ ì˜ˆì •`);
    }
    
    // íšŒì› ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œ
    async function loadUsersPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <h1 class="title">íšŒì› ê´€ë¦¬</h1>
        
        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="box">
          <!-- ì²« ë²ˆì§¸ í–‰: ì´ë¦„, ì´ë©”ì¼ ê²€ìƒ‰ -->
          <div class="columns">
            <div class="column is-3">
              <div class="field">
                <label class="label">ì•½ì‚¬ëª… ê²€ìƒ‰</label>
                <div class="control has-icons-left">
                  <input class="input" type="text" id="nameSearch" placeholder="ì•½ì‚¬ëª… ì…ë ¥">
                  <span class="icon is-small is-left">
                    <i class="fas fa-user"></i>
                  </span>
                </div>
              </div>
            </div>
            
            <div class="column is-3">
              <div class="field">
                <label class="label">ì´ë©”ì¼ ê²€ìƒ‰</label>
                <div class="control has-icons-left">
                  <input class="input" type="text" id="emailSearch" placeholder="ì´ë©”ì¼ ì…ë ¥">
                  <span class="icon is-small is-left">
                    <i class="fas fa-envelope"></i>
                  </span>
                </div>
              </div>
            </div>
            
            <div class="column is-2">
              <div class="field">
                <label class="label">êµ¬ë… ìƒíƒœ</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="subscriptionFilter">
                      <option value="">ì „ì²´</option>
                      <option value="active">í™œì„±</option>
                      <option value="cancelled">ì·¨ì†Œë¨</option>
                      <option value="none">ì—†ìŒ</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="column is-2">
              <div class="field">
                <label class="label">ê³„ì • ìƒíƒœ</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="accountFilter">
                      <option value="">ì „ì²´</option>
                      <option value="active">í™œì„±</option>
                      <option value="deleted">íƒˆí‡´</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="column is-2">
              <div class="field">
                <label class="label">&nbsp;</label>
                <button class="button is-primary is-fullwidth" onclick="searchUsers()">
                  <i class="fas fa-search"></i> ê²€ìƒ‰
                </button>
              </div>
            </div>
          </div>
          
          <!-- ë‘ ë²ˆì§¸ í–‰: ê¸°ê°„ í•„í„° -->
          <div class="columns">
            <div class="column is-3">
              <div class="field">
                <label class="label">ê¸°ê°„ ì‹œì‘ì¼</label>
                <div class="control">
                  <input class="input" type="date" id="startDate">
                </div>
              </div>
            </div>
            
            <div class="column is-3">
              <div class="field">
                <label class="label">ê¸°ê°„ ì¢…ë£Œì¼</label>
                <div class="control">
                  <input class="input" type="date" id="endDate">
                </div>
              </div>
            </div>
            
            <div class="column is-6">
              <div class="field">
                <label class="label">ê¸°ê°„ í•„í„° ì•ˆë‚´</label>
                <p class="help">
                  <i class="fas fa-info-circle"></i> 
                  íƒˆí‡´ íšŒì›: íƒˆí‡´ì¼ ê¸°ì¤€ / í™œì„± êµ¬ë…: êµ¬ë… ê¸°ê°„ ë‚´ í¬í•¨ / ê¸°íƒ€: ê°€ì…ì¼ ê¸°ì¤€
                </p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- íšŒì› ëª©ë¡ í…Œì´ë¸” -->
        <div class="box">
          <h5 class="title is-5" id="userCount">íšŒì› ëª©ë¡ (ì´ 0ëª…)</h5>
          <div class="table-container">
            <table class="table is-fullwidth is-hoverable is-narrow" style="font-size: 0.85rem;">
              <thead>
                <tr>
                  <th style="width: 40px;">#</th>
                  <th>ì´ë©”ì¼</th>
                  <th>ì•½ì‚¬ëª…</th>
                  <th>ì•½êµ­ëª…</th>
                  <th>ì „í™”ë²ˆí˜¸</th>
                  <th>êµ¬ë… ìƒíƒœ</th>
                  <th>í”Œëœ</th>
                  <th>êµ¬ë… ì‹œì‘ì¼</th>
                  <th>êµ¬ë… ì¢…ë£Œì¼</th>
                  <th>ë‹¤ìŒ ê²°ì œì¼</th>
                  <th>í”„ë¡œëª¨ì…˜</th>
                  <th style="min-width: 120px;">ë©”ëª¨</th>
                  <th style="min-width: 120px;">ë¹„ê³ </th>
                  <th>ìƒíƒœ</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr>
                  <td colspan="14" class="has-text-centered">ë¡œë”© ì¤‘...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
          <nav class="pagination is-centered" role="navigation" id="pagination">
            <a class="pagination-previous" id="prevPage">ì´ì „</a>
            <a class="pagination-next" id="nextPage">ë‹¤ìŒ</a>
            <ul class="pagination-list" id="pageNumbers"></ul>
          </nav>
      `;
      
      // íšŒì› ëª©ë¡ ë¡œë“œ
      await fetchUsers();
    }
    
    // ì „ì—­ ë³€ìˆ˜
    let currentPage = 1;
    let currentName = '';
    let currentEmail = '';
    let currentStartDate = '';
    let currentEndDate = '';
    let currentSubFilter = '';
    let currentAccFilter = '';
    
    // íšŒì› ê²€ìƒ‰
    function searchUsers() {
      currentPage = 1;
      currentName = document.getElementById('nameSearch').value;
      currentEmail = document.getElementById('emailSearch').value;
      currentStartDate = document.getElementById('startDate').value;
      currentEndDate = document.getElementById('endDate').value;
      currentSubFilter = document.getElementById('subscriptionFilter').value;
      currentAccFilter = document.getElementById('accountFilter').value;
      fetchUsers();
    }
    
    // íšŒì› ëª©ë¡ ì¡°íšŒ
    async function fetchUsers(page = 1) {
      currentPage = page;
      
      try {
        const params = new URLSearchParams({
          page: currentPage,
          limit: 20,
          name: currentName,
          email: currentEmail,
          startDate: currentStartDate,
          endDate: currentEndDate,
          subscriptionStatus: currentSubFilter,
          accountStatus: currentAccFilter
        });
        
        const response = await fetch('/admin/api/users?' + params, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const data = await response.json();
        
        // ì´ íšŒì› ìˆ˜ í‘œì‹œ
        document.getElementById('userCount').textContent = 'íšŒì› ëª©ë¡ (ì´ ' + data.total + 'ëª…)';
        
        // í…Œì´ë¸” ë Œë”ë§
        const tbody = document.getElementById('usersTableBody');
        
        if (!data.users || data.users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="14" class="has-text-centered">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.users.map((user, index) => {
          const rowNumber = (currentPage - 1) * 20 + index + 1;
          
          const subscriptionTag = user.subscription 
            ? '<span class="tag ' + (user.subscription.status === 'active' ? 'is-success' : 'is-warning') + '">' + (user.subscription.status === 'active' ? 'í™œì„±' : 'ì·¨ì†Œë¨') + '</span>'
            : '<span class="tag is-light">ì—†ìŒ</span>';
          
          const accountTag = user.is_deleted 
            ? '<span class="tag is-danger">íƒˆí‡´</span>' 
            : (user.is_active ? '<span class="tag is-success">í™œì„±</span>' : '<span class="tag is-warning">ë¹„í™œì„±</span>');
          
          const currentPeriodStart = user.subscription?.current_period_start
            ? new Date(user.subscription.current_period_start).toLocaleDateString('ko-KR')
            : '-';
            
          const currentPeriodEnd = user.subscription?.current_period_end
            ? new Date(user.subscription.current_period_end).toLocaleDateString('ko-KR')
            : '-';
          
          // íƒˆí‡´ íšŒì›ì´ë‚˜ êµ¬ë… í•´ì§€ ì˜ˆì•½ íšŒì›ì€ ë‹¤ìŒ ê²°ì œì¼ í‘œì‹œ ì•ˆ í•¨
          let nextBillingDate = '-';
          if (user.subscription?.next_billing_at && 
              !user.is_deleted && 
              user.subscription.status === 'active' && 
              !user.subscription.cancel_at_period_end) {
            nextBillingDate = new Date(user.subscription.next_billing_at).toLocaleDateString('ko-KR');
          }
          
          // í”„ë¡œëª¨ì…˜ ì •ë³´ í‘œì‹œ (êµ¬ë…ì˜ í”„ë¡œëª¨ì…˜ ì •ë³´ ìš°ì„ )
          let promotionInfo = '-';
          if (user.subscription?.promotion_id) {
            // êµ¬ë…ì— í”„ë¡œëª¨ì…˜ì´ ì—°ê²°ëœ ê²½ìš°
            const expiresAt = user.subscription.promotion_expires_at 
              ? new Date(user.subscription.promotion_expires_at).toLocaleDateString('ko-KR')
              : 'ë¬´ê¸°í•œ';
            promotionInfo = 'í”„ë¡œëª¨ì…˜ ì ìš©ì¤‘ (~ ' + expiresAt + ')';
          } else if (user.active_promotions && user.active_promotions.length > 0) {
            // í™œì„± í”„ë¡œëª¨ì…˜ ëª©ë¡ í‘œì‹œ
            promotionInfo = user.active_promotions.map(p => {
              if (p.promotion_type === 'discount') {
                return p.discount_rate + '% í• ì¸';
              } else if (p.promotion_type === 'free') {
                return p.free_months + 'ê°œì›” ë¬´ë£Œ';
              }
              return p.promotion_type;
            }).join(', ');
          }
          
          const memoText = user.latest_memo || '-';
          const remarksText = user.latest_remarks || '-';
          
          return '<tr>'+
            '<td>' + rowNumber + '</td>'+
            '<td><a href="#" onclick="viewUserDetail(\'' + user.user_id + '\'); return false;" class="has-text-link">' + user.email + '</a></td>'+
            '<td>' + user.pharmacist_name + '</td>'+
            '<td>' + user.pharmacy_name + '</td>'+
            '<td>' + (user.pharmacist_phone || '-') + '</td>'+
            '<td>' + subscriptionTag + '</td>'+
            '<td>' + (user.subscription?.plan_name || '-') + '</td>'+
            '<td>' + currentPeriodStart + '</td>'+
            '<td>' + currentPeriodEnd + '</td>'+
            '<td>' + nextBillingDate + '</td>'+
            '<td style="font-size: 0.75rem;">' + promotionInfo + '</td>'+
            '<td style="font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 150px;" title="' + (user.latest_memo || 'ë©”ëª¨ ì—†ìŒ') + '">' + memoText + '</td>'+
            '<td style="font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 150px;" title="' + (user.latest_remarks || 'ë¹„ê³  ì—†ìŒ') + '">' + remarksText + '</td>'+
            '<td>' + accountTag + '</td>'+
          '</tr>';
        }).join('');
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
        renderPagination(data.page, data.totalPages);
        
      } catch (error) {
        console.error('íšŒì› ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
        document.getElementById('usersTableBody').innerHTML = 
          '<tr><td colspan="14" class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
      }
    }
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    function renderPagination(currentPage, totalPages) {
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      const pageNumbers = document.getElementById('pageNumbers');
      
      // ì´ì „/ë‹¤ìŒ ë²„íŠ¼
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
      
      prevBtn.onclick = () => currentPage > 1 && fetchUsers(currentPage - 1);
      nextBtn.onclick = () => currentPage < totalPages && fetchUsers(currentPage + 1);
      
      // í˜ì´ì§€ ë²ˆí˜¸
      let pages = [];
      const maxPages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
      let endPage = Math.min(totalPages, startPage + maxPages - 1);
      
      if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        pages.push(
          '<li>' +
            '<a class="pagination-link ' + (i === currentPage ? 'is-current' : '') + '" ' +
               'onclick="fetchUsers(' + i + ')">' + i + '</a>' +
          '</li>'
        );
      }
      
      pageNumbers.innerHTML = pages.join('');
    }
    
    // íšŒì› ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    let currentUserDetail = null;
    let currentActiveTab = 'basic'; // í˜„ì¬ í™œì„±í™”ëœ íƒ­ ì¶”ì 
    
    // íƒ­ ì „í™˜
    function switchTab(tabName) {
      currentActiveTab = tabName; // í˜„ì¬ íƒ­ ì €ì¥
      
      // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
      document.querySelectorAll('.tabs li').forEach(li => li.classList.remove('is-active'));
      document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
      
      // ì„ íƒí•œ íƒ­ í™œì„±í™”
      document.querySelector('.tabs li[data-tab="' + tabName + '"]').classList.add('is-active');
      document.getElementById('tab-' + tabName).style.display = 'block';
    }
    
    // íšŒì› ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ì—´ê¸°
    async function viewUserDetail(userId) {
      try {
        const response = await fetch('/admin/api/users/' + userId, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) throw new Error('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        
        const data = await response.json();
        currentUserDetail = data;
        
        // ëª¨ë‹¬ ì œëª©
        document.getElementById('modalUserName').textContent = data.user.pharmacist_name + ' (' + data.user.email + ')';
        
        // ê¸°ë³¸ ì •ë³´ íƒ­
        document.getElementById('detailPharmacyName').value = data.user.pharmacy_name;
        document.getElementById('detailCreatedAt').value = new Date(data.user.created_at).toLocaleString('ko-KR');
        
        // ì£¼ì†Œ ì¡°í•©
        const fullAddress = [
          data.user.postcode ? '[' + data.user.postcode + ']' : '',
          data.user.address || '',
          data.user.detail_address || ''
        ].filter(Boolean).join(' ');
        document.getElementById('detailAddress').value = fullAddress || '-';
        
        const accountStatusEl = document.getElementById('detailAccountStatus');
        if (data.user.is_deleted) {
          accountStatusEl.textContent = 'íƒˆí‡´';
          accountStatusEl.className = 'tag is-danger is-medium';
        } else if (data.user.is_active) {
          accountStatusEl.textContent = 'í™œì„±';
          accountStatusEl.className = 'tag is-success is-medium';
        } else {
          accountStatusEl.textContent = 'ë¹„í™œì„±';
          accountStatusEl.className = 'tag is-warning is-medium';
        }
        
        // ë©”ëª¨ ë°ì´í„° êµ¬ì¡° ë””ë²„ê¹…
        console.log('=== ë©”ëª¨ ë°ì´í„° í™•ì¸ ===');
        console.log('memos ë°°ì—´:', data.memos);
        if (data.memos && data.memos.length > 0) {
          console.log('ì²« ë²ˆì§¸ ë©”ëª¨:', data.memos[0]);
          console.log('ì²« ë²ˆì§¸ ë©”ëª¨ admins ê°ì²´:', data.memos[0].admins);
        }
        
        // ë©”ëª¨ ë‚´ì—­ ë Œë”ë§ (ê¸°ë³¸ ì •ë³´ íƒ­ì— í‘œì‹œ)
        renderMemos(data.memos);
        
        // êµ¬ë… ë‚´ì—­ íƒ­
        renderSubscriptions(data.subscriptions);
        
        // ê²°ì œ ë‚´ì—­ íƒ­
        renderPayments(data.payments);
        
        // í”„ë¡œëª¨ì…˜ íƒ­
        renderPromotions(data.promotions);
        
        // í™œë™ ë¡œê·¸ íƒ­
        renderActivityLogs(data.activity_logs);
        
        // ëª¨ë‹¬ í‘œì‹œ ë° ì´ì „ í™œì„± íƒ­ ë³µì›
        document.getElementById('userDetailModal').classList.add('is-active');
        
        // í˜„ì¬ í™œì„±í™”ëœ íƒ­ìœ¼ë¡œ ì „í™˜ (ê¸°ë³¸ê°’: basic)
        if (currentActiveTab && currentActiveTab !== 'basic') {
          switchTab(currentActiveTab);
        }
        
      } catch (error) {
        console.error('íšŒì› ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
        alert('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // ëª¨ë‹¬ ë‹«ê¸°
    function closeUserDetailModal() {
      document.getElementById('userDetailModal').classList.remove('is-active');
      currentUserDetail = null;
      currentActiveTab = 'basic'; // íƒ­ ìƒíƒœ ì´ˆê¸°í™”
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById('newMemoText').value = '';
      document.getElementById('newRemarksText').value = '';
      
      // ê¸°ë³¸ íƒ­ìœ¼ë¡œ ì „í™˜
      switchTab('basic');
    }
    
    // êµ¬ë… ë‚´ì—­ ë Œë”ë§
    function renderSubscriptions(subscriptions) {
      const container = document.getElementById('subscriptionList');
      
      if (!subscriptions || subscriptions.length === 0) {
        container.innerHTML = '<p class="has-text-centered has-text-grey">êµ¬ë… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      
      container.innerHTML = subscriptions.map((sub, index) => {
        const statusClass = sub.status === 'active' ? 'is-success' : 
                           sub.status === 'cancelled' ? 'is-warning' : 'is-light';
        const statusText = sub.status === 'active' ? 'í™œì„±' : 
                          sub.status === 'cancelled' ? 'ì·¨ì†Œë¨' : sub.status;
        
        return '<div class="box">' +
          '<div class="level">' +
            '<div class="level-left">' +
              '<div class="level-item">' +
                '<div>' +
                  '<p class="heading">í”Œëœ</p>' +
                  '<p class="title is-5">' + (sub.subscription_plans?.plan_name || 'N/A') + '</p>' +
                '</div>' +
              '</div>' +
              '<div class="level-item">' +
                '<div>' +
                  '<p class="heading">ê²°ì œ ì£¼ê¸°</p>' +
                  '<p class="subtitle">' + (sub.subscription_plans?.billing_period || 'N/A') + '</p>' +
                '</div>' +
              '</div>' +
              '<div class="level-item">' +
                '<div>' +
                  '<p class="heading">ê°€ê²©</p>' +
                  '<p class="subtitle">' + (sub.subscription_plans?.price ? sub.subscription_plans.price.toLocaleString() + 'ì›' : 'N/A') + '</p>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="level-right">' +
              '<div class="level-item">' +
                '<span class="tag ' + statusClass + ' is-medium">' + statusText + '</span>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="columns is-mobile">' +
            '<div class="column">' +
              '<p class="heading">êµ¬ë… ì‹œì‘</p>' +
              '<p>' + (sub.current_period_start ? new Date(sub.current_period_start).toLocaleDateString('ko-KR') : '-') + '</p>' +
            '</div>' +
            '<div class="column">' +
              '<p class="heading">êµ¬ë… ì¢…ë£Œ</p>' +
              '<p>' + (sub.current_period_end ? new Date(sub.current_period_end).toLocaleDateString('ko-KR') : '-') + '</p>' +
            '</div>' +
            '<div class="column">' +
              '<p class="heading">ë‹¤ìŒ ê²°ì œì¼</p>' +
              '<p>' + (sub.next_billing_at ? new Date(sub.next_billing_at).toLocaleDateString('ko-KR') : '-') + '</p>' +
            '</div>' +
            '<div class="column">' +
              '<p class="heading">ìƒì„±ì¼</p>' +
              '<p>' + new Date(sub.created_at).toLocaleDateString('ko-KR') + '</p>' +
            '</div>' +
          '</div>' +
          (sub.cancelled_at ? '<p class="has-text-danger"><i class="fas fa-exclamation-triangle"></i> ì·¨ì†Œì¼: ' + new Date(sub.cancelled_at).toLocaleString('ko-KR') + '</p>' : '') +
        '</div>';
      }).join('');
    }
    
    // ê²°ì œ ë‚´ì—­ ë Œë”ë§
    function renderPayments(payments) {
      const tbody = document.getElementById('paymentList');
      
      if (!payments || payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="has-text-centered has-text-grey">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      tbody.innerHTML = payments.map(payment => {
        const statusClass = payment.status === 'success' ? 'is-success' : 
                           payment.status === 'failed' ? 'is-danger' : 'is-warning';
        const statusText = payment.status === 'success' ? 'ì„±ê³µ' : 
                          payment.status === 'failed' ? 'ì‹¤íŒ¨' : payment.status;
        
        return '<tr>' +
          '<td>' + new Date(payment.payment_date).toLocaleString('ko-KR') + '</td>' +
          '<td><strong>' + payment.amount.toLocaleString() + 'ì›</strong></td>' +
          '<td>' + (payment.payment_method || '-') + '</td>' +
          '<td><span class="tag ' + statusClass + '">' + statusText + '</span></td>' +
          '<td style="font-size: 0.75rem;">' + (payment.toss_order_id || '-') + '</td>' +
          '<td style="font-size: 0.75rem; color: #f14668;">' + (payment.failure_message || '-') + '</td>' +
        '</tr>';
      }).join('');
    }
    
    // í”„ë¡œëª¨ì…˜ ë Œë”ë§
    function renderPromotions(promotions) {
      const tbody = document.getElementById('promotionList');
      
      if (!promotions || promotions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="has-text-centered has-text-grey">í”„ë¡œëª¨ì…˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      tbody.innerHTML = promotions.map(promo => {
        const typeText = promo.promotion_type === 'discount' ? 'í• ì¸' : 
                        promo.promotion_type === 'free' ? 'ë¬´ë£Œ' : promo.promotion_type;
        const statusClass = promo.is_active ? 'is-success' : 'is-light';
        const statusText = promo.is_active ? 'í™œì„±' : 'ë§Œë£Œ';
        
        return '<tr>' +
          '<td>' + typeText + '</td>' +
          '<td>' + (promo.discount_rate ? promo.discount_rate + '%' : '-') + '</td>' +
          '<td>' + (promo.free_months ? promo.free_months + 'ê°œì›”' : '-') + '</td>' +
          '<td>' + (promo.start_date ? new Date(promo.start_date).toLocaleDateString('ko-KR') : '-') + '</td>' +
          '<td>' + (promo.expires_at ? new Date(promo.expires_at).toLocaleDateString('ko-KR') : '-') + '</td>' +
          '<td><span class="tag ' + statusClass + '">' + statusText + '</span></td>' +
        '</tr>';
      }).join('');
    }
    
    // ë©”ëª¨/ë¹„ê³  ë Œë”ë§
    function renderMemos(memos) {
      const container = document.getElementById('memoList');
      
      if (!memos || memos.length === 0) {
        container.innerHTML = '<p class="has-text-centered has-text-grey">ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      
      container.innerHTML = '<div class="table-container"><table class="table is-fullwidth is-striped is-hoverable">' +
        '<thead>' +
          '<tr>' +
            '<th>ì‘ì„±ì</th>' +
            '<th>ì‘ì„±ì¼</th>' +
            '<th>ë¹„ê³ </th>' +
            '<th>ë©”ëª¨</th>' +
          '</tr>' +
        '</thead>' +
        '<tbody>' +
          memos.map(memo => {
            const adminEmail = memo.admin_email || 'ì•Œ ìˆ˜ ì—†ìŒ';
            const remarksText = memo.remarks && memo.remarks.trim() ? memo.remarks : '<span class="has-text-grey-light">(ë¹ˆì¹¸)</span>';
            const memoText = memo.memo && memo.memo.trim() ? memo.memo : '<span class="has-text-grey-light">(ë¹ˆì¹¸)</span>';
            
            return '<tr>' +
              '<td>' + adminEmail + '</td>' +
              '<td>' + new Date(memo.created_at).toLocaleString('ko-KR') + '</td>' +
              '<td>' + remarksText + '</td>' +
              '<td>' + memoText + '</td>' +
            '</tr>';
          }).join('') +
        '</tbody>' +
      '</table></div>';
    }
    
    // í™œë™ ë¡œê·¸ ë Œë”ë§
    function renderActivityLogs(logs) {
      const tbody = document.getElementById('activityList');
      
      if (!logs || logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="has-text-centered has-text-grey">í™œë™ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      tbody.innerHTML = logs.map(log => {
        const adminName = log.admins?.admin_name || 'ì‹œìŠ¤í…œ';
        const detailsText = log.details ? JSON.stringify(log.details) : '-';
        
        return '<tr>' +
          '<td>' + new Date(log.created_at).toLocaleString('ko-KR') + '</td>' +
          '<td>' + log.action_type + '</td>' +
          '<td>' + adminName + '</td>' +
          '<td style="font-size: 0.75rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis;" title="' + detailsText + '">' + detailsText + '</td>' +
        '</tr>';
      }).join('');
    }
    
    // ìƒˆ ë©”ëª¨ ì €ì¥
    async function saveNewMemo() {
      if (!currentUserDetail) return;
      
      const memoText = document.getElementById('newMemoText').value.trim();
      const remarksText = document.getElementById('newRemarksText').value.trim();
      
      if (!memoText && !remarksText) {
        alert('ë©”ëª¨ ë˜ëŠ” ë¹„ê³ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const response = await fetch('/admin/api/users/' + currentUserDetail.user.user_id + '/memos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          },
          body: JSON.stringify({
            memo: memoText,
            remarks: remarksText
          })
        });
        
        if (!response.ok) throw new Error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨');
        
        alert('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('newMemoText').value = '';
        document.getElementById('newRemarksText').value = '';
        
        // ìƒì„¸ ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
        viewUserDetail(currentUserDetail.user.user_id);
        
      } catch (error) {
        console.error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨:', error);
        alert('ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // íšŒì› ë¹„ê³  ì—…ë°ì´íŠ¸ (admin_user_memos.remarks ì‚¬ìš©) - íšŒì› ëª©ë¡ì—ì„œëŠ” ë” ì´ìƒ ì‚¬ìš© ì•ˆ í•¨
    // ìƒì„¸ í˜ì´ì§€ì—ì„œ ë©”ëª¨/ë¹„ê³  ì‘ì„± ì‚¬ìš©
    async function updateUserRemarks(userId, remarksText) {
      try {
        const response = await fetch('/admin/api/users/' + userId + '/memos', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token'),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ remarks: remarksText })
        });
        
        if (!response.ok) {
          throw new Error('ë¹„ê³  ì €ì¥ ì‹¤íŒ¨');
        }
        
        const result = await response.json();
        console.log('ë¹„ê³ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤:', result);
      } catch (error) {
        console.error('ë¹„ê³  ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ë¹„ê³  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë¡œê·¸ì•„ì›ƒ
    async function logout() {
      if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      // ë¡œë”© í‘œì‹œ
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë¡œê·¸ì•„ì›ƒ ì¤‘...';
        logoutBtn.style.pointerEvents = 'none';
      }
      
      try {
        // ë¡œê·¸ì•„ì›ƒ í™œë™ ë¡œê·¸ ê¸°ë¡
        await fetch('/admin/api/logout', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('admin_session_token')}`,
            'Content-Type': 'application/json'
          }
        });
      } catch (error) {
        console.error('ë¡œê·¸ì•„ì›ƒ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:', error);
      }
      
      // í† í° ì‚­ì œ (localStorage)
      localStorage.removeItem('admin_session_token');
      
      // í† í° ì‚­ì œ (ì¿ í‚¤ - ëª¨ë“  ê²½ë¡œì™€ ë„ë©”ì¸ ì¡°í•©)
      const cookiesToDelete = [
        'admin_session_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
        'admin_session_token=; path=/admin; expires=Thu, 01 Jan 1970 00:00:00 GMT',
        'admin_session_token=; domain=localhost; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
        'admin_session_token=; domain=.localhost; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
        'admin_session_token=; domain=' + window.location.hostname + '; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
      ];
      
      cookiesToDelete.forEach(cookie => {
        document.cookie = cookie;
      });
      
      // ì™„ì „íˆ ì‚­ì œë˜ì—ˆëŠ”ì§€ í™•ì¸
      console.log('ë¡œê·¸ì•„ì›ƒ í›„ ì¿ í‚¤:', document.cookie);
      
      // /adminìœ¼ë¡œ ì´ë™ (ë¡œê·¸ì¸ í˜ì´ì§€ ìë™ ë¡œë“œ)
      window.location.href = '/admin';
    }

    // ì´ˆê¸°í™” - ì¦‰ì‹œ ì‹¤í–‰
    console.log('ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì‹œì‘');
    
    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    window.addEventListener('load', function() {
      console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        console.log('ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë°œê²¬, ì´ë²¤íŠ¸ ë°”ì¸ë”©');
        logoutBtn.addEventListener('click', logout);
      } else {
        console.error('ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      }
    });
    
    // ì¸ì¦ ì²´í¬ ë° ë°ì´í„° ë¡œë“œ - ì¦‰ì‹œ ì‹¤í–‰
    console.log('checkAuth í˜¸ì¶œ');
    checkAuth();
    console.log('loadDashboardStats í˜¸ì¶œ');
    loadDashboardStats();
    console.log('loadRecentActivities í˜¸ì¶œ');
    loadRecentActivities();

    // ==================== êµ¬ë… í˜„í™© í˜ì´ì§€ ====================
    async function loadSubscriptionsPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = '<h1 class="title">êµ¬ë… í˜„í™©</h1>' +
        '<div class="box">' +
          '<div class="columns is-multiline">' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì•½êµ­ëª…</label>' +
                '<div class="control">' +
                  '<input class="input" type="text" id="subscriptionPharmacyName" placeholder="ì•½êµ­ëª…">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì•½ì‚¬ëª…</label>' +
                '<div class="control">' +
                  '<input class="input" type="text" id="subscriptionPharmacistName" placeholder="ì•½ì‚¬ëª…">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì‹œì‘ì¼</label>' +
                '<div class="control">' +
                  '<input class="input" type="date" id="subscriptionStartDate">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì¢…ë£Œì¼</label>' +
                '<div class="control">' +
                  '<input class="input" type="date" id="subscriptionEndDate">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">êµ¬ë… ìƒíƒœ</label>' +
                '<div class="control">' +
                  '<div class="select is-fullwidth">' +
                    '<select id="subscriptionStatusFilter">' +
                      '<option value="">ì „ì²´</option>' +
                      '<option value="active">í™œì„±</option>' +
                      '<option value="cancelled">ì·¨ì†Œë¨</option>' +
                      '<option value="expired">ë§Œë£Œë¨</option>' +
                    '</select>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-1">' +
              '<div class="field">' +
                '<label class="label">&nbsp;</label>' +
                '<div class="control">' +
                  '<button class="button is-primary is-fullwidth" onclick="searchSubscriptions()">' +
                    '<i class="fas fa-search"></i>' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-1">' +
              '<div class="field">' +
                '<label class="label">&nbsp;</label>' +
                '<div class="control">' +
                  '<button class="button is-light is-fullwidth" onclick="clearSubscriptionFilters()">' +
                    '<i class="fas fa-redo"></i>' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="box">' +
          '<div class="table-container">' +
            '<table class="table is-fullwidth is-striped is-hoverable">' +
              '<thead>' +
                '<tr>' +
                  '<th style="width: 60px;">No.</th>' +
                  '<th>ì•½êµ­ëª…</th>' +
                  '<th>ì•½ì‚¬ëª…</th>' +
                  '<th>ì´ë©”ì¼</th>' +
                  '<th>í”Œëœ</th>' +
                  '<th>ê²°ì œ ì£¼ê¸°</th>' +
                  '<th>ìƒíƒœ</th>' +
                  '<th>ì²« ê²°ì œì¼</th>' +
                  '<th>ì‹œì‘ì¼</th>' +
                  '<th>ì¢…ë£Œì¼</th>' +
                  '<th>ë‹¤ìŒ ê²°ì œì¼</th>' +
                  '<th>ê¸ˆì•¡</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody id="subscriptionTableBody">' +
                '<tr>' +
                  '<td colspan="12" class="has-text-centered">' +
                    '<i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...' +
                  '</td>' +
                '</tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
          '<nav class="pagination is-centered" role="navigation" id="subscriptionPagination">' +
          '</nav>' +
        '</div>';
      
      // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
      searchSubscriptions();
    }

    let currentSubscriptionPage = 1;
    const subscriptionPageSize = 20;

    async function searchSubscriptions(page = 1) {
      currentSubscriptionPage = page;
      
      const startDate = document.getElementById('subscriptionStartDate')?.value || '';
      const endDate = document.getElementById('subscriptionEndDate')?.value || '';
      const status = document.getElementById('subscriptionStatusFilter')?.value || '';
      const pharmacyName = document.getElementById('subscriptionPharmacyName')?.value || '';
      const pharmacistName = document.getElementById('subscriptionPharmacistName')?.value || '';
      
      const tbody = document.getElementById('subscriptionTableBody');
      tbody.innerHTML = '<tr><td colspan="12" class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</td></tr>';
      
      try {
        const params = new URLSearchParams({
          page: page,
          limit: subscriptionPageSize,
          startDate: startDate,
          endDate: endDate,
          status: status,
          pharmacyName: pharmacyName,
          pharmacistName: pharmacistName
        });
        
        const response = await fetch('/admin/api/subscriptions?' + params.toString(), {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/admin/login';
            return;
          }
          throw new Error('êµ¬ë… ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        renderSubscriptions(data);
      } catch (error) {
        console.error('êµ¬ë… ì¡°íšŒ ì˜¤ë¥˜:', error);
        tbody.innerHTML = '<tr><td colspan="12" class="has-text-centered has-text-danger">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    function renderSubscriptions(data) {
      const tbody = document.getElementById('subscriptionTableBody');
      
      if (!data.subscriptions || data.subscriptions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="has-text-centered">êµ¬ë… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      // ì¸ë±ìŠ¤ ê³„ì‚° (ìµœê·¼ì´ 1ë²ˆ)
      const startIndex = (currentSubscriptionPage - 1) * subscriptionPageSize;
      
      tbody.innerHTML = data.subscriptions.map((sub, idx) => {
        const index = startIndex + idx + 1;
        
        // ìƒíƒœ í‘œì‹œ ë¡œì§
        let statusTag, statusText;
        if (sub.cancel_at_period_end) {
          // í•´ì§€ ì˜ˆì•½ëœ ê²½ìš°
          statusTag = 'is-warning';
          statusText = 'í•´ì§€ ì˜ˆì•½ë¨';
        } else if (sub.status === 'active') {
          statusTag = 'is-success';
          statusText = 'í™œì„±';
        } else if (sub.status === 'cancelled') {
          statusTag = 'is-danger';
          statusText = 'ì·¨ì†Œë¨';
        } else {
          statusTag = 'is-danger';
          statusText = 'ë§Œë£Œë¨';
        }
        
        // ë‹¤ìŒ ê²°ì œì¼ í‘œì‹œ ë¡œì§
        let nextBillingText;
        if (sub.cancel_at_period_end) {
          // í•´ì§€ ì˜ˆì•½ëœ ê²½ìš°
          nextBillingText = '<span class="has-text-danger">í•´ì§€ ì˜ˆì • - ê²°ì œ ì•ˆ ë¨</span>';
        } else if (sub.status === 'cancelled') {
          // ì´ë¯¸ ì·¨ì†Œëœ ê²½ìš°
          nextBillingText = '<span class="has-text-grey">íƒˆí‡´ ì™„ë£Œ - ê²°ì œ ì•ˆ ë¨</span>';
        } else if (sub.next_billing_at) {
          // ì •ìƒ í™œì„± êµ¬ë…
          nextBillingText = new Date(sub.next_billing_at).toLocaleDateString('ko-KR');
        } else {
          nextBillingText = '-';
        }
        
        return '<tr>' +
          '<td>' + index + '</td>' +
          '<td>' + (sub.pharmacy_name || '-') + '</td>' +
          '<td>' + (sub.pharmacist_name || '-') + '</td>' +
          '<td>' + (sub.email || '-') + '</td>' +
          '<td>' + (sub.plan_name || '-') + '</td>' +
          '<td>ì›”ê°„</td>' +
          '<td><span class="tag ' + statusTag + '">' + statusText + '</span></td>' +
          '<td>' + (sub.created_at ? new Date(sub.created_at).toLocaleDateString('ko-KR') : '-') + '</td>' +
          '<td>' + (sub.current_period_start ? new Date(sub.current_period_start).toLocaleDateString('ko-KR') : '-') + '</td>' +
          '<td>' + (sub.current_period_end ? new Date(sub.current_period_end).toLocaleDateString('ko-KR') : '-') + '</td>' +
          '<td>' + nextBillingText + '</td>' +
          '<td>' + (sub.monthly_price ? sub.monthly_price.toLocaleString() + 'ì›' : '-') + '</td>' +
        '</tr>';
      }).join('');
      
      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      renderSubscriptionPagination(data.total, data.page, data.totalPages);
    }

    function renderSubscriptionPagination(total, currentPage, totalPages) {
      const pagination = document.getElementById('subscriptionPagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = '<a class="pagination-previous" ' + (currentPage === 1 ? 'disabled' : 'onclick="searchSubscriptions(' + (currentPage - 1) + ')"') + '>ì´ì „</a>';
      html += '<a class="pagination-next" ' + (currentPage === totalPages ? 'disabled' : 'onclick="searchSubscriptions(' + (currentPage + 1) + ')"') + '>ë‹¤ìŒ</a>';
      html += '<ul class="pagination-list">';
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += '<li><a class="pagination-link ' + (i === currentPage ? 'is-current' : '') + '" onclick="searchSubscriptions(' + i + ')">' + i + '</a></li>';
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<li><span class="pagination-ellipsis">&hellip;</span></li>';
        }
      }
      
      html += '</ul>';
      pagination.innerHTML = html;
    }

    function clearSubscriptionFilters() {
      document.getElementById('subscriptionStartDate').value = '';
      document.getElementById('subscriptionEndDate').value = '';
      document.getElementById('subscriptionStatusFilter').value = '';
      document.getElementById('subscriptionPharmacyName').value = '';
      document.getElementById('subscriptionPharmacistName').value = '';
      searchSubscriptions(1);
    }

    // ==================== ê²°ì œ ë‚´ì—­ í˜ì´ì§€ ====================
    async function loadPaymentsPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = '<h1 class="title">ê²°ì œ ë‚´ì—­</h1>' +
        '<div class="box">' +
          '<div class="columns is-multiline">' +
            '<div class="column is-3">' +
              '<div class="field">' +
                '<label class="label">ì•½êµ­ëª…</label>' +
                '<div class="control">' +
                  '<input class="input" type="text" id="paymentPharmacyName" placeholder="ì•½êµ­ëª… ê²€ìƒ‰">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-3">' +
              '<div class="field">' +
                '<label class="label">ì•½ì‚¬ëª…</label>' +
                '<div class="control">' +
                  '<input class="input" type="text" id="paymentPharmacistName" placeholder="ì•½ì‚¬ëª… ê²€ìƒ‰">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ê²°ì œ ìƒíƒœ</label>' +
                '<div class="control">' +
                  '<div class="select is-fullwidth">' +
                    '<select id="paymentStatusFilter">' +
                      '<option value="">ì „ì²´</option>' +
                      '<option value="success">ì„±ê³µ</option>' +
                      '<option value="failed">ì‹¤íŒ¨</option>' +
                      '<option value="canceled">ì·¨ì†Œ</option>' +
                    '</select>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì‹œì‘ì¼</label>' +
                '<div class="control">' +
                  '<input class="input" type="date" id="paymentStartDate">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì¢…ë£Œì¼</label>' +
                '<div class="control">' +
                  '<input class="input" type="date" id="paymentEndDate">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2 is-offset-8">' +
              '<div class="field">' +
                '<div class="control">' +
                  '<button class="button is-primary is-fullwidth" onclick="searchPayments()">' +
                    '<i class="fas fa-search"></i>&nbsp; ê²€ìƒ‰' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<div class="control">' +
                  '<button class="button is-light is-fullwidth" onclick="clearPaymentFilters()">' +
                    '<i class="fas fa-redo"></i>&nbsp; ì´ˆê¸°í™”' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="box">' +
          '<div class="table-container">' +
            '<table class="table is-fullwidth is-striped is-hoverable">' +
              '<thead>' +
                '<tr>' +
                  '<th style="width: 60px;">No.</th>' +
                  '<th>ì•½êµ­ëª…</th>' +
                  '<th>ì•½ì‚¬ëª…</th>' +
                  '<th>ì´ë©”ì¼</th>' +
                  '<th>ì£¼ë¬¸ë²ˆí˜¸</th>' +
                  '<th>ê²°ì œê¸ˆì•¡</th>' +
                  '<th>ê²°ì œìƒíƒœ</th>' +
                  '<th>ìš”ì²­ì¼ì‹œ</th>' +
                  '<th>ìŠ¹ì¸ì¼ì‹œ</th>' +
                  '<th>ì‹¤íŒ¨ì‚¬ìœ </th>' +
                '</tr>' +
              '</thead>' +
              '<tbody id="paymentTableBody">' +
                '<tr>' +
                  '<td colspan="10" class="has-text-centered">' +
                    '<i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...' +
                  '</td>' +
                '</tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
          '<nav class="pagination is-centered" role="navigation" id="paymentPagination">' +
          '</nav>' +
        '</div>';
      
      // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
      searchPayments();
    }

    let currentPaymentPage = 1;
    const paymentPageSize = 20;

    async function searchPayments(page = 1) {
      currentPaymentPage = page;
      
      const startDate = document.getElementById('paymentStartDate')?.value || '';
      const endDate = document.getElementById('paymentEndDate')?.value || '';
      const status = document.getElementById('paymentStatusFilter')?.value || '';
      const pharmacyName = document.getElementById('paymentPharmacyName')?.value?.trim() || '';
      const pharmacistName = document.getElementById('paymentPharmacistName')?.value?.trim() || '';
      
      const tbody = document.getElementById('paymentTableBody');
      tbody.innerHTML = '<tr><td colspan="10" class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</td></tr>';
      
      try {
        const params = new URLSearchParams({
          page: page,
          limit: paymentPageSize,
          startDate: startDate,
          endDate: endDate,
          status: status,
          pharmacyName: pharmacyName,
          pharmacistName: pharmacistName
        });
        
        const response = await fetch('/admin/api/payments?' + params.toString(), {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/admin/login';
            return;
          }
          throw new Error('ê²°ì œ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        renderPayments(data);
      } catch (error) {
        console.error('ê²°ì œ ë‚´ì—­ ì¡°íšŒ ì˜¤ë¥˜:', error);
        tbody.innerHTML = '<tr><td colspan="10" class="has-text-centered has-text-danger">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    function renderPayments(data) {
      const tbody = document.getElementById('paymentTableBody');
      
      console.log('ê²°ì œ ë‚´ì—­ ë°ì´í„°:', data);
      console.log('ì²« ë²ˆì§¸ ê²°ì œ:', data.payments?.[0]);
      
      if (!data.payments || data.payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="has-text-centered">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      // ì¸ë±ìŠ¤ ê³„ì‚° (ìµœê·¼ì´ 1ë²ˆ)
      const startIndex = (currentPaymentPage - 1) * paymentPageSize;
      
      tbody.innerHTML = data.payments.map((payment, idx) => {
        const index = startIndex + idx + 1;
        
        // amountê°€ null/undefinedì¸ ê²½ìš°ë§Œ ë””ë²„ê¹… ë¡œê·¸ (0ì›ì€ ë¬´ë£Œ í”„ë¡œëª¨ì…˜ì´ë¯€ë¡œ ì •ìƒ)
        if ((payment.amount === null || payment.amount === undefined) && payment.status === 'success') {
          console.warn('ê¸ˆì•¡ ëˆ„ë½ ê²°ì œ ë°œê²¬:', {
            payment_id: payment.payment_id,
            order_id: payment.order_id,
            amount: payment.amount,
            status: payment.status,
            pharmacy_name: payment.pharmacy_name,
            email: payment.email
          });
        }
        
        // ê²°ì œ ìƒíƒœ í‘œì‹œ
        let statusTag, statusText;
        if (payment.status === 'success') {
          statusTag = 'is-success';
          statusText = 'ì„±ê³µ';
        } else if (payment.status === 'failed') {
          statusTag = 'is-danger';
          statusText = 'ì‹¤íŒ¨';
        } else if (payment.status === 'canceled') {
          statusTag = 'is-warning';
          statusText = 'ì·¨ì†Œ';
        } else {
          statusTag = 'is-light';
          statusText = payment.status || '-';
        }
        
        // ê¸ˆì•¡ í‘œì‹œ (0ì›ì€ "0ì› (ë¬´ë£Œ)" í‘œì‹œ)
        let amountDisplay = '-';
        if (payment.amount !== null && payment.amount !== undefined) {
          if (payment.amount === 0) {
            amountDisplay = '0ì› (ë¬´ë£Œ)';
          } else {
            amountDisplay = payment.amount.toLocaleString() + 'ì›';
          }
        }
        
        return '<tr>' +
          '<td>' + index + '</td>' +
          '<td>' + (payment.pharmacy_name || '-') + '</td>' +
          '<td>' + (payment.pharmacist_name || '-') + '</td>' +
          '<td>' + (payment.email || '-') + '</td>' +
          '<td>' + (payment.order_id || '-') + '</td>' +
          '<td>' + amountDisplay + '</td>' +
          '<td><span class="tag ' + statusTag + '">' + statusText + '</span></td>' +
          '<td>' + (payment.requested_at ? new Date(payment.requested_at).toLocaleString('ko-KR') : '-') + '</td>' +
          '<td>' + (payment.approved_at ? new Date(payment.approved_at).toLocaleString('ko-KR') : '-') + '</td>' +
          '<td>' + (payment.fail_reason || '-') + '</td>' +
        '</tr>';
      }).join('');
      
      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      renderPaymentPagination(data.total, data.page, data.totalPages);
    }

    function renderPaymentPagination(total, currentPage, totalPages) {
      const pagination = document.getElementById('paymentPagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = '<a class="pagination-previous" ' + (currentPage === 1 ? 'disabled' : 'onclick="searchPayments(' + (currentPage - 1) + ')"') + '>ì´ì „</a>';
      html += '<a class="pagination-next" ' + (currentPage === totalPages ? 'disabled' : 'onclick="searchPayments(' + (currentPage + 1) + ')"') + '>ë‹¤ìŒ</a>';
      html += '<ul class="pagination-list">';
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += '<li><a class="pagination-link ' + (i === currentPage ? 'is-current' : '') + '" onclick="searchPayments(' + i + ')">' + i + '</a></li>';
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<li><span class="pagination-ellipsis">&hellip;</span></li>';
        }
      }
      
      html += '</ul>';
      pagination.innerHTML = html;
    }

    function clearPaymentFilters() {
      document.getElementById('paymentStartDate').value = '';
      document.getElementById('paymentEndDate').value = '';
      document.getElementById('paymentStatusFilter').value = '';
      document.getElementById('paymentPharmacyName').value = '';
      document.getElementById('paymentPharmacistName').value = '';
      searchPayments(1);
    }

    // ==================== ë¬¸ì˜ ê´€ë¦¬ í˜ì´ì§€ ====================
    async function loadSupportTicketsPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = '<h1 class="title">ë¬¸ì˜ ê´€ë¦¬</h1>' +
        '<div class="box">' +
          '<div class="columns">' +
            '<div class="column is-3">' +
              '<div class="field">' +
                '<label class="label">ë‹µë³€ ìƒíƒœ</label>' +
                '<div class="control">' +
                  '<div class="select is-fullwidth">' +
                    '<select id="ticketStatusFilter">' +
                      '<option value="">ì „ì²´</option>' +
                      '<option value="open">ë¯¸ë‹µë³€</option>' +
                      '<option value="answered">ë‹µë³€ì™„ë£Œ</option>' +
                      '<option value="closed">ì¢…ë£Œ</option>' +
                    '</select>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">&nbsp;</label>' +
                '<div class="control">' +
                  '<button class="button is-primary is-fullwidth" onclick="searchTickets()">' +
                    '<i class="fas fa-search"></i>&nbsp; ê²€ìƒ‰' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">&nbsp;</label>' +
                '<div class="control">' +
                  '<button class="button is-light is-fullwidth" onclick="clearTicketFilters()">' +
                    '<i class="fas fa-redo"></i>&nbsp; ì´ˆê¸°í™”' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="box">' +
          '<div class="table-container">' +
            '<table class="table is-fullwidth is-striped is-hoverable">' +
              '<thead>' +
                '<tr>' +
                  '<th style="width: 60px;">No.</th>' +
                  '<th>ì œëª©</th>' +
                  '<th>ì•½êµ­ëª…</th>' +
                  '<th>ì•½ì‚¬ëª…</th>' +
                  '<th>ì´ë©”ì¼</th>' +
                  '<th>ë‹µë³€ ìƒíƒœ</th>' +
                  '<th>ìƒì„±ì¼ì‹œ</th>' +
                  '<th>ìƒì„¸ë³´ê¸°</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody id="ticketTableBody">' +
                '<tr>' +
                  '<td colspan="8" class="has-text-centered">' +
                    '<i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...' +
                  '</td>' +
                '</tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
          '<nav class="pagination is-centered" role="navigation" id="ticketPagination">' +
          '</nav>' +
        '</div>' +
        '<div id="ticketDetailModal" class="modal">' +
          '<div class="modal-background" onclick="closeTicketDetail()"></div>' +
          '<div class="modal-card" style="width: 800px;">' +
            '<header class="modal-card-head">' +
              '<p class="modal-card-title">ë¬¸ì˜ ìƒì„¸</p>' +
              '<button class="delete" onclick="closeTicketDetail()"></button>' +
            '</header>' +
            '<section class="modal-card-body" id="ticketDetailContent">' +
              '<p class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</p>' +
            '</section>' +
          '</div>' +
        '</div>';
      
      // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
      searchTickets();
    }

    let currentTicketPage = 1;
    const ticketPageSize = 20;

    async function searchTickets(page = 1) {
      currentTicketPage = page;
      
      const status = document.getElementById('ticketStatusFilter')?.value || '';
      
      const tbody = document.getElementById('ticketTableBody');
      tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</td></tr>';
      
      try {
        const params = new URLSearchParams({
          page: page,
          limit: ticketPageSize,
          status: status
        });
        
        const response = await fetch('/admin/api/support-tickets?' + params.toString(), {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/admin/login';
            return;
          }
          throw new Error('ë¬¸ì˜ ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        renderTickets(data);
      } catch (error) {
        console.error('ë¬¸ì˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered has-text-danger">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    function renderTickets(data) {
      const tbody = document.getElementById('ticketTableBody');
      
      if (!data.tickets || data.tickets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered">ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      const startIndex = (currentTicketPage - 1) * ticketPageSize;
      
      tbody.innerHTML = data.tickets.map((ticket, idx) => {
        const index = startIndex + idx + 1;
        
        let statusTag, statusText;
        if (ticket.status === 'open') {
          statusTag = 'is-danger';
          statusText = 'ë¯¸ë‹µë³€';
        } else if (ticket.status === 'answered') {
          statusTag = 'is-success';
          statusText = 'ë‹µë³€ì™„ë£Œ';
        } else if (ticket.status === 'closed') {
          statusTag = 'is-light';
          statusText = 'ì¢…ë£Œ';
        } else {
          statusTag = 'is-light';
          statusText = ticket.status || '-';
        }
        
        return '<tr>' +
          '<td>' + index + '</td>' +
          '<td><a href="#" onclick="loadTicketDetailPage(\'' + ticket.ticket_id + '\'); return false;" style="color: #3273dc; text-decoration: underline;">' + (ticket.title || '-') + '</a></td>' +
          '<td>' + (ticket.pharmacy_name || '-') + '</td>' +
          '<td>' + (ticket.pharmacist_name || '-') + '</td>' +
          '<td>' + (ticket.email || '-') + '</td>' +
          '<td><span class="tag ' + statusTag + '">' + statusText + '</span></td>' +
          '<td>' + (ticket.created_at ? new Date(ticket.created_at).toLocaleString('ko-KR') : '-') + '</td>' +
          '<td><button class="button is-small is-info" onclick="loadTicketDetailPage(\'' + ticket.ticket_id + '\')">ìƒì„¸ë³´ê¸°</button></td>' +
        '</tr>';
      }).join('');
      
      renderTicketPagination(data.total, data.page, data.totalPages);
    }

    function renderTicketPagination(total, currentPage, totalPages) {
      const pagination = document.getElementById('ticketPagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = '<a class="pagination-previous" ' + (currentPage === 1 ? 'disabled' : 'onclick="searchTickets(' + (currentPage - 1) + ')"') + '>ì´ì „</a>';
      html += '<a class="pagination-next" ' + (currentPage === totalPages ? 'disabled' : 'onclick="searchTickets(' + (currentPage + 1) + ')"') + '>ë‹¤ìŒ</a>';
      html += '<ul class="pagination-list">';
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += '<li><a class="pagination-link ' + (i === currentPage ? 'is-current' : '') + '" onclick="searchTickets(' + i + ')">' + i + '</a></li>';
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<li><span class="pagination-ellipsis">&hellip;</span></li>';
        }
      }
      
      html += '</ul>';
      pagination.innerHTML = html;
    }

    function clearTicketFilters() {
      document.getElementById('ticketStatusFilter').value = '';
      searchTickets(1);
    }

    async function viewTicketDetail(ticketId) {
      const modal = document.getElementById('ticketDetailModal');
      const content = document.getElementById('ticketDetailContent');
      
      modal.classList.add('is-active');
      content.innerHTML = '<p class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</p>';
      
      try {
        const response = await fetch('/admin/api/support-tickets/' + ticketId, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          throw new Error('ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        const ticket = data.ticket;
        const attachments = data.attachments || [];
        
        let attachmentHTML = '';
        if (attachments.length > 0) {
          attachmentHTML = '<div class="field"><label class="label">ì²¨ë¶€íŒŒì¼</label><div class="content">';
          attachments.forEach(att => {
            attachmentHTML += '<p><a href="' + att.file_path + '" target="_blank"><i class="fas fa-paperclip"></i> ' + att.file_name + ' (' + (att.file_size / 1024).toFixed(2) + ' KB)</a></p>';
          });
          attachmentHTML += '</div></div>';
        }
        
        content.innerHTML = 
          '<div class="field"><label class="label">ì œëª©</label><p class="control"><input class="input" type="text" value="' + (ticket.title || '') + '" readonly></p></div>' +
          '<div class="field"><label class="label">ì‘ì„±ì</label><p>' + (ticket.pharmacist_name || '-') + ' (' + (ticket.pharmacy_name || '-') + ')</p></div>' +
          '<div class="field"><label class="label">ì´ë©”ì¼</label><p>' + (ticket.email || '-') + '</p></div>' +
          '<div class="field"><label class="label">ì‘ì„±ì¼ì‹œ</label><p>' + (ticket.created_at ? new Date(ticket.created_at).toLocaleString('ko-KR') : '-') + '</p></div>' +
          '<div class="field"><label class="label">ë‚´ìš©</label><div class="content" style="white-space: pre-wrap; border: 1px solid #dbdbdb; padding: 1rem; border-radius: 4px; background: #fafafa;">' + (ticket.content || '') + '</div></div>' +
          attachmentHTML +
          '<div class="field"><label class="label">ë‹µë³€ ìƒíƒœ</label><p><span class="tag ' + (ticket.status === 'open' ? 'is-danger' : ticket.status === 'answered' ? 'is-success' : 'is-light') + '">' + (ticket.status === 'open' ? 'ë¯¸ë‹µë³€' : ticket.status === 'answered' ? 'ë‹µë³€ì™„ë£Œ' : 'ì¢…ë£Œ') + '</span></p></div>';
        
      } catch (error) {
        console.error('ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
        content.innerHTML = '<p class="has-text-centered has-text-danger">ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    function closeTicketDetail() {
      document.getElementById('ticketDetailModal').classList.remove('is-active');
    }

    // ë¬¸ì˜ ìƒì„¸ í˜ì´ì§€ ë¡œë“œ (ë³„ë„ í˜ì´ì§€)
    async function loadTicketDetailPage(ticketId) {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = 
        '<div class="box">' +
          '<nav class="breadcrumb" aria-label="breadcrumbs">' +
            '<ul>' +
              '<li><a href="#" onclick="loadSupportTicketsPage(); return false;">ë¬¸ì˜ ê´€ë¦¬</a></li>' +
              '<li class="is-active"><a href="#" aria-current="page">ë¬¸ì˜ ìƒì„¸</a></li>' +
            '</ul>' +
          '</nav>' +
          '<h1 class="title is-4">ë¬¸ì˜ ìƒì„¸</h1>' +
          '<div id="ticketDetailPageContent">' +
            '<p class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</p>' +
          '</div>' +
        '</div>';
      
      try {
        const response = await fetch('/admin/api/support-tickets/' + ticketId, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          throw new Error('ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        console.log('ë¬¸ì˜ ìƒì„¸ ë°ì´í„°:', data);
        console.log('ì²¨ë¶€íŒŒì¼ ê°œìˆ˜:', data.attachments?.length || 0);
        console.log('ë‹µë³€ ê°œìˆ˜:', data.replies?.length || 0);
        
        const ticket = data.ticket;
        const attachments = data.attachments || [];
        const replies = data.replies || [];
        
        let attachmentHTML = '';
        if (attachments.length > 0) {
          attachmentHTML = '<div class="field"><label class="label">ì²¨ë¶€íŒŒì¼</label><div class="content">';
          attachments.forEach(att => {
            const isImage = att.mime_type && att.mime_type.startsWith('image/');
            const fileUrl = att.file_url || att.file_path;
            if (isImage) {
              attachmentHTML += '<div class="box" style="max-width: 500px;"><p><strong>' + att.file_name + '</strong></p><img src="' + fileUrl + '" alt="' + att.file_name + '" style="max-width: 100%; height: auto; border: 1px solid #dbdbdb; border-radius: 4px;"></div>';
            } else {
              attachmentHTML += '<p><a href="' + fileUrl + '" target="_blank"><i class="fas fa-paperclip"></i> ' + att.file_name + ' (' + (att.file_size ? (att.file_size / 1024).toFixed(2) + ' KB' : '-') + ')</a></p>';
            }
          });
          attachmentHTML += '</div></div>';
        }
        
        let repliesHTML = '';
        if (replies.length > 0) {
          repliesHTML = '<hr><div class="field"><label class="label">ë‹µë³€ ë‚´ì—­ (' + replies.length + 'ê±´)</label>';
          replies.forEach((reply, idx) => {
            let replyAttHTML = '';
            if (reply.attachments && reply.attachments.length > 0) {
              replyAttHTML += '<div class="content mt-2"><strong>ì²¨ë¶€íŒŒì¼:</strong><br>';
              reply.attachments.forEach(att => {
                const isImage = att.mime_type && att.mime_type.startsWith('image/');
                const fileUrl = att.file_url || att.file_path;
                if (isImage) {
                  replyAttHTML += '<div class="box" style="max-width: 400px; margin-top: 0.5rem;"><img src="' + fileUrl + '" alt="' + att.file_name + '" style="max-width: 100%; height: auto; border: 1px solid #dbdbdb; border-radius: 4px;"><p class="is-size-7 mt-1">' + att.file_name + '</p></div>';
                } else {
                  replyAttHTML += '<p><a href="' + fileUrl + '" target="_blank"><i class="fas fa-paperclip"></i> ' + att.file_name + '</a></p>';
                }
              });
              replyAttHTML += '</div>';
            }
            
            repliesHTML += '<div class="box" style="background: #f0f8ff; border-left: 4px solid #3273dc;">' +
              '<p class="is-size-7 has-text-grey mb-2">ë‹µë³€ #' + (idx + 1) + ' | ' + (reply.created_at ? new Date(reply.created_at).toLocaleString('ko-KR') : '-') + '</p>' +
              '<div class="content" style="white-space: pre-wrap;">' + (reply.reply_content || '') + '</div>' +
              replyAttHTML +
            '</div>';
          });
          repliesHTML += '</div>';
        }
        
        const content = document.getElementById('ticketDetailPageContent');
        content.innerHTML = 
          '<div class="columns">' +
            '<div class="column is-8">' +
              '<div class="field"><label class="label">ì œëª©</label><p class="control"><input class="input" type="text" value="' + (ticket.title || '') + '" readonly></p></div>' +
              '<div class="columns">' +
                '<div class="column is-6"><div class="field"><label class="label">ì•½êµ­ëª…</label><p>' + (ticket.pharmacy_name || '-') + '</p></div></div>' +
                '<div class="column is-6"><div class="field"><label class="label">ì•½ì‚¬ëª…</label><p>' + (ticket.pharmacist_name || '-') + '</p></div></div>' +
              '</div>' +
              '<div class="field"><label class="label">ì´ë©”ì¼</label><p>' + (ticket.email || '-') + '</p></div>' +
              '<div class="field"><label class="label">ì‘ì„±ì¼ì‹œ</label><p>' + (ticket.created_at ? new Date(ticket.created_at).toLocaleString('ko-KR') : '-') + '</p></div>' +
            '</div>' +
            '<div class="column is-4">' +
              '<div class="box has-background-light">' +
                '<div class="field"><label class="label">ë‹µë³€ ìƒíƒœ</label><p><span class="tag is-large ' + (ticket.status === 'open' ? 'is-danger' : ticket.status === 'answered' ? 'is-success' : 'is-light') + '">' + (ticket.status === 'open' ? 'ë¯¸ë‹µë³€' : ticket.status === 'answered' ? 'ë‹µë³€ì™„ë£Œ' : 'ì¢…ë£Œ') + '</span></p></div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<hr>' +
          '<div class="field"><label class="label">ë¬¸ì˜ ë‚´ìš©</label><div class="content box" style="white-space: pre-wrap; background: #fafafa; min-height: 150px;">' + (ticket.content || '') + '</div></div>' +
          attachmentHTML +
          repliesHTML +
          '<hr>' +
          '<div class="buttons">' +
            '<button class="button is-light" onclick="loadSupportTicketsPage()">' +
              '<i class="fas fa-arrow-left"></i>&nbsp; ëª©ë¡ìœ¼ë¡œ' +
            '</button>' +
            '<button class="button is-primary" onclick="openReplyModal(\'' + ticketId + '\')">' +
              '<i class="fas fa-reply"></i>&nbsp; ë‹µì¥í•˜ê¸°' +
            '</button>' +
          '</div>';
        
      } catch (error) {
        console.error('ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('ticketDetailPageContent').innerHTML = '<div class="notification is-danger">ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    // ë‹µì¥ ëª¨ë‹¬ ì—´ê¸°
    function openReplyModal(ticketId) {
      const modal = document.createElement('div');
      modal.id = 'replyModal';
      modal.className = 'modal is-active';
      modal.innerHTML = 
        '<div class="modal-background" onclick="closeReplyModal()"></div>' +
        '<div class="modal-card" style="width: 700px;">' +
          '<header class="modal-card-head">' +
            '<p class="modal-card-title">ë‹µì¥ ì‘ì„±</p>' +
            '<button class="delete" onclick="closeReplyModal()"></button>' +
          '</header>' +
          '<section class="modal-card-body">' +
            '<div class="field">' +
              '<label class="label">ë‹µë³€ ë‚´ìš© <span class="has-text-danger">*</span></label>' +
              '<div class="control">' +
                '<textarea id="replyContent" class="textarea" rows="8" placeholder="ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>' +
              '</div>' +
            '</div>' +
            '<div class="field">' +
              '<label class="label">ì²¨ë¶€íŒŒì¼</label>' +
              '<div class="control">' +
                '<input id="replyFileInput" class="input" type="file" multiple accept="image/*,application/pdf,application/zip">' +
              '</div>' +
              '<p class="help">ì´ë¯¸ì§€, PDF, ZIP íŒŒì¼ì„ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ìµœëŒ€ 5ê°œ)</p>' +
              '<div id="replyFileList" class="content mt-2"></div>' +
            '</div>' +
          '</section>' +
          '<footer class="modal-card-foot">' +
            '<button class="button is-success" onclick="submitReply(\'' + ticketId + '\')">' +
              '<i class="fas fa-paper-plane"></i>&nbsp; ë‹µì¥ ì „ì†¡' +
            '</button>' +
            '<button class="button" onclick="closeReplyModal()">ì·¨ì†Œ</button>' +
          '</footer>' +
        '</div>';
      
      document.body.appendChild(modal);
      
      // íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
      document.getElementById('replyFileInput').addEventListener('change', function(e) {
        const fileList = document.getElementById('replyFileList');
        const files = Array.from(e.target.files);
        
        if (files.length === 0) {
          fileList.innerHTML = '';
          return;
        }
        
        if (files.length > 5) {
          alert('ìµœëŒ€ 5ê°œì˜ íŒŒì¼ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          e.target.value = '';
          return;
        }
        
        fileList.innerHTML = '<ul>' + files.map(f => '<li><i class="fas fa-file"></i> ' + f.name + ' (' + (f.size / 1024).toFixed(2) + ' KB)</li>').join('') + '</ul>';
      });
    }

    function closeReplyModal() {
      const modal = document.getElementById('replyModal');
      if (modal) {
        modal.remove();
      }
    }

    async function submitReply(ticketId) {
      const content = document.getElementById('replyContent').value.trim();
      const fileInput = document.getElementById('replyFileInput');
      
      if (!content) {
        alert('ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const button = event.target;
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-pulse"></i>&nbsp; ì „ì†¡ ì¤‘...';
      
      try {
        let attachments = [];
        
        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ (ì‹¤ì œ Supabase Storage ì—°ë™ í•„ìš”)
        if (fileInput.files.length > 0) {
          // TODO: Supabase Storageì— íŒŒì¼ ì—…ë¡œë“œ ë¡œì§ êµ¬í˜„
          // í˜„ì¬ëŠ” íŒŒì¼ ì²¨ë¶€ ì—†ì´ ë‹µë³€ë§Œ ì „ì†¡
          alert('íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ì€ Supabase Storage ì„¤ì • í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        }
        
        const response = await fetch('/admin/api/support-tickets/' + ticketId + '/reply', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          },
          body: JSON.stringify({
            reply_content: content,
            attachments: attachments
          })
        });
        
        if (!response.ok) {
          throw new Error('ë‹µë³€ ì „ì†¡ ì‹¤íŒ¨');
        }
        
        alert('ë‹µë³€ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeReplyModal();
        loadTicketDetailPage(ticketId); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        
      } catch (error) {
        console.error('ë‹µë³€ ì „ì†¡ ì˜¤ë¥˜:', error);
        alert('ë‹µë³€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-paper-plane"></i>&nbsp; ë‹µì¥ ì „ì†¡';
      }
    }

    // ==================== ì›ê²© ì§€ì› ê´€ë¦¬ í˜ì´ì§€ ====================
    async function loadRemoteSupportPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = '<h1 class="title">ì›ê²© ì§€ì› ê´€ë¦¬</h1>' +
        '<div class="box">' +
          '<div class="columns is-multiline">' +
            '<div class="column is-3">' +
              '<div class="field">' +
                '<label class="label">ì•½êµ­ëª…</label>' +
                '<div class="control">' +
                  '<input class="input" type="text" id="remotePharmacyName" placeholder="ì•½êµ­ëª… ê²€ìƒ‰">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-3">' +
              '<div class="field">' +
                '<label class="label">ì•½ì‚¬ëª…</label>' +
                '<div class="control">' +
                  '<input class="input" type="text" id="remotePharmacistName" placeholder="ì•½ì‚¬ëª… ê²€ìƒ‰">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ìƒíƒœ</label>' +
                '<div class="control">' +
                  '<div class="select is-fullwidth">' +
                    '<select id="remoteStatusFilter">' +
                      '<option value="">ì „ì²´</option>' +
                      '<option value="requested">ìš”ì²­ë¨</option>' +
                      '<option value="in_progress">ì§„í–‰ì¤‘</option>' +
                      '<option value="completed">ì™„ë£Œ</option>' +
                      '<option value="cancelled">ì·¨ì†Œ</option>' +
                    '</select>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì‹œì‘ì¼</label>' +
                '<div class="control">' +
                  '<input class="input" type="date" id="remoteStartDate">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì¢…ë£Œì¼</label>' +
                '<div class="control">' +
                  '<input class="input" type="date" id="remoteEndDate">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2 is-offset-8">' +
              '<div class="field">' +
                '<div class="control">' +
                  '<button class="button is-primary is-fullwidth" onclick="searchRemoteSessions()">' +
                    '<i class="fas fa-search"></i>&nbsp; ê²€ìƒ‰' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<div class="control">' +
                  '<button class="button is-light is-fullwidth" onclick="clearRemoteFilters()">' +
                    '<i class="fas fa-redo"></i>&nbsp; ì´ˆê¸°í™”' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="box">' +
          '<div class="table-container">' +
            '<table class="table is-fullwidth is-striped is-hoverable">' +
              '<thead>' +
                '<tr>' +
                  '<th style="width: 60px;">No.</th>' +
                  '<th>ì„¸ì…˜ë²ˆí˜¸</th>' +
                  '<th>ì•½êµ­ëª…</th>' +
                  '<th>ì•½ì‚¬ëª…</th>' +
                  '<th>ì—°ë½ì²˜</th>' +
                  '<th>ìš”ì²­ì¼ì‹œ</th>' +
                  '<th>ë¬¸ì œìœ í˜•</th>' +
                  '<th>ìƒíƒœ</th>' +
                  '<th>ìƒë‹´ì›</th>' +
                  '<th style="width: 100px;">ì‘ì—…</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody id="remoteTableBody">' +
                '<tr>' +
                  '<td colspan="10" class="has-text-centered">' +
                    '<i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...' +
                  '</td>' +
                '</tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
          '<nav class="pagination is-centered" role="navigation" id="remotePagination">' +
          '</nav>' +
        '</div>';
      
      // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
      searchRemoteSessions();
    }

    let currentRemotePage = 1;
    const remotePageSize = 20;
    let allRemoteSessions = [];

    async function searchRemoteSessions(page = 1) {
      currentRemotePage = page;
      
      const status = document.getElementById('remoteStatusFilter')?.value || '';
      const startDate = document.getElementById('remoteStartDate')?.value || '';
      const endDate = document.getElementById('remoteEndDate')?.value || '';
      const pharmacyName = document.getElementById('remotePharmacyName')?.value?.trim() || '';
      const pharmacistName = document.getElementById('remotePharmacistName')?.value?.trim() || '';
      
      const tbody = document.getElementById('remoteTableBody');
      tbody.innerHTML = '<tr><td colspan="10" class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</td></tr>';
      
      try {
        const params = new URLSearchParams({
          page: page,
          limit: remotePageSize,
          status: status,
          startDate: startDate,
          endDate: endDate
        });
        
        const response = await fetch('/admin/api/remote-sessions?' + params.toString(), {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        allRemoteSessions = data.sessions || [];
        
        // ì•½êµ­ëª…/ì•½ì‚¬ëª… í•„í„°ë§ (í´ë¼ì´ì–¸íŠ¸ ì¸¡)
        let filteredSessions = allRemoteSessions;
        if (pharmacyName || pharmacistName) {
          filteredSessions = allRemoteSessions.filter(function(session) {
            const matchPharmacy = !pharmacyName || 
              (session.pharmacy_name && session.pharmacy_name.toLowerCase().indexOf(pharmacyName.toLowerCase()) !== -1);
            const matchPharmacist = !pharmacistName || 
              (session.pharmacist_name && session.pharmacist_name.toLowerCase().indexOf(pharmacistName.toLowerCase()) !== -1);
            return matchPharmacy && matchPharmacist;
          });
        }
        
        renderRemoteSessions(filteredSessions, data.total, data.page, data.totalPages);
        
      } catch (error) {
        console.error('ì›ê²© ì§€ì› ì¡°íšŒ ì˜¤ë¥˜:', error);
        tbody.innerHTML = '<tr><td colspan="10" class="has-text-centered has-text-danger">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    function renderRemoteSessions(sessions, total, currentPage, totalPages) {
      const tbody = document.getElementById('remoteTableBody');
      
      if (!sessions || sessions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="has-text-centered">ì›ê²© ì§€ì› ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      let html = '';
      sessions.forEach(function(session, index) {
        const num = (currentPage - 1) * remotePageSize + index + 1;
        
        const statusBadge = getRemoteStatusBadge(session.status);
        const requestedAt = new Date(session.requested_at).toLocaleString('ko-KR');
        
        html += '<tr>' +
          '<td>' + num + '</td>' +
          '<td><a onclick="loadRemoteDetailPage(\'' + session.session_id + '\')" style="cursor: pointer; color: #3273dc;">' + 
            (session.session_number || '-') + '</a></td>' +
          '<td>' + (session.pharmacy_name || '-') + '</td>' +
          '<td>' + (session.pharmacist_name || '-') + '</td>' +
          '<td>' + (session.customer_phone || '-') + '</td>' +
          '<td>' + requestedAt + '</td>' +
          '<td>' + (session.issue_category || '-') + '</td>' +
          '<td>' + statusBadge + '</td>' +
          '<td>' + (session.agent_email || '-') + '</td>' +
          '<td>' +
            '<button class="button is-small is-info" onclick="loadRemoteDetailPage(\'' + session.session_id + '\')">' +
              '<i class="fas fa-eye"></i>' +
            '</button>' +
          '</td>' +
        '</tr>';
      });
      
      tbody.innerHTML = html;
      renderRemotePagination(total, currentPage, totalPages);
    }

    function getRemoteStatusBadge(status) {
      switch(status) {
        case 'requested':
          return '<span class="tag is-warning">ìš”ì²­ë¨</span>';
        case 'in_progress':
          return '<span class="tag is-info">ì§„í–‰ì¤‘</span>';
        case 'completed':
          return '<span class="tag is-success">ì™„ë£Œ</span>';
        case 'cancelled':
          return '<span class="tag is-light">ì·¨ì†Œ</span>';
        default:
          return '<span class="tag">' + status + '</span>';
      }
    }

    function renderRemotePagination(total, currentPage, totalPages) {
      const pagination = document.getElementById('remotePagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = '<a class="pagination-previous" ' + (currentPage === 1 ? 'disabled' : 'onclick="searchRemoteSessions(' + (currentPage - 1) + ')"') + '>ì´ì „</a>';
      html += '<a class="pagination-next" ' + (currentPage === totalPages ? 'disabled' : 'onclick="searchRemoteSessions(' + (currentPage + 1) + ')"') + '>ë‹¤ìŒ</a>';
      html += '<ul class="pagination-list">';
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += '<li><a class="pagination-link ' + (i === currentPage ? 'is-current' : '') + '" onclick="searchRemoteSessions(' + i + ')">' + i + '</a></li>';
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<li><span class="pagination-ellipsis">&hellip;</span></li>';
        }
      }
      
      html += '</ul>';
      pagination.innerHTML = html;
    }

    function clearRemoteFilters() {
      document.getElementById('remoteStatusFilter').value = '';
      document.getElementById('remoteStartDate').value = '';
      document.getElementById('remoteEndDate').value = '';
      document.getElementById('remotePharmacyName').value = '';
      document.getElementById('remotePharmacistName').value = '';
      searchRemoteSessions(1);
    }

    // ì›ê²© ì§€ì› ìƒì„¸ í˜ì´ì§€
    async function loadRemoteDetailPage(sessionId) {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = '<div class="has-text-centered"><i class="fas fa-spinner fa-pulse fa-3x"></i></div>';
      
      try {
        const response = await fetch('/admin/api/remote-sessions/' + sessionId, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }
        
        const session = await response.json();
        
        const requestedAt = new Date(session.requested_at).toLocaleString('ko-KR');
        const connectedAt = session.connected_at ? new Date(session.connected_at).toLocaleString('ko-KR') : '-';
        const endedAt = session.ended_at ? new Date(session.ended_at).toLocaleString('ko-KR') : '-';
        
        mainContent.innerHTML = 
          '<nav class="breadcrumb" aria-label="breadcrumbs">' +
            '<ul>' +
              '<li><a onclick="loadRemoteSupportPage()">ì›ê²© ì§€ì› ê´€ë¦¬</a></li>' +
              '<li class="is-active"><a>' + (session.session_number || 'ìƒì„¸') + '</a></li>' +
            '</ul>' +
          '</nav>' +
          '<h1 class="title">ì›ê²© ì§€ì› ìƒì„¸</h1>' +
          '<div class="columns">' +
            '<div class="column is-8">' +
              '<div class="box">' +
                '<h2 class="subtitle">ê¸°ë³¸ ì •ë³´</h2>' +
                '<table class="table is-fullwidth">' +
                  '<tbody>' +
                    '<tr><th style="width: 150px;">ì„¸ì…˜ ë²ˆí˜¸</th><td>' + (session.session_number || '-') + '</td></tr>' +
                    '<tr><th>ìƒíƒœ</th><td>' + getRemoteStatusBadge(session.status) + '</td></tr>' +
                    '<tr><th>ì•½êµ­ëª…</th><td>' + (session.pharmacy_name || '-') + '</td></tr>' +
                    '<tr><th>ì•½ì‚¬ëª…</th><td>' + (session.pharmacist_name || '-') + '</td></tr>' +
                    '<tr><th>ì´ë©”ì¼</th><td>' + (session.email || '-') + '</td></tr>' +
                    '<tr><th>ì—°ë½ì²˜</th><td>' + (session.customer_phone || '-') + '</td></tr>' +
                  '</tbody>' +
                '</table>' +
              '</div>' +
              '<div class="box">' +
                '<h2 class="subtitle">ì„¸ì…˜ ì •ë³´</h2>' +
                '<table class="table is-fullwidth">' +
                  '<tbody>' +
                    '<tr><th style="width: 150px;">ìš”ì²­ì¼ì‹œ</th><td>' + requestedAt + '</td></tr>' +
                    '<tr><th>ì‹œì‘ì¼ì‹œ</th><td>' + connectedAt + '</td></tr>' +
                    '<tr><th>ì¢…ë£Œì¼ì‹œ</th><td>' + endedAt + '</td></tr>' +
                    '<tr><th>ìƒë‹´ì›</th><td>' + (session.agent_email || '-') + '</td></tr>' +
                  '</tbody>' +
                '</table>' +
              '</div>' +
              '<div class="box" style="border: 2px solid #3273dc;">' +
                '<h2 class="subtitle">' +
                  '<i class="fas fa-edit"></i> ìƒë‹´ ë‚´ìš© ì‘ì„± ' +
                  '<span class="tag is-info is-light">ì•„ë˜ ë‚´ìš© ì‘ì„± í›„ í•˜ë‹¨ "ì „ì²´ ì €ì¥" ë²„íŠ¼ í´ë¦­</span>' +
                '</h2>' +
                '<div class="field">' +
                  '<label class="label">í˜„ì¬ ìƒíƒœ <span class="has-text-danger">*</span></label>' +
                  '<div class="control">' +
                    '<div class="select is-fullwidth">' +
                      '<select id="sessionStatus">' +
                        '<option value="requested" ' + (session.status === 'requested' ? 'selected' : '') + '>ìš”ì²­ë¨</option>' +
                        '<option value="in_progress" ' + (session.status === 'in_progress' ? 'selected' : '') + '>ì§„í–‰ì¤‘</option>' +
                        '<option value="completed" ' + (session.status === 'completed' ? 'selected' : '') + '>ì™„ë£Œ</option>' +
                        '<option value="cancelled" ' + (session.status === 'cancelled' ? 'selected' : '') + '>ì·¨ì†Œ</option>' +
                      '</select>' +
                    '</div>' +
                  '</div>' +
                  '<p class="help">ìƒíƒœë¥¼ ë³€ê²½í•˜ë©´ ìë™ìœ¼ë¡œ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ì´ ê¸°ë¡ë©ë‹ˆë‹¤</p>' +
                '</div>' +
                '<div class="field">' +
                  '<label class="label">ì ‘ì† ë©”ëª¨</label>' +
                  '<div class="control">' +
                    '<textarea class="textarea" id="connectionNote" rows="2" placeholder="ì˜ˆ: TeamViewer ID 123-456-789ë¡œ ì ‘ì†, ì „í™” í†µí™” í›„ ì ‘ì† ì§„í–‰...">' + (session.connection_note || '') + '</textarea>' +
                  '</div>' +
                  '<p class="help">ì›ê²© ì ‘ì† ë°©ì‹ì´ë‚˜ ID ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”</p>' +
                '</div>' +
                '<div class="field">' +
                  '<label class="label">ë¬¸ì œ ìœ í˜•</label>' +
                  '<div class="control">' +
                    '<input class="input" type="text" id="issueCategory" value="' + (session.issue_category || '') + '" placeholder="ì˜ˆ: ì„¤ì¹˜ ì˜¤ë¥˜, ë°”ì½”ë“œ ì¸ì‹, ì„±ëŠ¥ ë¬¸ì œ">' +
                  '</div>' +
                '</div>' +
                '<div class="field">' +
                  '<label class="label">ìƒë‹´ ë©”ëª¨</label>' +
                  '<div class="control">' +
                    '<textarea class="textarea" id="notes" rows="5" placeholder="ìƒë‹´ ì§„í–‰ ê³¼ì •, ê³ ê° ìš”ì²­ ì‚¬í•­, ë°œê²¬í•œ ë¬¸ì œì  ë“±ì„ ìƒì„¸íˆ ê¸°ë¡í•˜ì„¸ìš”...">' + (session.notes || '') + '</textarea>' +
                  '</div>' +
                '</div>' +
                '<div class="field">' +
                  '<label class="label">í•´ê²° ë°©ë²•</label>' +
                  '<div class="control">' +
                    '<textarea class="textarea" id="resolution" rows="4" placeholder="ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ì·¨í•œ ì¡°ì¹˜, ì•ˆë‚´ ì‚¬í•­ ë“±ì„ ìš”ì•½í•˜ì„¸ìš”...">' + (session.resolution || '') + '</textarea>' +
                  '</div>' +
                '</div>' +
                '<div class="field">' +
                  '<div class="control">' +
                    '<button class="button is-primary is-large is-fullwidth" onclick="updateRemoteSession(\'' + sessionId + '\')" style="height: 60px;">' +
                      '<span class="icon is-medium"><i class="fas fa-save"></i></span>' +
                      '<span style="font-size: 1.1rem; font-weight: bold;">ì „ì²´ ì €ì¥ (ìƒíƒœ + ëª¨ë“  ë©”ëª¨)</span>' +
                    '</button>' +
                  '</div>' +
                  '<p class="help has-text-centered mt-2">ìœ„ ëª¨ë“  í•„ë“œì˜ ë‚´ìš©ì´ í•¨ê»˜ ì €ì¥ë©ë‹ˆë‹¤</p>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-4">' +
              '<div class="box">' +
                '<h2 class="subtitle">ëª©ë¡ìœ¼ë¡œ</h2>' +
                '<div class="field">' +
                  '<div class="control">' +
                    '<button class="button is-light is-fullwidth" onclick="loadRemoteSupportPage()">' +
                      '<i class="fas fa-arrow-left"></i>&nbsp; ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°' +
                    '</button>' +
                  '</div>' +
                '</div>' +
              '</div>' +
              '<div class="box" style="background-color: #f0f9ff; border: 2px solid #3298dc;">' +
                '<h2 class="subtitle">' +
                  '<i class="fas fa-bolt"></i> ë¹ ë¥¸ ìƒíƒœ ë³€ê²½ ' +
                  '<span class="tag is-warning is-light">ì£¼ì˜</span>' +
                '</h2>' +
                '<div class="notification is-warning is-light">' +
                  '<p class="is-size-7"><strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong></p>' +
                  '<p class="is-size-7">ì•„ë˜ ë²„íŠ¼ì€ <strong>ìƒíƒœë§Œ</strong> ì¦‰ì‹œ ë³€ê²½í•©ë‹ˆë‹¤.</p>' +
                  '<p class="is-size-7">ì‘ì„±í•œ ë©”ëª¨ëŠ” ì €ì¥ë˜ì§€ ì•Šìœ¼ë‹ˆ, ë©”ëª¨ ì‘ì„± í›„ì—ëŠ” ìœ„ì˜ <strong>"ì „ì²´ ì €ì¥"</strong> ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”!</p>' +
                '</div>' +
                '<div class="buttons">' +
                  '<button class="button is-info is-fullwidth" onclick="quickUpdateStatus(\'' + sessionId + '\', \'in_progress\')" ' + 
                    (session.status === 'in_progress' ? 'disabled' : '') + '>' +
                    '<i class="fas fa-play"></i>&nbsp; ì§„í–‰ì¤‘ìœ¼ë¡œë§Œ ë³€ê²½' +
                  '</button>' +
                '</div>' +
                '<div class="buttons">' +
                  '<button class="button is-success is-fullwidth" onclick="quickUpdateStatus(\'' + sessionId + '\', \'completed\')" ' + 
                    (session.status === 'completed' ? 'disabled' : '') + '>' +
                    '<i class="fas fa-check"></i>&nbsp; ì™„ë£Œë¡œë§Œ ë³€ê²½' +
                  '</button>' +
                '</div>' +
                '<div class="buttons">' +
                  '<button class="button is-light is-fullwidth" onclick="quickUpdateStatus(\'' + sessionId + '\', \'cancelled\')" ' + 
                    (session.status === 'cancelled' ? 'disabled' : '') + '>' +
                    '<i class="fas fa-times"></i>&nbsp; ì·¨ì†Œë¡œë§Œ ë³€ê²½' +
                  '</button>' +
                '</div>' +
                '<p class="help has-text-centered">ë©”ëª¨ ì—†ì´ ìƒíƒœë§Œ ë¹ ë¥´ê²Œ ë³€ê²½í•  ë•Œ ì‚¬ìš©</p>' +
              '</div>' +
              '<div class="box" style="background-color: #f5f5f5;">' +
                '<h2 class="subtitle"><i class="fas fa-info-circle"></i> ì‚¬ìš© ê°€ì´ë“œ</h2>' +
                '<div class="content is-size-7">' +
                  '<p><strong>ğŸ“ ë©”ëª¨ì™€ í•¨ê»˜ ì €ì¥:</strong></p>' +
                  '<ol>' +
                    '<li>ìƒíƒœ ì„ íƒ</li>' +
                    '<li>ì ‘ì† ë©”ëª¨, ë¬¸ì œ ìœ í˜•, ìƒë‹´ ë©”ëª¨, í•´ê²° ë°©ë²• ì‘ì„±</li>' +
                    '<li><strong>"ì „ì²´ ì €ì¥"</strong> ë²„íŠ¼ í´ë¦­</li>' +
                  '</ol>' +
                  '<p><strong>âš¡ ìƒíƒœë§Œ ë¹ ë¥´ê²Œ ë³€ê²½:</strong></p>' +
                  '<ol>' +
                    '<li>"ë¹ ë¥¸ ìƒíƒœ ë³€ê²½" ì„¹ì…˜ì˜ ë²„íŠ¼ í´ë¦­</li>' +
                    '<li>í™•ì¸ í›„ ì¦‰ì‹œ ë°˜ì˜ (ë©”ëª¨ ì €ì¥ ì•ˆ ë¨)</li>' +
                  '</ol>' +
                  '<p class="has-text-danger"><strong>âš ï¸ ì¤‘ìš”:</strong></p>' +
                  '<ul>' +
                    '<li>ë©”ëª¨ë¥¼ ì‘ì„±í–ˆë‹¤ë©´ ë°˜ë“œì‹œ "ì „ì²´ ì €ì¥" ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ í•©ë‹ˆë‹¤</li>' +
                    '<li>ë¹ ë¥¸ ë³€ê²½ ë²„íŠ¼ì€ ì‘ì„±í•œ ë©”ëª¨ë¥¼ ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</li>' +
                  '</ul>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>';
        
      } catch (error) {
        console.error('ì›ê²© ì§€ì› ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
        mainContent.innerHTML = '<div class="notification is-danger">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    async function updateRemoteSession(sessionId) {
      const status = document.getElementById('sessionStatus').value;
      const connectionNote = document.getElementById('connectionNote').value.trim();
      const issueCategory = document.getElementById('issueCategory').value.trim();
      const notes = document.getElementById('notes').value.trim();
      const resolution = document.getElementById('resolution').value.trim();
      
      try {
        const response = await fetch('/admin/api/remote-sessions/' + sessionId, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          },
          body: JSON.stringify({
            status: status,
            connection_note: connectionNote,
            issue_category: issueCategory,
            notes: notes,
            resolution: resolution
          })
        });
        
        if (!response.ok) {
          throw new Error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        }
        
        alert('ì›ê²© ì§€ì› ì„¸ì…˜ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadRemoteDetailPage(sessionId); // ìƒˆë¡œê³ ì¹¨
        
      } catch (error) {
        console.error('ì›ê²© ì§€ì› ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function quickUpdateStatus(sessionId, newStatus) {
      if (!confirm('ìƒíƒœë¥¼ "' + getStatusText(newStatus) + '"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        const response = await fetch('/admin/api/remote-sessions/' + sessionId, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          },
          body: JSON.stringify({
            status: newStatus
          })
        });
        
        if (!response.ok) {
          throw new Error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        }
        
        alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadRemoteDetailPage(sessionId); // ìƒˆë¡œê³ ì¹¨
        
      } catch (error) {
        console.error('ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
        alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function getStatusText(status) {
      switch(status) {
        case 'requested': return 'ìš”ì²­ë¨';
        case 'in_progress': return 'ì§„í–‰ì¤‘';
        case 'completed': return 'ì™„ë£Œ';
        case 'cancelled': return 'ì·¨ì†Œ';
        default: return status;
      }
    }
  
    loadRecentActivities();
  </script>
</body>
</html>
