<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PharmChecker ìš´ì˜ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { background-color: #f5f5f5; }
    .navbar { box-shadow: 0 2px 4px rgba(0,0,0,.08); }
    .sidebar {
      min-height: calc(100vh - 52px);
      background: white;
      border-right: 1px solid #dbdbdb;
      padding: 1.5rem 0;
    }
    .menu-label {
      padding: 0 1rem;
      text-transform: uppercase;
      font-size: 0.75rem;
      font-weight: 700;
      color: #7a7a7a;
    }
    .menu-list a {
      border-radius: 0;
      padding: 0.75rem 1.5rem;
    }
    .menu-list a.is-active {
      background-color: #3273dc;
      color: white;
    }
    .stat-card {
      background: white;
      border-radius: 6px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      margin-bottom: 1.5rem;
    }
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #3273dc;
    }
    .stat-label {
      color: #7a7a7a;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
    .content-area {
      padding: 2rem;
    }
    .quick-action {
      transition: transform 0.2s;
    }
    .quick-action:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="navbar is-white" role="navigation">
    <div class="navbar-brand">
      <div class="navbar-item">
        <strong>ğŸ¥ PharmChecker ìš´ì˜ ëŒ€ì‹œë³´ë“œ</strong>
      </div>
    </div>
    
    <div class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
            <i class="fas fa-user-shield"></i>
            <span id="adminName"><%= typeof adminName !== 'undefined' ? adminName : 'ê´€ë¦¬ì' %></span>
          </a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="columns is-gapless">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="column is-2 sidebar">
      <aside class="menu">
        <p class="menu-label">ë©”ì¸</p>
        <ul class="menu-list">
          <li><a class="is-active" onclick="window.location.reload()">
            <i class="fas fa-home"></i> ëŒ€ì‹œë³´ë“œ
          </a></li>
        </ul>

        <p class="menu-label">êµ¬ë… ê´€ë¦¬</p>
        <ul class="menu-list">
          <li><a href="/admin/users">
            <i class="fas fa-users"></i> íšŒì› ê´€ë¦¬
          </a></li>
          <li><a onclick="window.location.href='/admin/mobile'">
            <i class="fas fa-mobile-alt"></i> ëª¨ë°”ì¼ ì¡°íšŒ
          </a></li>
          <li><a onclick="loadPage('subscriptions')">
            <i class="fas fa-credit-card"></i> êµ¬ë… í˜„í™©
          </a></li>
          <li><a onclick="loadPage('payments')">
            <i class="fas fa-receipt"></i> ê²°ì œ ë‚´ì—­
          </a></li>
        </ul>

        <p class="menu-label">ê³ ê° ë¬¸ì˜ ê´€ë¦¬</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('support-tickets')">
            <i class="fas fa-headset"></i> ë¬¸ì˜ ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('remote-support')">
            <i class="fas fa-desktop"></i> ì›ê²© ì§€ì› ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('faq-management')">
            <i class="fas fa-question-circle"></i> FAQ ê´€ë¦¬
          </a></li>
        </ul>

        <p class="menu-label">í”„ë¡œëª¨ì…˜</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('promotions')">
            <i class="fas fa-gift"></i> í”„ë¡œëª¨ì…˜ ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('referral-codes')">
            <i class="fas fa-ticket-alt"></i> ì¶”ì²œì¸ ì½”ë“œ
          </a></li>
          <li><a onclick="loadPage('assign-promotion')">
            <i class="fas fa-user-tag"></i> í”„ë¡œëª¨ì…˜ í• ë‹¹
          </a></li>
        </ul>

        <p class="menu-label">ì‹œìŠ¤í…œ</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('plans')">
            <i class="fas fa-layer-group"></i> í”Œëœ ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('activity-logs')">
            <i class="fas fa-history"></i> í™œë™ ë¡œê·¸
          </a></li>
          <li><a onclick="loadPage('settings')">
            <i class="fas fa-cog"></i> ì„¤ì •
          </a></li>
        </ul>
      </aside>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="column content-area">
      <div id="mainContent">
        <!-- ëŒ€ì‹œë³´ë“œ í†µê³„ -->
        <h1 class="title">ëŒ€ì‹œë³´ë“œ</h1>
        
        <div class="columns is-multiline">
          <!-- í†µê³„ ì¹´ë“œë“¤ -->
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="totalUsers">-</div>
              <div class="stat-label">ì „ì²´ íšŒì›</div>
            </div>
          </div>
          
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="activeSubscriptions">-</div>
              <div class="stat-label">í™œì„± êµ¬ë…</div>
            </div>
          </div>
          
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="monthlyRevenue">-</div>
              <div class="stat-label">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div>
            </div>
          </div>
          
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="activePromotions">-</div>
              <div class="stat-label">í™œì„± í”„ë¡œëª¨ì…˜</div>
            </div>
          </div>
        </div>

        <!-- ë¹ ë¥¸ ì‘ì—… -->
        <h2 class="title is-4 mt-5">ë¹ ë¥¸ ì‘ì—…</h2>
        <div class="columns is-multiline">
          <div class="column is-4">
            <div class="box quick-action" onclick="loadPage('promotions')">
              <div class="media">
                <div class="media-left">
                  <span class="icon is-large has-text-info">
                    <i class="fas fa-2x fa-gift"></i>
                  </span>
                </div>
                <div class="media-content">
                  <p class="title is-5">í”„ë¡œëª¨ì…˜ ìƒì„±</p>
                  <p class="subtitle is-6">ìƒˆë¡œìš´ í• ì¸/ë¬´ë£Œ í”„ë¡œëª¨ì…˜</p>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-4">
            <div class="box quick-action" onclick="loadPage('assign-promotion')">
              <div class="media">
                <div class="media-left">
                  <span class="icon is-large has-text-success">
                    <i class="fas fa-2x fa-user-tag"></i>
                  </span>
                </div>
                <div class="media-content">
                  <p class="title is-5">í”„ë¡œëª¨ì…˜ í• ë‹¹</p>
                  <p class="subtitle is-6">íšŒì›ì—ê²Œ í”„ë¡œëª¨ì…˜ ë¶€ì—¬</p>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-4">
            <div class="box quick-action" onclick="loadPage('users')">
              <div class="media">
                <div class="media-left">
                  <span class="icon is-large has-text-warning">
                    <i class="fas fa-2x fa-users"></i>
                  </span>
                </div>
                <div class="media-content">
                  <p class="title is-5">íšŒì› ì¡°íšŒ</p>
                  <p class="subtitle is-6">íšŒì› ì •ë³´ ë° êµ¬ë… ìƒíƒœ</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ìµœê·¼ í™œë™ -->
        <h2 class="title is-4 mt-5">ìµœê·¼ í™œë™</h2>
        <div class="box">
          <table class="table is-fullwidth is-hoverable">
            <thead>
              <tr>
                <th>ì‹œê°„</th>
                <th>í™œë™</th>
                <th>ëŒ€ìƒ</th>
                <th>ê´€ë¦¬ì</th>
              </tr>
            </thead>
            <tbody id="recentActivities">
              <tr>
                <td colspan="4" class="has-text-centered">ë¡œë”© ì¤‘...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- íšŒì› ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
  <div class="modal" id="userDetailModal">
    <div class="modal-background" onclick="closeUserDetailModal()"></div>
    <div class="modal-card" style="width: 90%; max-width: 1200px;">
      <header class="modal-card-head">
        <p class="modal-card-title">
          <i class="fas fa-user-circle"></i> <span id="modalUserName">íšŒì› ìƒì„¸ ì •ë³´</span>
        </p>
        <button class="delete" aria-label="close" onclick="closeUserDetailModal()"></button>
      </header>
      <section class="modal-card-body" style="max-height: 80vh; overflow-y: auto;">
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tabs is-boxed">
          <ul>
            <li class="is-active" data-tab="basic">
              <a onclick="switchTab('basic')">
                <span class="icon is-small"><i class="fas fa-info-circle"></i></span>
                <span>ê¸°ë³¸ ì •ë³´</span>
              </a>
            </li>
            <li data-tab="subscription">
              <a onclick="switchTab('subscription')">
                <span class="icon is-small"><i class="fas fa-credit-card"></i></span>
                <span>êµ¬ë… ë‚´ì—­</span>
              </a>
            </li>
            <li data-tab="payment">
              <a onclick="switchTab('payment')">
                <span class="icon is-small"><i class="fas fa-money-bill-wave"></i></span>
                <span>ê²°ì œ ë‚´ì—­</span>
              </a>
            </li>
            <li data-tab="promotion">
              <a onclick="switchTab('promotion')">
                <span class="icon is-small"><i class="fas fa-gift"></i></span>
                <span>í”„ë¡œëª¨ì…˜</span>
              </a>
            </li>
            <li data-tab="activity">
              <a onclick="switchTab('activity')">
                <span class="icon is-small"><i class="fas fa-history"></i></span>
                <span>í™œë™ ë¡œê·¸</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- íƒ­ ì»¨í…ì¸  -->
        <div id="tabContent">
          <!-- ê¸°ë³¸ ì •ë³´ íƒ­ -->
          <div id="tab-basic" class="tab-content is-active">
            <h5 class="title is-5"><i class="fas fa-user"></i> íšŒì› ê¸°ë³¸ ì •ë³´</h5>
            <div class="columns is-multiline">
              <div class="column is-6">
                <div class="field">
                  <label class="label">ì•½êµ­ëª…</label>
                  <div class="control">
                    <input class="input" id="detailPharmacyName" readonly>
                  </div>
                </div>
              </div>
              <div class="column is-6">
                <div class="field">
                  <label class="label">ê°€ì…ì¼</label>
                  <div class="control">
                    <input class="input" id="detailCreatedAt" readonly>
                  </div>
                </div>
              </div>
              <div class="column is-8">
                <div class="field">
                  <label class="label">ì•½êµ­ ì£¼ì†Œ</label>
                  <div class="control">
                    <input class="input" id="detailAddress" readonly>
                  </div>
                </div>
              </div>
              <div class="column is-4">
                <div class="field">
                  <label class="label">ê³„ì • ìƒíƒœ</label>
                  <div class="control">
                    <span id="detailAccountStatus" class="tag is-medium"></span>
                  </div>
                </div>
              </div>
            </div>
            
            <hr>
            <h5 class="title is-5"><i class="fas fa-sticky-note"></i> ê´€ë¦¬ì ë©”ëª¨ ë° ë¹„ê³ </h5>
            
            <!-- ìƒˆ ë©”ëª¨/ë¹„ê³  ì‘ì„± -->
            <div class="box" style="background-color: #f5f5f5;">
              <h6 class="subtitle is-6">ìƒˆ ë©”ëª¨/ë¹„ê³  ì‘ì„±</h6>
              <div class="field">
                <label class="label">ë©”ëª¨</label>
                <div class="control">
                  <textarea class="textarea" id="newMemoText" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
                </div>
              </div>
              <div class="field">
                <label class="label">ë¹„ê³  (ê°„ë‹¨í•œ ìš”ì•½, 200ì ì´ë‚´)</label>
                <div class="control">
                  <input class="input" type="text" id="newRemarksText" maxlength="200" placeholder="ë¹„ê³ ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                </div>
              </div>
              <div class="field">
                <div class="control">
                  <button class="button is-primary" onclick="saveNewMemo()">
                    <i class="fas fa-save"></i> ì €ì¥
                  </button>
                </div>
              </div>
            </div>
            
            <!-- ë©”ëª¨ ë‚´ì—­ -->
            <h6 class="subtitle is-6">ë©”ëª¨ ë‚´ì—­</h6>
            <div id="memoList"></div>
          </div>

          <!-- êµ¬ë… ë‚´ì—­ íƒ­ -->
          <div id="tab-subscription" class="tab-content" style="display: none;">
            <div id="subscriptionList"></div>
          </div>

          <!-- ê²°ì œ ë‚´ì—­ íƒ­ -->
          <div id="tab-payment" class="tab-content" style="display: none;">
            <div class="table-container">
              <table class="table is-fullwidth is-hoverable">
                <thead>
                  <tr>
                    <th>ê²°ì œì¼</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ê²°ì œ ìˆ˜ë‹¨</th>
                    <th>ìƒíƒœ</th>
                    <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                    <th>ì‹¤íŒ¨ ì‚¬ìœ </th>
                  </tr>
                </thead>
                <tbody id="paymentList"></tbody>
              </table>
            </div>
          </div>

          <!-- í”„ë¡œëª¨ì…˜ íƒ­ -->
          <div id="tab-promotion" class="tab-content" style="display: none;">
            <div class="table-container">
              <table class="table is-fullwidth is-hoverable">
                <thead>
                  <tr>
                    <th>í”„ë¡œëª¨ì…˜ íƒ€ì…</th>
                    <th>í• ì¸ìœ¨</th>
                    <th>ë¬´ë£Œ ê°œì›”</th>
                    <th>ì‹œì‘ì¼</th>
                    <th>ë§Œë£Œì¼</th>
                    <th>ìƒíƒœ</th>
                  </tr>
                </thead>
                <tbody id="promotionList"></tbody>
              </table>
            </div>
          </div>

          <!-- í™œë™ ë¡œê·¸ íƒ­ -->
          <div id="tab-activity" class="tab-content" style="display: none;">
            <div class="table-container">
              <table class="table is-fullwidth is-hoverable is-narrow" style="font-size: 0.85rem;">
                <thead>
                  <tr>
                    <th>ì‹œê°„</th>
                    <th>í™œë™</th>
                    <th>ê´€ë¦¬ì</th>
                    <th>ìƒì„¸</th>
                  </tr>
                </thead>
                <tbody id="activityList"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button" onclick="closeUserDetailModal()">ë‹«ê¸°</button>
      </footer>
    </div>
  </div>

  <script>
    // URLì„ /adminìœ¼ë¡œ ë³€ê²½
    if (window.location.pathname !== '/admin') {
      window.history.replaceState(null, '', '/admin');
    }
    
    // ì „ì—­ Supabase í´ë¼ì´ì–¸íŠ¸ (í•œ ë²ˆë§Œ ìƒì„±, ì„¸ì…˜ ìë™ ë³µì›)
    const supabaseClient = window.supabase.createClient(
      'https://gitbtujexmsjfixgeoha.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpdGJ0dWpleG1zamZpeGdlb2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NzA5MDIsImV4cCI6MjA4MjA0NjkwMn0.BNN8hauH8NdHZ4vopW_CQ_iK9CR55nfp3JQwuTjrG48'
    );
    
    // ë¡œê·¸ì¸ í™•ì¸ - onAuthStateChange ë¦¬ìŠ¤ë„ˆë¡œ ëŒ€ì²´ë¨ (ì•„ë˜ ì°¸ì¡°)

    // ê´€ë¦¬ì ì •ë³´ ë¡œë“œ
    async function loadAdminInfo() {
      try {
        // localStorageì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
        const token = localStorage.getItem('admin_session_token');
        
        if (!token) {
          return;
        }
        
        const response = await fetch('/admin/api/me', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        if (!response.ok) {
          return;
        }
        
        const data = await response.json();
        const adminNameEl = document.getElementById('adminName');
        if (adminNameEl) {
          adminNameEl.textContent = data.admin_name + ' (' + data.email + ')';
        }
      } catch (error) {
        // ì—ëŸ¬ ë¬´ì‹œ
      }
    }

    // ëŒ€ì‹œë³´ë“œ í†µê³„ ë¡œë“œ
    async function loadDashboardStats() {
      try {
        const token = localStorage.getItem('admin_session_token');
        
        const response = await fetch('/admin/api/dashboard/stats', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        if (!response.ok) {
          // ì¸ì¦ ì˜¤ë¥˜ë©´ ì„¸ì…˜ ë§Œë£Œë¡œ ì²˜ë¦¬
          if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('admin_session_token');
            const cookiesToDelete = [
              'admin_session_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
              'admin_session_token=; path=/admin; expires=Thu, 01 Jan 1970 00:00:00 GMT'
            ];
            cookiesToDelete.forEach(cookie => document.cookie = cookie);
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            window.location.href = '/admin';
            return;
          }
          
          throw new Error('í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ' + response.status);
        }
        
        const stats = await response.json();
        
        document.getElementById('totalUsers').textContent = stats.totalUsers.toLocaleString();
        document.getElementById('activeSubscriptions').textContent = stats.activeSubscriptions.toLocaleString();
        document.getElementById('monthlyRevenue').textContent = `${(stats.monthlyRevenue / 10000).toFixed(0)}ë§Œì›`;
        document.getElementById('activePromotions').textContent = stats.activePromotions.toLocaleString();
        
      } catch (error) {
        document.getElementById('totalUsers').textContent = 'ì˜¤ë¥˜';
        document.getElementById('activeSubscriptions').textContent = 'ì˜¤ë¥˜';
        document.getElementById('monthlyRevenue').textContent = 'ì˜¤ë¥˜';
        document.getElementById('activePromotions').textContent = 'ì˜¤ë¥˜';
      }
    }

    // ìµœê·¼ í™œë™ ë¡œë“œ
    async function loadRecentActivities() {
      try {
        const response = await fetch('/admin/api/activities/recent', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        // 401 ì˜¤ë¥˜ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (response.status === 401) {
          localStorage.removeItem('admin_session_token');
          window.location.href = '/admin/login';
          return;
        }
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const activities = await response.json();
        const tbody = document.getElementById('recentActivities');
        
        if (!activities || !Array.isArray(activities) || activities.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="has-text-centered">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }
        
        tbody.innerHTML = activities.map(act => `
          <tr>
            <td>${new Date(act.created_at).toLocaleString('ko-KR')}</td>
            <td><span class="tag">${act.action_type}</span></td>
            <td>${act.target_type || '-'}</td>
            <td>${act.admin_name}</td>
          </tr>
        `).join('');
        
      } catch (error) {
        const tbody = document.getElementById('recentActivities');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="4" class="has-text-centered has-text-danger">í™œë™ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        }
      }
    }

    // í˜ì´ì§€ ì „í™˜
    function loadPage(page) {
      // ë©”ë‰´ í™œì„±í™” ìƒíƒœ ë³€ê²½
      document.querySelectorAll('.menu-list a').forEach(a => a.classList.remove('is-active'));
      const menuLink = event?.target?.closest('a');
      if (menuLink) {
        menuLink.classList.add('is-active');
      }
      
      if (page === 'dashboard') {
        // ëŒ€ì‹œë³´ë“œëŠ” í˜„ì¬ í˜ì´ì§€ ë¦¬ë¡œë“œ
        location.reload();
        return;
      }
      
      if (page === 'users') {
        loadUsersPage();
        return;
      }
      
      if (page === 'subscriptions') {
        loadSubscriptionsPage();
        return;
      }
      
      if (page === 'payments') {
        loadPaymentsPage();
        return;
      }
      
      if (page === 'support-tickets') {
        loadSupportTicketsPage();
        return;
      }
      
      if (page === 'remote-support') {
        loadRemoteSupportPage();
        return;
      }
      
      if (page === 'faq-management') {
        loadFaqManagementPage();
        return;
      }
      
      if (page === 'plans') {
        loadPlansPage();
        return;
      }
      
      if (page === 'promotions') {
        loadPromotionsPage();
        return;
      }
      
      if (page === 'referral-codes') {
        loadReferralCodesPage();
        return;
      }
      
      if (page === 'assign-promotion') {
        loadAssignPromotionPage();
        return;
      }
      
      // ticket-detail í˜ì´ì§€ëŠ” loadTicketDetailPageì—ì„œ ì²˜ë¦¬
      
      // TODO: í˜ì´ì§€ë³„ ì»¨í…ì¸  ë¡œë“œ
      alert(`${page} í˜ì´ì§€ ê°œë°œ ì˜ˆì •`);
    }
    
    // íšŒì› ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œ
    async function loadUsersPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <h1 class="title">íšŒì› ê´€ë¦¬</h1>
        
        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="box">
          <!-- ì²« ë²ˆì§¸ í–‰: ì´ë¦„, ì´ë©”ì¼ ê²€ìƒ‰ -->
          <div class="columns">
            <div class="column is-3">
              <div class="field">
                <label class="label">ì•½ì‚¬ëª… ê²€ìƒ‰</label>
                <div class="control has-icons-left">
                  <input class="input" type="text" id="nameSearch" placeholder="ì•½ì‚¬ëª… ì…ë ¥">
                  <span class="icon is-small is-left">
                    <i class="fas fa-user"></i>
                  </span>
                </div>
              </div>
            </div>
            
            <div class="column is-3">
              <div class="field">
                <label class="label">ì´ë©”ì¼ ê²€ìƒ‰</label>
                <div class="control has-icons-left">
                  <input class="input" type="text" id="emailSearch" placeholder="ì´ë©”ì¼ ì…ë ¥">
                  <span class="icon is-small is-left">
                    <i class="fas fa-envelope"></i>
                  </span>
                </div>
              </div>
            </div>
            
            <div class="column is-2">
              <div class="field">
                <label class="label">êµ¬ë… ìƒíƒœ</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="subscriptionFilter">
                      <option value="">ì „ì²´</option>
                      <option value="active">í™œì„±</option>
                      <option value="cancelled">ì·¨ì†Œë¨</option>
                      <option value="none">ì—†ìŒ</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="column is-2">
              <div class="field">
                <label class="label">ê³„ì • ìƒíƒœ</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="accountFilter">
                      <option value="">ì „ì²´</option>
                      <option value="active">í™œì„±</option>
                      <option value="deleted">íƒˆí‡´</option>
                      <option value="returning">ì¬ê°€ì… ê³ ê°</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="column is-2">
              <div class="field">
                <label class="label">&nbsp;</label>
                <button class="button is-primary is-fullwidth" onclick="searchUsers()">
                  <i class="fas fa-search"></i> ê²€ìƒ‰
                </button>
              </div>
            </div>
          </div>
          
          <!-- ë‘ ë²ˆì§¸ í–‰: ê¸°ê°„ í•„í„° -->
          <div class="columns">
            <div class="column is-3">
              <div class="field">
                <label class="label">ê¸°ê°„ ì‹œì‘ì¼</label>
                <div class="control">
                  <input class="input" type="date" id="startDate">
                </div>
              </div>
            </div>
            
            <div class="column is-3">
              <div class="field">
                <label class="label">ê¸°ê°„ ì¢…ë£Œì¼</label>
                <div class="control">
                  <input class="input" type="date" id="endDate">
                </div>
              </div>
            </div>
            
            <div class="column is-6">
              <div class="field">
                <label class="label">ê¸°ê°„ í•„í„° ì•ˆë‚´</label>
                <p class="help">
                  <i class="fas fa-info-circle"></i> 
                  íƒˆí‡´ íšŒì›: íƒˆí‡´ì¼ ê¸°ì¤€ / í™œì„± êµ¬ë…: êµ¬ë… ê¸°ê°„ ë‚´ í¬í•¨ / ê¸°íƒ€: ê°€ì…ì¼ ê¸°ì¤€
                </p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- íšŒì› ëª©ë¡ í…Œì´ë¸” -->
        <div class="box">
          <h5 class="title is-5" id="userCount">íšŒì› ëª©ë¡ (ì´ 0ëª…)</h5>
          <div class="table-container">
            <table class="table is-fullwidth is-hoverable is-narrow" style="font-size: 0.85rem;">
              <thead>
                <tr>
                  <th style="width: 40px;">#</th>
                  <th>ì´ë©”ì¼</th>
                  <th>ì•½ì‚¬ëª…</th>
                  <th>ì•½êµ­ëª…</th>
                  <th>ì „í™”ë²ˆí˜¸</th>
                  <th>êµ¬ë… ìƒíƒœ</th>
                  <th>í”Œëœ</th>
                  <th>êµ¬ë… ì‹œì‘ì¼</th>
                  <th>êµ¬ë… ì¢…ë£Œì¼</th>
                  <th>ë‹¤ìŒ ê²°ì œì¼</th>
                  <th>í”„ë¡œëª¨ì…˜</th>
                  <th style="min-width: 120px;">ë©”ëª¨</th>
                  <th style="min-width: 120px;">ë¹„ê³ </th>
                  <th>ìƒíƒœ</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr>
                  <td colspan="14" class="has-text-centered">ë¡œë”© ì¤‘...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
          <nav class="pagination is-centered" role="navigation" id="pagination">
            <a class="pagination-previous" id="prevPage">ì´ì „</a>
            <a class="pagination-next" id="nextPage">ë‹¤ìŒ</a>
            <ul class="pagination-list" id="pageNumbers"></ul>
          </nav>
      `;
      
      // íšŒì› ëª©ë¡ ë¡œë“œ
      await fetchUsers();
    }
    
    // ì „ì—­ ë³€ìˆ˜
    let currentPage = 1;
    let currentName = '';
    let currentEmail = '';
    let currentStartDate = '';
    let currentEndDate = '';
    let currentSubFilter = '';
    let currentAccFilter = '';
    
    // íšŒì› ê²€ìƒ‰
    function searchUsers() {
      currentPage = 1;
      currentName = document.getElementById('nameSearch').value;
      currentEmail = document.getElementById('emailSearch').value;
      currentStartDate = document.getElementById('startDate').value;
      currentEndDate = document.getElementById('endDate').value;
      currentSubFilter = document.getElementById('subscriptionFilter').value;
      currentAccFilter = document.getElementById('accountFilter').value;
      fetchUsers();
    }
    
    // íšŒì› ëª©ë¡ ì¡°íšŒ
    async function fetchUsers(page = 1) {
      currentPage = page;
      
      try {
        const params = new URLSearchParams({
          page: currentPage,
          limit: 20,
          name: currentName,
          email: currentEmail,
          startDate: currentStartDate,
          endDate: currentEndDate,
          subscriptionStatus: currentSubFilter,
          accountStatus: currentAccFilter
        });
        
        const response = await fetch('/admin/api/users?' + params, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const data = await response.json();
        
        // ì´ íšŒì› ìˆ˜ í‘œì‹œ
        document.getElementById('userCount').textContent = 'íšŒì› ëª©ë¡ (ì´ ' + data.total + 'ëª…)';
        
        // í…Œì´ë¸” ë Œë”ë§
        const tbody = document.getElementById('usersTableBody');
        
        if (!data.users || data.users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="14" class="has-text-centered">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.users.map((user, index) => {
          const rowNumber = (currentPage - 1) * 20 + index + 1;
          
          const subscriptionTag = user.subscription 
            ? '<span class="tag ' + (user.subscription.status === 'active' ? 'is-success' : 'is-warning') + '">' + (user.subscription.status === 'active' ? 'í™œì„±' : 'ì·¨ì†Œë¨') + '</span>'
            : '<span class="tag is-light">ì—†ìŒ</span>';
          
          const accountTag = user.is_deleted 
            ? '<span class="tag is-danger">íƒˆí‡´</span>' 
            : (user.is_active ? '<span class="tag is-success">í™œì„±</span>' : '<span class="tag is-warning">ë¹„í™œì„±</span>');
          
          const currentPeriodStart = user.subscription?.current_period_start
            ? new Date(user.subscription.current_period_start).toLocaleDateString('ko-KR')
            : '-';
            
          const currentPeriodEnd = user.subscription?.current_period_end
            ? new Date(user.subscription.current_period_end).toLocaleDateString('ko-KR')
            : '-';
          
          // íƒˆí‡´ íšŒì›ì´ë‚˜ êµ¬ë… í•´ì§€ ì˜ˆì•½ íšŒì›ì€ ë‹¤ìŒ ê²°ì œì¼ í‘œì‹œ ì•ˆ í•¨
          let nextBillingDate = '-';
          if (user.subscription?.next_billing_at && 
              !user.is_deleted && 
              user.subscription.status === 'active' && 
              !user.subscription.cancel_at_period_end) {
            nextBillingDate = new Date(user.subscription.next_billing_at).toLocaleDateString('ko-KR');
          }
          
          // í”„ë¡œëª¨ì…˜ ì •ë³´ í‘œì‹œ (êµ¬ë…ì˜ í”„ë¡œëª¨ì…˜ ì •ë³´ ìš°ì„ )
          let promotionInfo = '-';
          if (user.subscription?.promotion_id) {
            // êµ¬ë…ì— í”„ë¡œëª¨ì…˜ì´ ì—°ê²°ëœ ê²½ìš°
            const expiresAt = user.subscription.promotion_expires_at 
              ? new Date(user.subscription.promotion_expires_at).toLocaleDateString('ko-KR')
              : 'ë¬´ê¸°í•œ';
            promotionInfo = 'í”„ë¡œëª¨ì…˜ ì ìš©ì¤‘ (~ ' + expiresAt + ')';
          } else if (user.active_promotions && user.active_promotions.length > 0) {
            // í™œì„± í”„ë¡œëª¨ì…˜ ëª©ë¡ í‘œì‹œ
            promotionInfo = user.active_promotions.map(p => {
              if (p.promotion_type === 'discount') {
                return p.discount_rate + '% í• ì¸';
              } else if (p.promotion_type === 'free') {
                return p.free_months + 'ê°œì›” ë¬´ë£Œ';
              }
              return p.promotion_type;
            }).join(', ');
          }
          
          const memoText = user.latest_memo || '-';
          const remarksText = user.latest_remarks || '-';
          
          return '<tr>'+
            '<td>' + rowNumber + '</td>'+
            '<td><a href="#" onclick="viewUserDetail(\'' + user.user_id + '\'); return false;" class="has-text-link">' + user.email + '</a></td>'+
            '<td>' + user.pharmacist_name + '</td>'+
            '<td>' + user.pharmacy_name + '</td>'+
            '<td>' + (user.pharmacist_phone || '-') + '</td>'+
            '<td>' + subscriptionTag + '</td>'+
            '<td>' + (user.subscription?.plan_name || '-') + '</td>'+
            '<td>' + currentPeriodStart + '</td>'+
            '<td>' + currentPeriodEnd + '</td>'+
            '<td>' + nextBillingDate + '</td>'+
            '<td style="font-size: 0.75rem;">' + promotionInfo + '</td>'+
            '<td style="font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 150px;" title="' + (user.latest_memo || 'ë©”ëª¨ ì—†ìŒ') + '">' + memoText + '</td>'+
            '<td style="font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 150px;" title="' + (user.latest_remarks || 'ë¹„ê³  ì—†ìŒ') + '">' + remarksText + '</td>'+
            '<td>' + accountTag + '</td>'+
          '</tr>';
        }).join('');
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
        renderPagination(data.page, data.totalPages);
        
      } catch (error) {
        console.error('íšŒì› ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
        document.getElementById('usersTableBody').innerHTML = 
          '<tr><td colspan="14" class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
      }
    }
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    function renderPagination(currentPage, totalPages) {
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      const pageNumbers = document.getElementById('pageNumbers');
      
      // ì´ì „/ë‹¤ìŒ ë²„íŠ¼
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
      
      prevBtn.onclick = () => currentPage > 1 && fetchUsers(currentPage - 1);
      nextBtn.onclick = () => currentPage < totalPages && fetchUsers(currentPage + 1);
      
      // í˜ì´ì§€ ë²ˆí˜¸
      let pages = [];
      const maxPages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
      let endPage = Math.min(totalPages, startPage + maxPages - 1);
      
      if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        pages.push(
          '<li>' +
            '<a class="pagination-link ' + (i === currentPage ? 'is-current' : '') + '" ' +
               'onclick="fetchUsers(' + i + ')">' + i + '</a>' +
          '</li>'
        );
      }
      
      pageNumbers.innerHTML = pages.join('');
    }
    
    // íšŒì› ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    let currentUserDetail = null;
    let currentActiveTab = 'basic'; // í˜„ì¬ í™œì„±í™”ëœ íƒ­ ì¶”ì 
    
    // íƒ­ ì „í™˜
    function switchTab(tabName) {
      currentActiveTab = tabName; // í˜„ì¬ íƒ­ ì €ì¥
      
      // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
      document.querySelectorAll('.tabs li').forEach(li => li.classList.remove('is-active'));
      document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
      
      // ì„ íƒí•œ íƒ­ í™œì„±í™”
      document.querySelector('.tabs li[data-tab="' + tabName + '"]').classList.add('is-active');
      document.getElementById('tab-' + tabName).style.display = 'block';
    }
    
    // íšŒì› ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ì—´ê¸°
    async function viewUserDetail(userId) {
      try {
        const response = await fetch('/admin/api/users/' + userId, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) throw new Error('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        
        const data = await response.json();
        currentUserDetail = data;
        
        // ëª¨ë‹¬ ì œëª©
        document.getElementById('modalUserName').textContent = data.user.pharmacist_name + ' (' + data.user.email + ')';
        
        // ê¸°ë³¸ ì •ë³´ íƒ­
        document.getElementById('detailPharmacyName').value = data.user.pharmacy_name;
        document.getElementById('detailCreatedAt').value = new Date(data.user.created_at).toLocaleString('ko-KR');
        
        // ì£¼ì†Œ ì¡°í•©
        const fullAddress = [
          data.user.postcode ? '[' + data.user.postcode + ']' : '',
          data.user.address || '',
          data.user.detail_address || ''
        ].filter(Boolean).join(' ');
        document.getElementById('detailAddress').value = fullAddress || '-';
        
        const accountStatusEl = document.getElementById('detailAccountStatus');
        if (data.user.is_deleted) {
          accountStatusEl.textContent = 'íƒˆí‡´';
          accountStatusEl.className = 'tag is-danger is-medium';
        } else if (data.user.is_active) {
          accountStatusEl.textContent = 'í™œì„±';
          accountStatusEl.className = 'tag is-success is-medium';
        } else {
          accountStatusEl.textContent = 'ë¹„í™œì„±';
          accountStatusEl.className = 'tag is-warning is-medium';
        }
        
        // ë©”ëª¨ ë°ì´í„° êµ¬ì¡° ë””ë²„ê¹…
        console.log('=== ë©”ëª¨ ë°ì´í„° í™•ì¸ ===');
        console.log('memos ë°°ì—´:', data.memos);
        if (data.memos && data.memos.length > 0) {
          console.log('ì²« ë²ˆì§¸ ë©”ëª¨:', data.memos[0]);
          console.log('ì²« ë²ˆì§¸ ë©”ëª¨ admins ê°ì²´:', data.memos[0].admins);
        }
        
        // ë©”ëª¨ ë‚´ì—­ ë Œë”ë§ (ê¸°ë³¸ ì •ë³´ íƒ­ì— í‘œì‹œ)
        renderMemos(data.memos);
        
        // êµ¬ë… ë‚´ì—­ íƒ­
        renderSubscriptions(data.subscriptions);
        
        // ê²°ì œ ë‚´ì—­ íƒ­
        renderPayments(data.payments);
        
        // í”„ë¡œëª¨ì…˜ íƒ­
        renderPromotions(data.promotions);
        
        // í™œë™ ë¡œê·¸ íƒ­
        renderActivityLogs(data.activity_logs);
        
        // ëª¨ë‹¬ í‘œì‹œ ë° ì´ì „ í™œì„± íƒ­ ë³µì›
        document.getElementById('userDetailModal').classList.add('is-active');
        
        // í˜„ì¬ í™œì„±í™”ëœ íƒ­ìœ¼ë¡œ ì „í™˜ (ê¸°ë³¸ê°’: basic)
        if (currentActiveTab && currentActiveTab !== 'basic') {
          switchTab(currentActiveTab);
        }
        
      } catch (error) {
        console.error('íšŒì› ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
        alert('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // ëª¨ë‹¬ ë‹«ê¸°
    function closeUserDetailModal() {
      document.getElementById('userDetailModal').classList.remove('is-active');
      currentUserDetail = null;
      currentActiveTab = 'basic'; // íƒ­ ìƒíƒœ ì´ˆê¸°í™”
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById('newMemoText').value = '';
      document.getElementById('newRemarksText').value = '';
      
      // ê¸°ë³¸ íƒ­ìœ¼ë¡œ ì „í™˜
      switchTab('basic');
    }
    
    // êµ¬ë… ë‚´ì—­ ë Œë”ë§
    function renderSubscriptions(subscriptions) {
      const container = document.getElementById('subscriptionList');
      
      if (!subscriptions || subscriptions.length === 0) {
        container.innerHTML = '<p class="has-text-centered has-text-grey">êµ¬ë… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      
      container.innerHTML = subscriptions.map((sub, index) => {
        const statusClass = sub.status === 'active' ? 'is-success' : 
                           sub.status === 'cancelled' ? 'is-warning' : 'is-light';
        const statusText = sub.status === 'active' ? 'í™œì„±' : 
                          sub.status === 'cancelled' ? 'ì·¨ì†Œë¨' : sub.status;
        
        return '<div class="box">' +
          '<div class="level">' +
            '<div class="level-left">' +
              '<div class="level-item">' +
                '<div>' +
                  '<p class="heading">í”Œëœ</p>' +
                  '<p class="title is-5">' + (sub.subscription_plans?.plan_name || 'N/A') + '</p>' +
                '</div>' +
              '</div>' +
              '<div class="level-item">' +
                '<div>' +
                  '<p class="heading">ê²°ì œ ì£¼ê¸°</p>' +
                  '<p class="subtitle">' + (sub.subscription_plans?.billing_period || 'N/A') + '</p>' +
                '</div>' +
              '</div>' +
              '<div class="level-item">' +
                '<div>' +
                  '<p class="heading">ê°€ê²©</p>' +
                  '<p class="subtitle">' + (sub.subscription_plans?.price ? sub.subscription_plans.price.toLocaleString() + 'ì›' : 'N/A') + '</p>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="level-right">' +
              '<div class="level-item">' +
                '<span class="tag ' + statusClass + ' is-medium">' + statusText + '</span>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="columns is-mobile">' +
            '<div class="column">' +
              '<p class="heading">êµ¬ë… ì‹œì‘</p>' +
              '<p>' + (sub.current_period_start ? new Date(sub.current_period_start).toLocaleDateString('ko-KR') : '-') + '</p>' +
            '</div>' +
            '<div class="column">' +
              '<p class="heading">êµ¬ë… ì¢…ë£Œ</p>' +
              '<p>' + (sub.current_period_end ? new Date(sub.current_period_end).toLocaleDateString('ko-KR') : '-') + '</p>' +
            '</div>' +
            '<div class="column">' +
              '<p class="heading">ë‹¤ìŒ ê²°ì œì¼</p>' +
              '<p>' + (sub.next_billing_at ? new Date(sub.next_billing_at).toLocaleDateString('ko-KR') : '-') + '</p>' +
            '</div>' +
            '<div class="column">' +
              '<p class="heading">ìƒì„±ì¼</p>' +
              '<p>' + new Date(sub.created_at).toLocaleDateString('ko-KR') + '</p>' +
            '</div>' +
          '</div>' +
          (sub.cancelled_at ? '<p class="has-text-danger"><i class="fas fa-exclamation-triangle"></i> ì·¨ì†Œì¼: ' + new Date(sub.cancelled_at).toLocaleString('ko-KR') + '</p>' : '') +
        '</div>';
      }).join('');
    }
    
    // ê²°ì œ ë‚´ì—­ ë Œë”ë§
    function renderPayments(payments) {
      const tbody = document.getElementById('paymentList');
      
      if (!payments || payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="has-text-centered has-text-grey">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      tbody.innerHTML = payments.map(payment => {
        const statusClass = payment.status === 'success' ? 'is-success' : 
                           payment.status === 'failed' ? 'is-danger' : 'is-warning';
        const statusText = payment.status === 'success' ? 'ì„±ê³µ' : 
                          payment.status === 'failed' ? 'ì‹¤íŒ¨' : payment.status;
        
        return '<tr>' +
          '<td>' + new Date(payment.payment_date).toLocaleString('ko-KR') + '</td>' +
          '<td><strong>' + payment.amount.toLocaleString() + 'ì›</strong></td>' +
          '<td>' + (payment.payment_method || '-') + '</td>' +
          '<td><span class="tag ' + statusClass + '">' + statusText + '</span></td>' +
          '<td style="font-size: 0.75rem;">' + (payment.toss_order_id || '-') + '</td>' +
          '<td style="font-size: 0.75rem; color: #f14668;">' + (payment.failure_message || '-') + '</td>' +
        '</tr>';
      }).join('');
    }
    
    // í”„ë¡œëª¨ì…˜ ë Œë”ë§
    function renderPromotions(promotions) {
      const tbody = document.getElementById('promotionList');
      
      if (!promotions || promotions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="has-text-centered has-text-grey">í”„ë¡œëª¨ì…˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      tbody.innerHTML = promotions.map(promo => {
        const typeText = promo.promotion_type === 'discount' ? 'í• ì¸' : 
                        promo.promotion_type === 'free' ? 'ë¬´ë£Œ' : promo.promotion_type;
        const statusClass = promo.is_active ? 'is-success' : 'is-light';
        const statusText = promo.is_active ? 'í™œì„±' : 'ë§Œë£Œ';
        
        return '<tr>' +
          '<td>' + typeText + '</td>' +
          '<td>' + (promo.discount_rate ? promo.discount_rate + '%' : '-') + '</td>' +
          '<td>' + (promo.free_months ? promo.free_months + 'ê°œì›”' : '-') + '</td>' +
          '<td>' + (promo.start_date ? new Date(promo.start_date).toLocaleDateString('ko-KR') : '-') + '</td>' +
          '<td>' + (promo.expires_at ? new Date(promo.expires_at).toLocaleDateString('ko-KR') : '-') + '</td>' +
          '<td><span class="tag ' + statusClass + '">' + statusText + '</span></td>' +
        '</tr>';
      }).join('');
    }
    
    // ë©”ëª¨/ë¹„ê³  ë Œë”ë§
    function renderMemos(memos) {
      const container = document.getElementById('memoList');
      
      if (!memos || memos.length === 0) {
        container.innerHTML = '<p class="has-text-centered has-text-grey">ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      
      container.innerHTML = '<div class="table-container"><table class="table is-fullwidth is-striped is-hoverable">' +
        '<thead>' +
          '<tr>' +
            '<th>ì‘ì„±ì</th>' +
            '<th>ì‘ì„±ì¼</th>' +
            '<th>ë¹„ê³ </th>' +
            '<th>ë©”ëª¨</th>' +
          '</tr>' +
        '</thead>' +
        '<tbody>' +
          memos.map(memo => {
            const adminEmail = memo.admin_email || 'ì•Œ ìˆ˜ ì—†ìŒ';
            const remarksText = memo.remarks && memo.remarks.trim() ? memo.remarks : '<span class="has-text-grey-light">(ë¹ˆì¹¸)</span>';
            const memoText = memo.memo && memo.memo.trim() ? memo.memo : '<span class="has-text-grey-light">(ë¹ˆì¹¸)</span>';
            
            return '<tr>' +
              '<td>' + adminEmail + '</td>' +
              '<td>' + new Date(memo.created_at).toLocaleString('ko-KR') + '</td>' +
              '<td>' + remarksText + '</td>' +
              '<td>' + memoText + '</td>' +
            '</tr>';
          }).join('') +
        '</tbody>' +
      '</table></div>';
    }
    
    // í™œë™ ë¡œê·¸ ë Œë”ë§
    function renderActivityLogs(logs) {
      const tbody = document.getElementById('activityList');
      
      if (!logs || logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="has-text-centered has-text-grey">í™œë™ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      tbody.innerHTML = logs.map(log => {
        const adminName = log.admins?.admin_name || 'ì‹œìŠ¤í…œ';
        const detailsText = log.details ? JSON.stringify(log.details) : '-';
        
        return '<tr>' +
          '<td>' + new Date(log.created_at).toLocaleString('ko-KR') + '</td>' +
          '<td>' + log.action_type + '</td>' +
          '<td>' + adminName + '</td>' +
          '<td style="font-size: 0.75rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis;" title="' + detailsText + '">' + detailsText + '</td>' +
        '</tr>';
      }).join('');
    }
    
    // ìƒˆ ë©”ëª¨ ì €ì¥
    async function saveNewMemo() {
      if (!currentUserDetail) return;
      
      const memoText = document.getElementById('newMemoText').value.trim();
      const remarksText = document.getElementById('newRemarksText').value.trim();
      
      if (!memoText && !remarksText) {
        alert('ë©”ëª¨ ë˜ëŠ” ë¹„ê³ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const response = await fetch('/admin/api/users/' + currentUserDetail.user.user_id + '/memos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          },
          body: JSON.stringify({
            memo: memoText,
            remarks: remarksText
          })
        });
        
        if (!response.ok) throw new Error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨');
        
        alert('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('newMemoText').value = '';
        document.getElementById('newRemarksText').value = '';
        
        // ìƒì„¸ ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
        viewUserDetail(currentUserDetail.user.user_id);
        
      } catch (error) {
        console.error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨:', error);
        alert('ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // íšŒì› ë¹„ê³  ì—…ë°ì´íŠ¸ (admin_user_memos.remarks ì‚¬ìš©) - íšŒì› ëª©ë¡ì—ì„œëŠ” ë” ì´ìƒ ì‚¬ìš© ì•ˆ í•¨
    // ìƒì„¸ í˜ì´ì§€ì—ì„œ ë©”ëª¨/ë¹„ê³  ì‘ì„± ì‚¬ìš©
    async function updateUserRemarks(userId, remarksText) {
      try {
        const response = await fetch('/admin/api/users/' + userId + '/memos', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token'),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ remarks: remarksText })
        });
        
        if (!response.ok) {
          throw new Error('ë¹„ê³  ì €ì¥ ì‹¤íŒ¨');
        }
        
        const result = await response.json();
        console.log('ë¹„ê³ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤:', result);
      } catch (error) {
        console.error('ë¹„ê³  ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ë¹„ê³  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë¡œê·¸ì•„ì›ƒ
    async function logout() {
      if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      // ë¡œë”© í‘œì‹œ
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë¡œê·¸ì•„ì›ƒ ì¤‘...';
        logoutBtn.style.pointerEvents = 'none';
      }
      
      try {
        // ë¡œê·¸ì•„ì›ƒ í™œë™ ë¡œê·¸ ê¸°ë¡
        await fetch('/admin/api/logout', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('admin_session_token')}`,
            'Content-Type': 'application/json'
          }
        });
      } catch (error) {
        console.error('ë¡œê·¸ì•„ì›ƒ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:', error);
      }
      
      // í† í° ì‚­ì œ (localStorage)
      localStorage.removeItem('admin_session_token');
      
      // í† í° ì‚­ì œ (ì¿ í‚¤ - ëª¨ë“  ê²½ë¡œì™€ ë„ë©”ì¸ ì¡°í•©)
      const cookiesToDelete = [
        'admin_session_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
        'admin_session_token=; path=/admin; expires=Thu, 01 Jan 1970 00:00:00 GMT',
        'admin_session_token=; domain=localhost; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
        'admin_session_token=; domain=.localhost; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
        'admin_session_token=; domain=' + window.location.hostname + '; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
      ];
      
      cookiesToDelete.forEach(cookie => {
        document.cookie = cookie;
      });
      
      // ì™„ì „íˆ ì‚­ì œë˜ì—ˆëŠ”ì§€ í™•ì¸
      console.log('ë¡œê·¸ì•„ì›ƒ í›„ ì¿ í‚¤:', document.cookie);
      
      // /adminìœ¼ë¡œ ì´ë™ (ë¡œê·¸ì¸ í˜ì´ì§€ ìë™ ë¡œë“œ)
      window.location.href = '/admin';
    }

    // ì´ˆê¸°í™” - ì¦‰ì‹œ ì‹¤í–‰
    
    // Auth ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ (OAuth ì½œë°± ì²˜ë¦¬)
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
      
      if (event === 'INITIAL_SESSION') {
        // OAuth ì½œë°± ì²˜ë¦¬ (URL í•´ì‹œ í™•ì¸)
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        
        if (hashParams.has('access_token')) {
          
          const accessToken = hashParams.get('access_token');
          const refreshToken = hashParams.get('refresh_token');
          
          // URL í•´ì‹œ ì œê±° (ë³´ì•ˆ)
          history.replaceState(null, '', window.location.pathname);
          
          // ì„¸ì…˜ ìˆ˜ë™ ì„¤ì •
          if (accessToken && refreshToken) {
            const { data, error } = await supabaseClient.auth.setSession({
              access_token: accessToken,
              refresh_token: refreshToken
            });
            
            if (error) {
              window.location.href = '/admin/login';
            } else {
              localStorage.setItem('admin_session_token', accessToken);
              
              // ë°ì´í„° ë¡œë“œ
              loadAdminInfo();
              loadDashboardStats();
              loadRecentActivities();
            }
            return; // ì—¬ê¸°ì„œ ì¢…ë£Œ
          }
        }
        
        // ì¼ë°˜ì ì¸ ì„¸ì…˜ í™•ì¸ (ê¸°ì¡´ ì„¸ì…˜ ë³µì›)
        if (session) {
          localStorage.setItem('admin_session_token', session.access_token);
          loadAdminInfo();
          loadDashboardStats();
          loadRecentActivities();
        } else {
          window.location.href = '/admin/login';
        }
      } else if (event === 'SIGNED_IN' && session) {
        localStorage.setItem('admin_session_token', session.access_token);
        // OAuth ì½œë°±ìœ¼ë¡œ ë¡œê·¸ì¸ëœ ê²½ìš° ë°ì´í„° ë¡œë“œ
        loadAdminInfo();
        loadDashboardStats();
        loadRecentActivities();
      } else if (event === 'SIGNED_OUT') {
        localStorage.removeItem('admin_session_token');
        window.location.href = '/admin/login';
      }
    });
    
    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    window.addEventListener('load', function() {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
      }
    });

    // ==================== êµ¬ë… í˜„í™© í˜ì´ì§€ ====================
    async function loadSubscriptionsPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = '<h1 class="title">êµ¬ë… í˜„í™©</h1>' +
        '<div class="box">' +
          '<div class="columns is-multiline">' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì•½êµ­ëª…</label>' +
                '<div class="control">' +
                  '<input class="input" type="text" id="subscriptionPharmacyName" placeholder="ì•½êµ­ëª…">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì•½ì‚¬ëª…</label>' +
                '<div class="control">' +
                  '<input class="input" type="text" id="subscriptionPharmacistName" placeholder="ì•½ì‚¬ëª…">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì‹œì‘ì¼</label>' +
                '<div class="control">' +
                  '<input class="input" type="date" id="subscriptionStartDate">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì¢…ë£Œì¼</label>' +
                '<div class="control">' +
                  '<input class="input" type="date" id="subscriptionEndDate">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">êµ¬ë… ìƒíƒœ</label>' +
                '<div class="control">' +
                  '<div class="select is-fullwidth">' +
                    '<select id="subscriptionStatusFilter">' +
                      '<option value="">ì „ì²´</option>' +
                      '<option value="active">í™œì„±</option>' +
                      '<option value="cancelled">ì·¨ì†Œë¨</option>' +
                      '<option value="expired">ë§Œë£Œë¨</option>' +
                    '</select>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-1">' +
              '<div class="field">' +
                '<label class="label">&nbsp;</label>' +
                '<div class="control">' +
                  '<button class="button is-primary is-fullwidth" onclick="searchSubscriptions()">' +
                    '<i class="fas fa-search"></i>' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-1">' +
              '<div class="field">' +
                '<label class="label">&nbsp;</label>' +
                '<div class="control">' +
                  '<button class="button is-light is-fullwidth" onclick="clearSubscriptionFilters()">' +
                    '<i class="fas fa-redo"></i>' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="box">' +
          '<div class="table-container">' +
            '<table class="table is-fullwidth is-striped is-hoverable">' +
              '<thead>' +
                '<tr>' +
                  '<th style="width: 60px;">No.</th>' +
                  '<th>ì•½êµ­ëª…</th>' +
                  '<th>ì•½ì‚¬ëª…</th>' +
                  '<th>ì´ë©”ì¼</th>' +
                  '<th>í”Œëœ</th>' +
                  '<th>ê²°ì œ ì£¼ê¸°</th>' +
                  '<th>ìƒíƒœ</th>' +
                  '<th>ì²« ê²°ì œì¼</th>' +
                  '<th>ì‹œì‘ì¼</th>' +
                  '<th>ì¢…ë£Œì¼</th>' +
                  '<th>ë‹¤ìŒ ê²°ì œì¼</th>' +
                  '<th>ê²°ì œê¸ˆì•¡</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody id="subscriptionTableBody">' +
                '<tr>' +
                  '<td colspan="12" class="has-text-centered">' +
                    '<i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...' +
                  '</td>' +
                '</tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
          '<nav class="pagination is-centered" role="navigation" id="subscriptionPagination">' +
          '</nav>' +
        '</div>';
      
      // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
      searchSubscriptions();
    }

    let currentSubscriptionPage = 1;
    const subscriptionPageSize = 20;

    async function searchSubscriptions(page = 1) {
      currentSubscriptionPage = page;
      
      const startDate = document.getElementById('subscriptionStartDate')?.value || '';
      const endDate = document.getElementById('subscriptionEndDate')?.value || '';
      const status = document.getElementById('subscriptionStatusFilter')?.value || '';
      const pharmacyName = document.getElementById('subscriptionPharmacyName')?.value || '';
      const pharmacistName = document.getElementById('subscriptionPharmacistName')?.value || '';
      
      const tbody = document.getElementById('subscriptionTableBody');
      tbody.innerHTML = '<tr><td colspan="12" class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</td></tr>';
      
      try {
        const params = new URLSearchParams({
          page: page,
          limit: subscriptionPageSize,
          startDate: startDate,
          endDate: endDate,
          status: status,
          pharmacyName: pharmacyName,
          pharmacistName: pharmacistName
        });
        
        const response = await fetch('/admin/api/subscriptions?' + params.toString(), {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/admin/login';
            return;
          }
          throw new Error('êµ¬ë… ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        renderSubscriptions(data);
      } catch (error) {
        console.error('êµ¬ë… ì¡°íšŒ ì˜¤ë¥˜:', error);
        tbody.innerHTML = '<tr><td colspan="12" class="has-text-centered has-text-danger">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    function renderSubscriptions(data) {
      const tbody = document.getElementById('subscriptionTableBody');
      
      if (!data.subscriptions || data.subscriptions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="has-text-centered">êµ¬ë… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      // ì¸ë±ìŠ¤ ê³„ì‚° (ìµœê·¼ì´ 1ë²ˆ)
      const startIndex = (currentSubscriptionPage - 1) * subscriptionPageSize;
      
      tbody.innerHTML = data.subscriptions.map((sub, idx) => {
        const index = startIndex + idx + 1;
        
        // ìƒíƒœ í‘œì‹œ ë¡œì§
        let statusTag, statusText;
        if (sub.cancel_at_period_end) {
          // í•´ì§€ ì˜ˆì•½ëœ ê²½ìš°
          statusTag = 'is-warning';
          statusText = 'í•´ì§€ ì˜ˆì•½ë¨';
        } else if (sub.status === 'active') {
          statusTag = 'is-success';
          statusText = 'í™œì„±';
        } else if (sub.status === 'cancelled') {
          statusTag = 'is-danger';
          statusText = 'ì·¨ì†Œë¨';
        } else {
          statusTag = 'is-danger';
          statusText = 'ë§Œë£Œë¨';
        }
        
        // ë‹¤ìŒ ê²°ì œì¼ í‘œì‹œ ë¡œì§
        let nextBillingText;
        if (sub.cancel_at_period_end) {
          // í•´ì§€ ì˜ˆì•½ëœ ê²½ìš°
          nextBillingText = '<span class="has-text-danger">í•´ì§€ ì˜ˆì • - ê²°ì œ ì•ˆ ë¨</span>';
        } else if (sub.status === 'cancelled') {
          // ì´ë¯¸ ì·¨ì†Œëœ ê²½ìš°
          nextBillingText = '<span class="has-text-grey">íƒˆí‡´ ì™„ë£Œ - ê²°ì œ ì•ˆ ë¨</span>';
        } else if (sub.next_billing_at) {
          // ì •ìƒ í™œì„± êµ¬ë…
          nextBillingText = new Date(sub.next_billing_at).toLocaleDateString('ko-KR');
        } else {
          nextBillingText = '-';
        }
        
        return '<tr>' +
          '<td>' + index + '</td>' +
          '<td>' + (sub.pharmacy_name || '-') + '</td>' +
          '<td>' + (sub.pharmacist_name || '-') + '</td>' +
          '<td>' + (sub.email || '-') + '</td>' +
          '<td>' + (sub.plan_name || '-') + '</td>' +
          '<td>ì›”ê°„</td>' +
          '<td><span class="tag ' + statusTag + '">' + statusText + '</span></td>' +
          '<td>' + (sub.created_at ? new Date(sub.created_at).toLocaleDateString('ko-KR') : '-') + '</td>' +
          '<td>' + (sub.current_period_start ? new Date(sub.current_period_start).toLocaleDateString('ko-KR') : '-') + '</td>' +
          '<td>' + (sub.current_period_end ? new Date(sub.current_period_end).toLocaleDateString('ko-KR') : '-') + '</td>' +
          '<td>' + nextBillingText + '</td>' +
          '<td>' + (sub.payment_amount ? sub.payment_amount.toLocaleString() + 'ì›' : '0ì›') + '</td>' +
        '</tr>';
      }).join('');
      
      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      renderSubscriptionPagination(data.total, data.page, data.totalPages);
    }

    function renderSubscriptionPagination(total, currentPage, totalPages) {
      const pagination = document.getElementById('subscriptionPagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = '<a class="pagination-previous" ' + (currentPage === 1 ? 'disabled' : 'onclick="searchSubscriptions(' + (currentPage - 1) + ')"') + '>ì´ì „</a>';
      html += '<a class="pagination-next" ' + (currentPage === totalPages ? 'disabled' : 'onclick="searchSubscriptions(' + (currentPage + 1) + ')"') + '>ë‹¤ìŒ</a>';
      html += '<ul class="pagination-list">';
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += '<li><a class="pagination-link ' + (i === currentPage ? 'is-current' : '') + '" onclick="searchSubscriptions(' + i + ')">' + i + '</a></li>';
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<li><span class="pagination-ellipsis">&hellip;</span></li>';
        }
      }
      
      html += '</ul>';
      pagination.innerHTML = html;
    }

    function clearSubscriptionFilters() {
      document.getElementById('subscriptionStartDate').value = '';
      document.getElementById('subscriptionEndDate').value = '';
      document.getElementById('subscriptionStatusFilter').value = '';
      document.getElementById('subscriptionPharmacyName').value = '';
      document.getElementById('subscriptionPharmacistName').value = '';
      searchSubscriptions(1);
    }

    // ==================== ê²°ì œ ë‚´ì—­ í˜ì´ì§€ ====================
    async function loadPaymentsPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = '<h1 class="title">ê²°ì œ ë‚´ì—­</h1>' +
        '<div class="box">' +
          '<div class="columns is-multiline">' +
            '<div class="column is-3">' +
              '<div class="field">' +
                '<label class="label">ì•½êµ­ëª…</label>' +
                '<div class="control">' +
                  '<input class="input" type="text" id="paymentPharmacyName" placeholder="ì•½êµ­ëª… ê²€ìƒ‰">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-3">' +
              '<div class="field">' +
                '<label class="label">ì•½ì‚¬ëª…</label>' +
                '<div class="control">' +
                  '<input class="input" type="text" id="paymentPharmacistName" placeholder="ì•½ì‚¬ëª… ê²€ìƒ‰">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ê²°ì œ ìƒíƒœ</label>' +
                '<div class="control">' +
                  '<div class="select is-fullwidth">' +
                    '<select id="paymentStatusFilter">' +
                      '<option value="">ì „ì²´</option>' +
                      '<option value="success">ì„±ê³µ</option>' +
                      '<option value="failed">ì‹¤íŒ¨</option>' +
                      '<option value="canceled">ì·¨ì†Œ</option>' +
                    '</select>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì‹œì‘ì¼</label>' +
                '<div class="control">' +
                  '<input class="input" type="date" id="paymentStartDate">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì¢…ë£Œì¼</label>' +
                '<div class="control">' +
                  '<input class="input" type="date" id="paymentEndDate">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2 is-offset-8">' +
              '<div class="field">' +
                '<div class="control">' +
                  '<button class="button is-primary is-fullwidth" onclick="searchPayments()">' +
                    '<i class="fas fa-search"></i>&nbsp; ê²€ìƒ‰' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<div class="control">' +
                  '<button class="button is-light is-fullwidth" onclick="clearPaymentFilters()">' +
                    '<i class="fas fa-redo"></i>&nbsp; ì´ˆê¸°í™”' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="box">' +
          '<div class="table-container">' +
            '<table class="table is-fullwidth is-striped is-hoverable">' +
              '<thead>' +
                '<tr>' +
                  '<th style="width: 60px;">No.</th>' +
                  '<th>ì•½êµ­ëª…</th>' +
                  '<th>ì•½ì‚¬ëª…</th>' +
                  '<th>ì´ë©”ì¼</th>' +
                  '<th>ì£¼ë¬¸ë²ˆí˜¸</th>' +
                  '<th>ê²°ì œê¸ˆì•¡</th>' +
                  '<th>ê²°ì œìƒíƒœ</th>' +
                  '<th>ìš”ì²­ì¼ì‹œ</th>' +
                  '<th>ìŠ¹ì¸ì¼ì‹œ</th>' +
                  '<th>ì‹¤íŒ¨ì‚¬ìœ </th>' +
                '</tr>' +
              '</thead>' +
              '<tbody id="paymentTableBody">' +
                '<tr>' +
                  '<td colspan="10" class="has-text-centered">' +
                    '<i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...' +
                  '</td>' +
                '</tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
          '<nav class="pagination is-centered" role="navigation" id="paymentPagination">' +
          '</nav>' +
        '</div>';
      
      // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
      searchPayments();
    }

    let currentPaymentPage = 1;
    const paymentPageSize = 20;

    async function searchPayments(page = 1) {
      currentPaymentPage = page;
      
      const startDate = document.getElementById('paymentStartDate')?.value || '';
      const endDate = document.getElementById('paymentEndDate')?.value || '';
      const status = document.getElementById('paymentStatusFilter')?.value || '';
      const pharmacyName = document.getElementById('paymentPharmacyName')?.value?.trim() || '';
      const pharmacistName = document.getElementById('paymentPharmacistName')?.value?.trim() || '';
      
      const tbody = document.getElementById('paymentTableBody');
      tbody.innerHTML = '<tr><td colspan="10" class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</td></tr>';
      
      try {
        const params = new URLSearchParams({
          page: page,
          limit: paymentPageSize,
          startDate: startDate,
          endDate: endDate,
          status: status,
          pharmacyName: pharmacyName,
          pharmacistName: pharmacistName
        });
        
        const response = await fetch('/admin/api/payments?' + params.toString(), {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/admin/login';
            return;
          }
          throw new Error('ê²°ì œ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        renderPayments(data);
      } catch (error) {
        console.error('ê²°ì œ ë‚´ì—­ ì¡°íšŒ ì˜¤ë¥˜:', error);
        tbody.innerHTML = '<tr><td colspan="10" class="has-text-centered has-text-danger">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    function renderPayments(data) {
      const tbody = document.getElementById('paymentTableBody');
      
      if (!data.payments || data.payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="has-text-centered">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      // ì¸ë±ìŠ¤ ê³„ì‚° (ìµœê·¼ì´ 1ë²ˆ)
      const startIndex = (currentPaymentPage - 1) * paymentPageSize;
      
      tbody.innerHTML = data.payments.map((payment, idx) => {
        const index = startIndex + idx + 1;
        
        // amountê°€ null/undefinedì¸ ê²½ìš°ë§Œ ë””ë²„ê¹… ë¡œê·¸ (0ì›ì€ ë¬´ë£Œ í”„ë¡œëª¨ì…˜ì´ë¯€ë¡œ ì •ìƒ)
        if ((payment.amount === null || payment.amount === undefined) && payment.status === 'success') {
          console.warn('ê¸ˆì•¡ ëˆ„ë½ ê²°ì œ ë°œê²¬:', {
            payment_id: payment.payment_id,
            order_id: payment.order_id,
            amount: payment.amount,
            status: payment.status,
            pharmacy_name: payment.pharmacy_name,
            email: payment.email
          });
        }
        
        // ê²°ì œ ìƒíƒœ í‘œì‹œ
        let statusTag, statusText;
        if (payment.status === 'success') {
          statusTag = 'is-success';
          statusText = 'ì„±ê³µ';
        } else if (payment.status === 'failed') {
          statusTag = 'is-danger';
          statusText = 'ì‹¤íŒ¨';
        } else if (payment.status === 'canceled') {
          statusTag = 'is-warning';
          statusText = 'ì·¨ì†Œ';
        } else {
          statusTag = 'is-light';
          statusText = payment.status || '-';
        }
        
        // ê¸ˆì•¡ í‘œì‹œ (0ì›ì€ "0ì› (ë¬´ë£Œ)" í‘œì‹œ)
        let amountDisplay = '-';
        if (payment.amount !== null && payment.amount !== undefined) {
          if (payment.amount === 0) {
            amountDisplay = '0ì› (ë¬´ë£Œ)';
          } else {
            amountDisplay = payment.amount.toLocaleString() + 'ì›';
          }
        }
        
        return '<tr>' +
          '<td>' + index + '</td>' +
          '<td>' + (payment.pharmacy_name || '-') + '</td>' +
          '<td>' + (payment.pharmacist_name || '-') + '</td>' +
          '<td>' + (payment.email || '-') + '</td>' +
          '<td>' + (payment.order_id || '-') + '</td>' +
          '<td>' + amountDisplay + '</td>' +
          '<td><span class="tag ' + statusTag + '">' + statusText + '</span></td>' +
          '<td>' + (payment.requested_at ? new Date(payment.requested_at).toLocaleString('ko-KR') : '-') + '</td>' +
          '<td>' + (payment.approved_at ? new Date(payment.approved_at).toLocaleString('ko-KR') : '-') + '</td>' +
          '<td>' + (payment.fail_reason || '-') + '</td>' +
        '</tr>';
      }).join('');
      
      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      renderPaymentPagination(data.total, data.page, data.totalPages);
    }

    function renderPaymentPagination(total, currentPage, totalPages) {
      const pagination = document.getElementById('paymentPagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = '<a class="pagination-previous" ' + (currentPage === 1 ? 'disabled' : 'onclick="searchPayments(' + (currentPage - 1) + ')"') + '>ì´ì „</a>';
      html += '<a class="pagination-next" ' + (currentPage === totalPages ? 'disabled' : 'onclick="searchPayments(' + (currentPage + 1) + ')"') + '>ë‹¤ìŒ</a>';
      html += '<ul class="pagination-list">';
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += '<li><a class="pagination-link ' + (i === currentPage ? 'is-current' : '') + '" onclick="searchPayments(' + i + ')">' + i + '</a></li>';
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<li><span class="pagination-ellipsis">&hellip;</span></li>';
        }
      }
      
      html += '</ul>';
      pagination.innerHTML = html;
    }

    function clearPaymentFilters() {
      document.getElementById('paymentStartDate').value = '';
      document.getElementById('paymentEndDate').value = '';
      document.getElementById('paymentStatusFilter').value = '';
      document.getElementById('paymentPharmacyName').value = '';
      document.getElementById('paymentPharmacistName').value = '';
      searchPayments(1);
    }

    // ==================== ë¬¸ì˜ ê´€ë¦¬ í˜ì´ì§€ ====================
    async function loadSupportTicketsPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = '<h1 class="title">ë¬¸ì˜ ê´€ë¦¬</h1>' +
        '<div class="box">' +
          '<div class="columns">' +
            '<div class="column is-3">' +
              '<div class="field">' +
                '<label class="label">ë‹µë³€ ìƒíƒœ</label>' +
                '<div class="control">' +
                  '<div class="select is-fullwidth">' +
                    '<select id="ticketStatusFilter">' +
                      '<option value="">ì „ì²´</option>' +
                      '<option value="open">ë¯¸ë‹µë³€</option>' +
                      '<option value="answered">ë‹µë³€ì™„ë£Œ</option>' +
                      '<option value="closed">ì¢…ë£Œ</option>' +
                    '</select>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">&nbsp;</label>' +
                '<div class="control">' +
                  '<button class="button is-primary is-fullwidth" onclick="searchTickets()">' +
                    '<i class="fas fa-search"></i>&nbsp; ê²€ìƒ‰' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">&nbsp;</label>' +
                '<div class="control">' +
                  '<button class="button is-light is-fullwidth" onclick="clearTicketFilters()">' +
                    '<i class="fas fa-redo"></i>&nbsp; ì´ˆê¸°í™”' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="box">' +
          '<div class="table-container">' +
            '<table class="table is-fullwidth is-striped is-hoverable">' +
              '<thead>' +
                '<tr>' +
                  '<th style="width: 60px;">No.</th>' +
                  '<th>ì œëª©</th>' +
                  '<th>ì•½êµ­ëª…</th>' +
                  '<th>ì•½ì‚¬ëª…</th>' +
                  '<th>ì´ë©”ì¼</th>' +
                  '<th>ë‹µë³€ ìƒíƒœ</th>' +
                  '<th>ìƒì„±ì¼ì‹œ</th>' +
                  '<th>ìƒì„¸ë³´ê¸°</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody id="ticketTableBody">' +
                '<tr>' +
                  '<td colspan="8" class="has-text-centered">' +
                    '<i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...' +
                  '</td>' +
                '</tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
          '<nav class="pagination is-centered" role="navigation" id="ticketPagination">' +
          '</nav>' +
        '</div>' +
        '<div id="ticketDetailModal" class="modal">' +
          '<div class="modal-background" onclick="closeTicketDetail()"></div>' +
          '<div class="modal-card" style="width: 800px;">' +
            '<header class="modal-card-head">' +
              '<p class="modal-card-title">ë¬¸ì˜ ìƒì„¸</p>' +
              '<button class="delete" onclick="closeTicketDetail()"></button>' +
            '</header>' +
            '<section class="modal-card-body" id="ticketDetailContent">' +
              '<p class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</p>' +
            '</section>' +
          '</div>' +
        '</div>';
      
      // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
      searchTickets();
    }

    let currentTicketPage = 1;
    const ticketPageSize = 20;

    async function searchTickets(page = 1) {
      currentTicketPage = page;
      
      const status = document.getElementById('ticketStatusFilter')?.value || '';
      
      const tbody = document.getElementById('ticketTableBody');
      tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</td></tr>';
      
      try {
        const params = new URLSearchParams({
          page: page,
          limit: ticketPageSize,
          status: status
        });
        
        const response = await fetch('/admin/api/support-tickets?' + params.toString(), {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/admin/login';
            return;
          }
          throw new Error('ë¬¸ì˜ ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        renderTickets(data);
      } catch (error) {
        console.error('ë¬¸ì˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered has-text-danger">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    function renderTickets(data) {
      const tbody = document.getElementById('ticketTableBody');
      
      if (!data.tickets || data.tickets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered">ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      const startIndex = (currentTicketPage - 1) * ticketPageSize;
      
      tbody.innerHTML = data.tickets.map((ticket, idx) => {
        const index = startIndex + idx + 1;
        
        let statusTag, statusText;
        if (ticket.status === 'open') {
          statusTag = 'is-danger';
          statusText = 'ë¯¸ë‹µë³€';
        } else if (ticket.status === 'answered') {
          statusTag = 'is-success';
          statusText = 'ë‹µë³€ì™„ë£Œ';
        } else if (ticket.status === 'closed') {
          statusTag = 'is-light';
          statusText = 'ì¢…ë£Œ';
        } else {
          statusTag = 'is-light';
          statusText = ticket.status || '-';
        }
        
        return '<tr>' +
          '<td>' + index + '</td>' +
          '<td><a href="#" onclick="loadTicketDetailPage(\'' + ticket.ticket_id + '\'); return false;" style="color: #3273dc; text-decoration: underline;">' + (ticket.title || '-') + '</a></td>' +
          '<td>' + (ticket.pharmacy_name || '-') + '</td>' +
          '<td>' + (ticket.pharmacist_name || '-') + '</td>' +
          '<td>' + (ticket.email || '-') + '</td>' +
          '<td><span class="tag ' + statusTag + '">' + statusText + '</span></td>' +
          '<td>' + (ticket.created_at ? new Date(ticket.created_at).toLocaleString('ko-KR') : '-') + '</td>' +
          '<td><button class="button is-small is-info" onclick="loadTicketDetailPage(\'' + ticket.ticket_id + '\')">ìƒì„¸ë³´ê¸°</button></td>' +
        '</tr>';
      }).join('');
      
      renderTicketPagination(data.total, data.page, data.totalPages);
    }

    function renderTicketPagination(total, currentPage, totalPages) {
      const pagination = document.getElementById('ticketPagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = '<a class="pagination-previous" ' + (currentPage === 1 ? 'disabled' : 'onclick="searchTickets(' + (currentPage - 1) + ')"') + '>ì´ì „</a>';
      html += '<a class="pagination-next" ' + (currentPage === totalPages ? 'disabled' : 'onclick="searchTickets(' + (currentPage + 1) + ')"') + '>ë‹¤ìŒ</a>';
      html += '<ul class="pagination-list">';
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += '<li><a class="pagination-link ' + (i === currentPage ? 'is-current' : '') + '" onclick="searchTickets(' + i + ')">' + i + '</a></li>';
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<li><span class="pagination-ellipsis">&hellip;</span></li>';
        }
      }
      
      html += '</ul>';
      pagination.innerHTML = html;
    }

    function clearTicketFilters() {
      document.getElementById('ticketStatusFilter').value = '';
      searchTickets(1);
    }

    async function viewTicketDetail(ticketId) {
      const modal = document.getElementById('ticketDetailModal');
      const content = document.getElementById('ticketDetailContent');
      
      modal.classList.add('is-active');
      content.innerHTML = '<p class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</p>';
      
      try {
        const response = await fetch('/admin/api/support-tickets/' + ticketId, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          throw new Error('ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        const ticket = data.ticket;
        const attachments = data.attachments || [];
        
        let attachmentHTML = '';
        if (attachments.length > 0) {
          attachmentHTML = '<div class="field"><label class="label">ì²¨ë¶€íŒŒì¼</label><div class="content">';
          attachments.forEach(att => {
            attachmentHTML += '<p><a href="' + att.file_path + '" target="_blank"><i class="fas fa-paperclip"></i> ' + att.file_name + ' (' + (att.file_size / 1024).toFixed(2) + ' KB)</a></p>';
          });
          attachmentHTML += '</div></div>';
        }
        
        content.innerHTML = 
          '<div class="field"><label class="label">ì œëª©</label><p class="control"><input class="input" type="text" value="' + (ticket.title || '') + '" readonly></p></div>' +
          '<div class="field"><label class="label">ì‘ì„±ì</label><p>' + (ticket.pharmacist_name || '-') + ' (' + (ticket.pharmacy_name || '-') + ')</p></div>' +
          '<div class="field"><label class="label">ì´ë©”ì¼</label><p>' + (ticket.email || '-') + '</p></div>' +
          '<div class="field"><label class="label">ì‘ì„±ì¼ì‹œ</label><p>' + (ticket.created_at ? new Date(ticket.created_at).toLocaleString('ko-KR') : '-') + '</p></div>' +
          '<div class="field"><label class="label">ë‚´ìš©</label><div class="content" style="white-space: pre-wrap; border: 1px solid #dbdbdb; padding: 1rem; border-radius: 4px; background: #fafafa;">' + (ticket.content || '') + '</div></div>' +
          attachmentHTML +
          '<div class="field"><label class="label">ë‹µë³€ ìƒíƒœ</label><p><span class="tag ' + (ticket.status === 'open' ? 'is-danger' : ticket.status === 'answered' ? 'is-success' : 'is-light') + '">' + (ticket.status === 'open' ? 'ë¯¸ë‹µë³€' : ticket.status === 'answered' ? 'ë‹µë³€ì™„ë£Œ' : 'ì¢…ë£Œ') + '</span></p></div>';
        
      } catch (error) {
        console.error('ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
        content.innerHTML = '<p class="has-text-centered has-text-danger">ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    function closeTicketDetail() {
      document.getElementById('ticketDetailModal').classList.remove('is-active');
    }

    // ë¬¸ì˜ ìƒì„¸ í˜ì´ì§€ ë¡œë“œ (ë³„ë„ í˜ì´ì§€)
    async function loadTicketDetailPage(ticketId) {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = 
        '<div class="box">' +
          '<nav class="breadcrumb" aria-label="breadcrumbs">' +
            '<ul>' +
              '<li><a href="#" onclick="loadSupportTicketsPage(); return false;">ë¬¸ì˜ ê´€ë¦¬</a></li>' +
              '<li class="is-active"><a href="#" aria-current="page">ë¬¸ì˜ ìƒì„¸</a></li>' +
            '</ul>' +
          '</nav>' +
          '<h1 class="title is-4">ë¬¸ì˜ ìƒì„¸</h1>' +
          '<div id="ticketDetailPageContent">' +
            '<p class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</p>' +
          '</div>' +
        '</div>';
      
      try {
        const response = await fetch('/admin/api/support-tickets/' + ticketId, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          throw new Error('ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        console.log('ë¬¸ì˜ ìƒì„¸ ë°ì´í„°:', data);
        console.log('ì²¨ë¶€íŒŒì¼ ê°œìˆ˜:', data.attachments?.length || 0);
        console.log('ë‹µë³€ ê°œìˆ˜:', data.replies?.length || 0);
        
        const ticket = data.ticket;
        const attachments = data.attachments || [];
        const replies = data.replies || [];
        
        let attachmentHTML = '';
        if (attachments.length > 0) {
          attachmentHTML = '<div class="field"><label class="label">ì²¨ë¶€íŒŒì¼</label><div class="content">';
          attachments.forEach(att => {
            const isImage = att.mime_type && att.mime_type.startsWith('image/');
            const fileUrl = att.file_url;
            if (!fileUrl) {
              attachmentHTML += '<p class="has-text-danger"><i class="fas fa-exclamation-triangle"></i> ' + att.file_name + ' (íŒŒì¼ URL ìƒì„± ì‹¤íŒ¨)</p>';
              return;
            }
            if (isImage) {
              attachmentHTML += '<div class="box" style="max-width: 500px;"><p><strong>' + att.file_name + '</strong></p><img src="' + fileUrl + '" alt="' + att.file_name + '" style="max-width: 100%; height: auto; border: 1px solid #dbdbdb; border-radius: 4px;"></div>';
            } else {
              attachmentHTML += '<p><a href="' + fileUrl + '" target="_blank"><i class="fas fa-paperclip"></i> ' + att.file_name + ' (' + (att.file_size ? (att.file_size / 1024).toFixed(2) + ' KB' : '-') + ')</a></p>';
            }
          });
          attachmentHTML += '</div></div>';
        }
        
        let repliesHTML = '';
        if (replies.length > 0) {
          repliesHTML = '<hr><div class="field"><label class="label">ë‹µë³€ ë‚´ì—­ (' + replies.length + 'ê±´)</label>';
          replies.forEach((reply, idx) => {
            let replyAttHTML = '';
            if (reply.attachments && reply.attachments.length > 0) {
              replyAttHTML += '<div class="content mt-2"><strong>ì²¨ë¶€íŒŒì¼:</strong><br>';
              reply.attachments.forEach(att => {
                const isImage = att.mime_type && att.mime_type.startsWith('image/');
                const fileUrl = att.file_url;
                if (!fileUrl) {
                  replyAttHTML += '<p class="has-text-danger"><i class="fas fa-exclamation-triangle"></i> ' + att.file_name + ' (íŒŒì¼ URL ìƒì„± ì‹¤íŒ¨)</p>';
                  return;
                }
                if (isImage) {
                  replyAttHTML += '<div class="box" style="max-width: 400px; margin-top: 0.5rem;"><img src="' + fileUrl + '" alt="' + att.file_name + '" style="max-width: 100%; height: auto; border: 1px solid #dbdbdb; border-radius: 4px;"><p class="is-size-7 mt-1">' + att.file_name + '</p></div>';
                } else {
                  replyAttHTML += '<p><a href="' + fileUrl + '" target="_blank"><i class="fas fa-paperclip"></i> ' + att.file_name + '</a></p>';
                }
              });
              replyAttHTML += '</div>';
            }
            
            repliesHTML += '<div class="box" style="background: #f0f8ff; border-left: 4px solid #3273dc;">' +
              '<p class="is-size-7 has-text-grey mb-2">ë‹µë³€ #' + (idx + 1) + ' | ' + (reply.created_at ? new Date(reply.created_at).toLocaleString('ko-KR') : '-') + '</p>' +
              '<div class="content" style="white-space: pre-wrap;">' + (reply.reply_content || '') + '</div>' +
              replyAttHTML +
            '</div>';
          });
          repliesHTML += '</div>';
        }
        
        const content = document.getElementById('ticketDetailPageContent');
        content.innerHTML = 
          '<div class="columns">' +
            '<div class="column is-8">' +
              '<div class="field"><label class="label">ì œëª©</label><p class="control"><input class="input" type="text" value="' + (ticket.title || '') + '" readonly></p></div>' +
              '<div class="columns">' +
                '<div class="column is-6"><div class="field"><label class="label">ì•½êµ­ëª…</label><p>' + (ticket.pharmacy_name || '-') + '</p></div></div>' +
                '<div class="column is-6"><div class="field"><label class="label">ì•½ì‚¬ëª…</label><p>' + (ticket.pharmacist_name || '-') + '</p></div></div>' +
              '</div>' +
              '<div class="field"><label class="label">ì´ë©”ì¼</label><p>' + (ticket.email || '-') + '</p></div>' +
              '<div class="field"><label class="label">ì‘ì„±ì¼ì‹œ</label><p>' + (ticket.created_at ? new Date(ticket.created_at).toLocaleString('ko-KR') : '-') + '</p></div>' +
            '</div>' +
            '<div class="column is-4">' +
              '<div class="box has-background-light">' +
                '<div class="field"><label class="label">ë‹µë³€ ìƒíƒœ</label><p><span class="tag is-large ' + (ticket.status === 'open' ? 'is-danger' : ticket.status === 'answered' ? 'is-success' : 'is-light') + '">' + (ticket.status === 'open' ? 'ë¯¸ë‹µë³€' : ticket.status === 'answered' ? 'ë‹µë³€ì™„ë£Œ' : 'ì¢…ë£Œ') + '</span></p></div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<hr>' +
          '<div class="field"><label class="label">ë¬¸ì˜ ë‚´ìš©</label><div class="content box" style="white-space: pre-wrap; background: #fafafa; min-height: 150px;">' + (ticket.content || '') + '</div></div>' +
          attachmentHTML +
          repliesHTML +
          '<hr>' +
          '<div class="buttons">' +
            '<button class="button is-light" onclick="loadSupportTicketsPage()">' +
              '<i class="fas fa-arrow-left"></i>&nbsp; ëª©ë¡ìœ¼ë¡œ' +
            '</button>' +
            '<button class="button is-primary" onclick="openReplyModal(\'' + ticketId + '\')">' +
              '<i class="fas fa-reply"></i>&nbsp; ë‹µì¥í•˜ê¸°' +
            '</button>' +
          '</div>';
        
      } catch (error) {
        console.error('ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('ticketDetailPageContent').innerHTML = '<div class="notification is-danger">ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    // ë‹µì¥ ëª¨ë‹¬ ì—´ê¸°
    function openReplyModal(ticketId) {
      const modal = document.createElement('div');
      modal.id = 'replyModal';
      modal.className = 'modal is-active';
      modal.innerHTML = 
        '<div class="modal-background" onclick="closeReplyModal()"></div>' +
        '<div class="modal-card" style="width: 700px;">' +
          '<header class="modal-card-head">' +
            '<p class="modal-card-title">ë‹µì¥ ì‘ì„±</p>' +
            '<button class="delete" onclick="closeReplyModal()"></button>' +
          '</header>' +
          '<section class="modal-card-body">' +
            '<div class="field">' +
              '<label class="label">ë‹µë³€ ë‚´ìš© <span class="has-text-danger">*</span></label>' +
              '<div class="control">' +
                '<textarea id="replyContent" class="textarea" rows="8" placeholder="ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>' +
              '</div>' +
            '</div>' +
            '<div class="field">' +
              '<label class="label">ì²¨ë¶€íŒŒì¼</label>' +
              '<div class="control">' +
                '<input id="replyFileInput" class="input" type="file" multiple accept="image/*,application/pdf,application/zip">' +
              '</div>' +
              '<p class="help">ì´ë¯¸ì§€, PDF, ZIP íŒŒì¼ì„ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ìµœëŒ€ 5ê°œ)</p>' +
              '<div id="replyFileList" class="content mt-2"></div>' +
            '</div>' +
          '</section>' +
          '<footer class="modal-card-foot">' +
            '<button class="button is-success" onclick="submitReply(\'' + ticketId + '\')">' +
              '<i class="fas fa-paper-plane"></i>&nbsp; ë‹µì¥ ì „ì†¡' +
            '</button>' +
            '<button class="button" onclick="closeReplyModal()">ì·¨ì†Œ</button>' +
          '</footer>' +
        '</div>';
      
      document.body.appendChild(modal);
      
      // íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
      document.getElementById('replyFileInput').addEventListener('change', function(e) {
        const fileList = document.getElementById('replyFileList');
        const files = Array.from(e.target.files);
        
        if (files.length === 0) {
          fileList.innerHTML = '';
          return;
        }
        
        if (files.length > 5) {
          alert('ìµœëŒ€ 5ê°œì˜ íŒŒì¼ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          e.target.value = '';
          return;
        }
        
        fileList.innerHTML = '<ul>' + files.map(f => '<li><i class="fas fa-file"></i> ' + f.name + ' (' + (f.size / 1024).toFixed(2) + ' KB)</li>').join('') + '</ul>';
      });
    }

    function closeReplyModal() {
      const modal = document.getElementById('replyModal');
      if (modal) {
        modal.remove();
      }
    }

    async function submitReply(ticketId) {
      const content = document.getElementById('replyContent').value.trim();
      const fileInput = document.getElementById('replyFileInput');
      
      if (!content) {
        alert('ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const button = event.target;
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-pulse"></i>&nbsp; ì „ì†¡ ì¤‘...';
      
      try {
        // FormDataë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ê³¼ í…ìŠ¤íŠ¸ í•¨ê»˜ ì „ì†¡
        const formData = new FormData();
        formData.append('reply_content', content);
        
        // íŒŒì¼ ì²¨ë¶€
        if (fileInput.files.length > 0) {
          for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('attachments', fileInput.files[i]);
          }
        }
        
        const response = await fetch('/admin/api/support-tickets/' + ticketId + '/reply', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
            // Content-Typeì€ FormData ì‚¬ìš© ì‹œ ìë™ ì„¤ì •ë¨
          },
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('ë‹µë³€ ì „ì†¡ ì‹¤íŒ¨');
        }
        
        alert('ë‹µë³€ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeReplyModal();
        loadTicketDetailPage(ticketId); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        
      } catch (error) {
        alert('ë‹µë³€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-paper-plane"></i>&nbsp; ë‹µì¥ ì „ì†¡';
      }
    }

    // ==================== ì›ê²© ì§€ì› ê´€ë¦¬ í˜ì´ì§€ ====================
    async function loadRemoteSupportPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = '<h1 class="title">ì›ê²© ì§€ì› ê´€ë¦¬</h1>' +
        '<div class="box">' +
          '<div class="columns is-multiline">' +
            '<div class="column is-3">' +
              '<div class="field">' +
                '<label class="label">ì•½êµ­ëª…</label>' +
                '<div class="control">' +
                  '<input class="input" type="text" id="remotePharmacyName" placeholder="ì•½êµ­ëª… ê²€ìƒ‰">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-3">' +
              '<div class="field">' +
                '<label class="label">ì•½ì‚¬ëª…</label>' +
                '<div class="control">' +
                  '<input class="input" type="text" id="remotePharmacistName" placeholder="ì•½ì‚¬ëª… ê²€ìƒ‰">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ìƒíƒœ</label>' +
                '<div class="control">' +
                  '<div class="select is-fullwidth">' +
                    '<select id="remoteStatusFilter">' +
                      '<option value="">ì „ì²´</option>' +
                      '<option value="requested">ìš”ì²­ë¨</option>' +
                      '<option value="in_progress">ì§„í–‰ì¤‘</option>' +
                      '<option value="completed">ì™„ë£Œ</option>' +
                      '<option value="cancelled">ì·¨ì†Œ</option>' +
                    '</select>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì‹œì‘ì¼</label>' +
                '<div class="control">' +
                  '<input class="input" type="date" id="remoteStartDate">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<label class="label">ì¢…ë£Œì¼</label>' +
                '<div class="control">' +
                  '<input class="input" type="date" id="remoteEndDate">' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2 is-offset-8">' +
              '<div class="field">' +
                '<div class="control">' +
                  '<button class="button is-primary is-fullwidth" onclick="searchRemoteSessions()">' +
                    '<i class="fas fa-search"></i>&nbsp; ê²€ìƒ‰' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-2">' +
              '<div class="field">' +
                '<div class="control">' +
                  '<button class="button is-light is-fullwidth" onclick="clearRemoteFilters()">' +
                    '<i class="fas fa-redo"></i>&nbsp; ì´ˆê¸°í™”' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="box">' +
          '<div class="table-container">' +
            '<table class="table is-fullwidth is-striped is-hoverable">' +
              '<thead>' +
                '<tr>' +
                  '<th style="width: 60px;">No.</th>' +
                  '<th>ì„¸ì…˜ë²ˆí˜¸</th>' +
                  '<th>ì•½êµ­ëª…</th>' +
                  '<th>ì•½ì‚¬ëª…</th>' +
                  '<th>ì—°ë½ì²˜</th>' +
                  '<th>ìš”ì²­ì¼ì‹œ</th>' +
                  '<th>ë¬¸ì œìœ í˜•</th>' +
                  '<th>ìƒíƒœ</th>' +
                  '<th>ìƒë‹´ì›</th>' +
                  '<th style="width: 100px;">ì‘ì—…</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody id="remoteTableBody">' +
                '<tr>' +
                  '<td colspan="10" class="has-text-centered">' +
                    '<i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...' +
                  '</td>' +
                '</tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
          '<nav class="pagination is-centered" role="navigation" id="remotePagination">' +
          '</nav>' +
        '</div>';
      
      // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
      searchRemoteSessions();
    }

    let currentRemotePage = 1;
    const remotePageSize = 20;
    let allRemoteSessions = [];

    async function searchRemoteSessions(page = 1) {
      currentRemotePage = page;
      
      const status = document.getElementById('remoteStatusFilter')?.value || '';
      const startDate = document.getElementById('remoteStartDate')?.value || '';
      const endDate = document.getElementById('remoteEndDate')?.value || '';
      const pharmacyName = document.getElementById('remotePharmacyName')?.value?.trim() || '';
      const pharmacistName = document.getElementById('remotePharmacistName')?.value?.trim() || '';
      
      const tbody = document.getElementById('remoteTableBody');
      tbody.innerHTML = '<tr><td colspan="10" class="has-text-centered"><i class="fas fa-spinner fa-pulse"></i> ë¡œë”© ì¤‘...</td></tr>';
      
      try {
        const params = new URLSearchParams({
          page: page,
          limit: remotePageSize,
          status: status,
          startDate: startDate,
          endDate: endDate
        });
        
        const response = await fetch('/admin/api/remote-sessions?' + params.toString(), {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        allRemoteSessions = data.sessions || [];
        
        // ì•½êµ­ëª…/ì•½ì‚¬ëª… í•„í„°ë§ (í´ë¼ì´ì–¸íŠ¸ ì¸¡)
        let filteredSessions = allRemoteSessions;
        if (pharmacyName || pharmacistName) {
          filteredSessions = allRemoteSessions.filter(function(session) {
            const matchPharmacy = !pharmacyName || 
              (session.pharmacy_name && session.pharmacy_name.toLowerCase().indexOf(pharmacyName.toLowerCase()) !== -1);
            const matchPharmacist = !pharmacistName || 
              (session.pharmacist_name && session.pharmacist_name.toLowerCase().indexOf(pharmacistName.toLowerCase()) !== -1);
            return matchPharmacy && matchPharmacist;
          });
        }
        
        renderRemoteSessions(filteredSessions, data.total, data.page, data.totalPages);
        
      } catch (error) {
        console.error('ì›ê²© ì§€ì› ì¡°íšŒ ì˜¤ë¥˜:', error);
        tbody.innerHTML = '<tr><td colspan="10" class="has-text-centered has-text-danger">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    function renderRemoteSessions(sessions, total, currentPage, totalPages) {
      const tbody = document.getElementById('remoteTableBody');
      
      if (!sessions || sessions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="has-text-centered">ì›ê²© ì§€ì› ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      let html = '';
      sessions.forEach(function(session, index) {
        const num = (currentPage - 1) * remotePageSize + index + 1;
        
        const statusBadge = getRemoteStatusBadge(session.status);
        const requestedAt = new Date(session.requested_at).toLocaleString('ko-KR');
        
        html += '<tr>' +
          '<td>' + num + '</td>' +
          '<td><a onclick="loadRemoteDetailPage(\'' + session.session_id + '\')" style="cursor: pointer; color: #3273dc;">' + 
            (session.session_number || '-') + '</a></td>' +
          '<td>' + (session.pharmacy_name || '-') + '</td>' +
          '<td>' + (session.pharmacist_name || '-') + '</td>' +
          '<td>' + (session.customer_phone || '-') + '</td>' +
          '<td>' + requestedAt + '</td>' +
          '<td>' + (session.issue_category || '-') + '</td>' +
          '<td>' + statusBadge + '</td>' +
          '<td>' + (session.agent_email || '-') + '</td>' +
          '<td>' +
            '<button class="button is-small is-info" onclick="loadRemoteDetailPage(\'' + session.session_id + '\')">' +
              '<i class="fas fa-eye"></i>' +
            '</button>' +
          '</td>' +
        '</tr>';
      });
      
      tbody.innerHTML = html;
      renderRemotePagination(total, currentPage, totalPages);
    }

    function getRemoteStatusBadge(status) {
      switch(status) {
        case 'requested':
          return '<span class="tag is-warning">ìš”ì²­ë¨</span>';
        case 'in_progress':
          return '<span class="tag is-info">ì§„í–‰ì¤‘</span>';
        case 'completed':
          return '<span class="tag is-success">ì™„ë£Œ</span>';
        case 'cancelled':
          return '<span class="tag is-light">ì·¨ì†Œ</span>';
        default:
          return '<span class="tag">' + status + '</span>';
      }
    }

    function renderRemotePagination(total, currentPage, totalPages) {
      const pagination = document.getElementById('remotePagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = '<a class="pagination-previous" ' + (currentPage === 1 ? 'disabled' : 'onclick="searchRemoteSessions(' + (currentPage - 1) + ')"') + '>ì´ì „</a>';
      html += '<a class="pagination-next" ' + (currentPage === totalPages ? 'disabled' : 'onclick="searchRemoteSessions(' + (currentPage + 1) + ')"') + '>ë‹¤ìŒ</a>';
      html += '<ul class="pagination-list">';
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += '<li><a class="pagination-link ' + (i === currentPage ? 'is-current' : '') + '" onclick="searchRemoteSessions(' + i + ')">' + i + '</a></li>';
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<li><span class="pagination-ellipsis">&hellip;</span></li>';
        }
      }
      
      html += '</ul>';
      pagination.innerHTML = html;
    }

    function clearRemoteFilters() {
      document.getElementById('remoteStatusFilter').value = '';
      document.getElementById('remoteStartDate').value = '';
      document.getElementById('remoteEndDate').value = '';
      document.getElementById('remotePharmacyName').value = '';
      document.getElementById('remotePharmacistName').value = '';
      searchRemoteSessions(1);
    }

    // ì›ê²© ì§€ì› ìƒì„¸ í˜ì´ì§€
    async function loadRemoteDetailPage(sessionId) {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = '<div class="has-text-centered"><i class="fas fa-spinner fa-pulse fa-3x"></i></div>';
      
      try {
        const response = await fetch('/admin/api/remote-sessions/' + sessionId, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        if (!response.ok) {
          throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }
        
        const session = await response.json();
        
        const requestedAt = new Date(session.requested_at).toLocaleString('ko-KR');
        const connectedAt = session.connected_at ? new Date(session.connected_at).toLocaleString('ko-KR') : '-';
        const endedAt = session.ended_at ? new Date(session.ended_at).toLocaleString('ko-KR') : '-';
        
        mainContent.innerHTML = 
          '<nav class="breadcrumb" aria-label="breadcrumbs">' +
            '<ul>' +
              '<li><a onclick="loadRemoteSupportPage()">ì›ê²© ì§€ì› ê´€ë¦¬</a></li>' +
              '<li class="is-active"><a>' + (session.session_number || 'ìƒì„¸') + '</a></li>' +
            '</ul>' +
          '</nav>' +
          '<h1 class="title">ì›ê²© ì§€ì› ìƒì„¸</h1>' +
          '<div class="columns">' +
            '<div class="column is-8">' +
              '<div class="box">' +
                '<h2 class="subtitle">ê¸°ë³¸ ì •ë³´</h2>' +
                '<table class="table is-fullwidth">' +
                  '<tbody>' +
                    '<tr><th style="width: 150px;">ì„¸ì…˜ ë²ˆí˜¸</th><td>' + (session.session_number || '-') + '</td></tr>' +
                    '<tr><th>ìƒíƒœ</th><td>' + getRemoteStatusBadge(session.status) + '</td></tr>' +
                    '<tr><th>ì•½êµ­ëª…</th><td>' + (session.pharmacy_name || '-') + '</td></tr>' +
                    '<tr><th>ì•½ì‚¬ëª…</th><td>' + (session.pharmacist_name || '-') + '</td></tr>' +
                    '<tr><th>ì´ë©”ì¼</th><td>' + (session.email || '-') + '</td></tr>' +
                    '<tr><th>ì—°ë½ì²˜</th><td>' + (session.customer_phone || '-') + '</td></tr>' +
                  '</tbody>' +
                '</table>' +
              '</div>' +
              '<div class="box">' +
                '<h2 class="subtitle">ì„¸ì…˜ ì •ë³´</h2>' +
                '<table class="table is-fullwidth">' +
                  '<tbody>' +
                    '<tr><th style="width: 150px;">ìš”ì²­ì¼ì‹œ</th><td>' + requestedAt + '</td></tr>' +
                    '<tr><th>ì‹œì‘ì¼ì‹œ</th><td>' + connectedAt + '</td></tr>' +
                    '<tr><th>ì¢…ë£Œì¼ì‹œ</th><td>' + endedAt + '</td></tr>' +
                    '<tr><th>ìƒë‹´ì›</th><td>' + (session.agent_email || '-') + '</td></tr>' +
                  '</tbody>' +
                '</table>' +
              '</div>' +
              '<div class="box" style="border: 2px solid #3273dc;">' +
                '<h2 class="subtitle">' +
                  '<i class="fas fa-edit"></i> ìƒë‹´ ë‚´ìš© ì‘ì„± ' +
                  '<span class="tag is-info is-light">ì•„ë˜ ë‚´ìš© ì‘ì„± í›„ í•˜ë‹¨ "ì „ì²´ ì €ì¥" ë²„íŠ¼ í´ë¦­</span>' +
                '</h2>' +
                '<div class="field">' +
                  '<label class="label">í˜„ì¬ ìƒíƒœ <span class="has-text-danger">*</span></label>' +
                  '<div class="control">' +
                    '<div class="select is-fullwidth">' +
                      '<select id="sessionStatus">' +
                        '<option value="requested" ' + (session.status === 'requested' ? 'selected' : '') + '>ìš”ì²­ë¨</option>' +
                        '<option value="in_progress" ' + (session.status === 'in_progress' ? 'selected' : '') + '>ì§„í–‰ì¤‘</option>' +
                        '<option value="completed" ' + (session.status === 'completed' ? 'selected' : '') + '>ì™„ë£Œ</option>' +
                        '<option value="cancelled" ' + (session.status === 'cancelled' ? 'selected' : '') + '>ì·¨ì†Œ</option>' +
                      '</select>' +
                    '</div>' +
                  '</div>' +
                  '<p class="help">ìƒíƒœë¥¼ ë³€ê²½í•˜ë©´ ìë™ìœ¼ë¡œ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ì´ ê¸°ë¡ë©ë‹ˆë‹¤</p>' +
                '</div>' +
                '<div class="field">' +
                  '<label class="label">ì ‘ì† ë©”ëª¨</label>' +
                  '<div class="control">' +
                    '<textarea class="textarea" id="connectionNote" rows="2" placeholder="ì˜ˆ: TeamViewer ID 123-456-789ë¡œ ì ‘ì†, ì „í™” í†µí™” í›„ ì ‘ì† ì§„í–‰...">' + (session.connection_note || '') + '</textarea>' +
                  '</div>' +
                  '<p class="help">ì›ê²© ì ‘ì† ë°©ì‹ì´ë‚˜ ID ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”</p>' +
                '</div>' +
                '<div class="field">' +
                  '<label class="label">ë¬¸ì œ ìœ í˜•</label>' +
                  '<div class="control">' +
                    '<input class="input" type="text" id="issueCategory" value="' + (session.issue_category || '') + '" placeholder="ì˜ˆ: ì„¤ì¹˜ ì˜¤ë¥˜, ë°”ì½”ë“œ ì¸ì‹, ì„±ëŠ¥ ë¬¸ì œ">' +
                  '</div>' +
                '</div>' +
                '<div class="field">' +
                  '<label class="label">ìƒë‹´ ë©”ëª¨</label>' +
                  '<div class="control">' +
                    '<textarea class="textarea" id="notes" rows="5" placeholder="ìƒë‹´ ì§„í–‰ ê³¼ì •, ê³ ê° ìš”ì²­ ì‚¬í•­, ë°œê²¬í•œ ë¬¸ì œì  ë“±ì„ ìƒì„¸íˆ ê¸°ë¡í•˜ì„¸ìš”...">' + (session.notes || '') + '</textarea>' +
                  '</div>' +
                '</div>' +
                '<div class="field">' +
                  '<label class="label">í•´ê²° ë°©ë²•</label>' +
                  '<div class="control">' +
                    '<textarea class="textarea" id="resolution" rows="4" placeholder="ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ì·¨í•œ ì¡°ì¹˜, ì•ˆë‚´ ì‚¬í•­ ë“±ì„ ìš”ì•½í•˜ì„¸ìš”...">' + (session.resolution || '') + '</textarea>' +
                  '</div>' +
                '</div>' +
                '<div class="field">' +
                  '<div class="control">' +
                    '<button class="button is-primary is-large is-fullwidth" onclick="updateRemoteSession(\'' + sessionId + '\')" style="height: 60px;">' +
                      '<span class="icon is-medium"><i class="fas fa-save"></i></span>' +
                      '<span style="font-size: 1.1rem; font-weight: bold;">ì „ì²´ ì €ì¥ (ìƒíƒœ + ëª¨ë“  ë©”ëª¨)</span>' +
                    '</button>' +
                  '</div>' +
                  '<p class="help has-text-centered mt-2">ìœ„ ëª¨ë“  í•„ë“œì˜ ë‚´ìš©ì´ í•¨ê»˜ ì €ì¥ë©ë‹ˆë‹¤</p>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="column is-4">' +
              '<div class="box">' +
                '<h2 class="subtitle">ëª©ë¡ìœ¼ë¡œ</h2>' +
                '<div class="field">' +
                  '<div class="control">' +
                    '<button class="button is-light is-fullwidth" onclick="loadRemoteSupportPage()">' +
                      '<i class="fas fa-arrow-left"></i>&nbsp; ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°' +
                    '</button>' +
                  '</div>' +
                '</div>' +
              '</div>' +
              '<div class="box" style="background-color: #f0f9ff; border: 2px solid #3298dc;">' +
                '<h2 class="subtitle">' +
                  '<i class="fas fa-bolt"></i> ë¹ ë¥¸ ìƒíƒœ ë³€ê²½ ' +
                  '<span class="tag is-warning is-light">ì£¼ì˜</span>' +
                '</h2>' +
                '<div class="notification is-warning is-light">' +
                  '<p class="is-size-7"><strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong></p>' +
                  '<p class="is-size-7">ì•„ë˜ ë²„íŠ¼ì€ <strong>ìƒíƒœë§Œ</strong> ì¦‰ì‹œ ë³€ê²½í•©ë‹ˆë‹¤.</p>' +
                  '<p class="is-size-7">ì‘ì„±í•œ ë©”ëª¨ëŠ” ì €ì¥ë˜ì§€ ì•Šìœ¼ë‹ˆ, ë©”ëª¨ ì‘ì„± í›„ì—ëŠ” ìœ„ì˜ <strong>"ì „ì²´ ì €ì¥"</strong> ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”!</p>' +
                '</div>' +
                '<div class="buttons">' +
                  '<button class="button is-info is-fullwidth" onclick="quickUpdateStatus(\'' + sessionId + '\', \'in_progress\')" ' + 
                    (session.status === 'in_progress' ? 'disabled' : '') + '>' +
                    '<i class="fas fa-play"></i>&nbsp; ì§„í–‰ì¤‘ìœ¼ë¡œë§Œ ë³€ê²½' +
                  '</button>' +
                '</div>' +
                '<div class="buttons">' +
                  '<button class="button is-success is-fullwidth" onclick="quickUpdateStatus(\'' + sessionId + '\', \'completed\')" ' + 
                    (session.status === 'completed' ? 'disabled' : '') + '>' +
                    '<i class="fas fa-check"></i>&nbsp; ì™„ë£Œë¡œë§Œ ë³€ê²½' +
                  '</button>' +
                '</div>' +
                '<div class="buttons">' +
                  '<button class="button is-light is-fullwidth" onclick="quickUpdateStatus(\'' + sessionId + '\', \'cancelled\')" ' + 
                    (session.status === 'cancelled' ? 'disabled' : '') + '>' +
                    '<i class="fas fa-times"></i>&nbsp; ì·¨ì†Œë¡œë§Œ ë³€ê²½' +
                  '</button>' +
                '</div>' +
                '<p class="help has-text-centered">ë©”ëª¨ ì—†ì´ ìƒíƒœë§Œ ë¹ ë¥´ê²Œ ë³€ê²½í•  ë•Œ ì‚¬ìš©</p>' +
              '</div>' +
              '<div class="box" style="background-color: #f5f5f5;">' +
                '<h2 class="subtitle"><i class="fas fa-info-circle"></i> ì‚¬ìš© ê°€ì´ë“œ</h2>' +
                '<div class="content is-size-7">' +
                  '<p><strong>ğŸ“ ë©”ëª¨ì™€ í•¨ê»˜ ì €ì¥:</strong></p>' +
                  '<ol>' +
                    '<li>ìƒíƒœ ì„ íƒ</li>' +
                    '<li>ì ‘ì† ë©”ëª¨, ë¬¸ì œ ìœ í˜•, ìƒë‹´ ë©”ëª¨, í•´ê²° ë°©ë²• ì‘ì„±</li>' +
                    '<li><strong>"ì „ì²´ ì €ì¥"</strong> ë²„íŠ¼ í´ë¦­</li>' +
                  '</ol>' +
                  '<p><strong>âš¡ ìƒíƒœë§Œ ë¹ ë¥´ê²Œ ë³€ê²½:</strong></p>' +
                  '<ol>' +
                    '<li>"ë¹ ë¥¸ ìƒíƒœ ë³€ê²½" ì„¹ì…˜ì˜ ë²„íŠ¼ í´ë¦­</li>' +
                    '<li>í™•ì¸ í›„ ì¦‰ì‹œ ë°˜ì˜ (ë©”ëª¨ ì €ì¥ ì•ˆ ë¨)</li>' +
                  '</ol>' +
                  '<p class="has-text-danger"><strong>âš ï¸ ì¤‘ìš”:</strong></p>' +
                  '<ul>' +
                    '<li>ë©”ëª¨ë¥¼ ì‘ì„±í–ˆë‹¤ë©´ ë°˜ë“œì‹œ "ì „ì²´ ì €ì¥" ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ í•©ë‹ˆë‹¤</li>' +
                    '<li>ë¹ ë¥¸ ë³€ê²½ ë²„íŠ¼ì€ ì‘ì„±í•œ ë©”ëª¨ë¥¼ ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</li>' +
                  '</ul>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>';
        
      } catch (error) {
        console.error('ì›ê²© ì§€ì› ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
        mainContent.innerHTML = '<div class="notification is-danger">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    async function updateRemoteSession(sessionId) {
      const status = document.getElementById('sessionStatus').value;
      const connectionNote = document.getElementById('connectionNote').value.trim();
      const issueCategory = document.getElementById('issueCategory').value.trim();
      const notes = document.getElementById('notes').value.trim();
      const resolution = document.getElementById('resolution').value.trim();
      
      try {
        const response = await fetch('/admin/api/remote-sessions/' + sessionId, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          },
          body: JSON.stringify({
            status: status,
            connection_note: connectionNote,
            issue_category: issueCategory,
            notes: notes,
            resolution: resolution
          })
        });
        
        if (!response.ok) {
          throw new Error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        }
        
        alert('ì›ê²© ì§€ì› ì„¸ì…˜ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadRemoteDetailPage(sessionId); // ìƒˆë¡œê³ ì¹¨
        
      } catch (error) {
        console.error('ì›ê²© ì§€ì› ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function quickUpdateStatus(sessionId, newStatus) {
      if (!confirm('ìƒíƒœë¥¼ "' + getStatusText(newStatus) + '"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        const response = await fetch('/admin/api/remote-sessions/' + sessionId, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          },
          body: JSON.stringify({
            status: newStatus
          })
        });
        
        if (!response.ok) {
          throw new Error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        }
        
        alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadRemoteDetailPage(sessionId); // ìƒˆë¡œê³ ì¹¨
        
      } catch (error) {
        console.error('ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
        alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function getStatusText(status) {
      switch(status) {
        case 'requested': return 'ìš”ì²­ë¨';
        case 'in_progress': return 'ì§„í–‰ì¤‘';
        case 'completed': return 'ì™„ë£Œ';
        case 'cancelled': return 'ì·¨ì†Œ';
        default: return status;
      }
    }

    // ===========================
    // FAQ ê´€ë¦¬ í˜ì´ì§€
    // ===========================
    
    async function loadFaqManagementPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <h1 class="title">FAQ ê´€ë¦¬</h1>
        
        <div class="box">
          <div class="level">
            <div class="level-left">
              <div class="level-item">
                <h5 class="title is-5">FAQ ëª©ë¡</h5>
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                <button class="button is-primary" onclick="openFaqModal()">
                  <span class="icon"><i class="fas fa-plus"></i></span>
                  <span>FAQ ì‘ì„±í•˜ê¸°</span>
                </button>
              </div>
            </div>
          </div>
          
          <div class="table-container">
            <table class="table is-fullwidth is-hoverable">
              <thead>
                <tr>
                  <th style="width: 50px;">ìˆœì„œ</th>
                  <th>ì§ˆë¬¸</th>
                  <th style="width: 100px;">ìƒíƒœ</th>
                  <th style="width: 150px;">ì‘ì„±ì¼</th>
                  <th style="width: 150px;">ìˆ˜ì •ì¼</th>
                  <th style="width: 150px;">ê´€ë¦¬</th>
                </tr>
              </thead>
              <tbody id="faqTableBody">
                <tr>
                  <td colspan="6" class="has-text-centered">ë¡œë”© ì¤‘...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- FAQ ì‘ì„±/ìˆ˜ì • ëª¨ë‹¬ -->
        <div class="modal" id="faqModal">
          <div class="modal-background" onclick="closeFaqModal()"></div>
          <div class="modal-card" style="width: 800px;">
            <header class="modal-card-head">
              <p class="modal-card-title" id="faqModalTitle">FAQ ì‘ì„±</p>
              <button class="delete" aria-label="close" onclick="closeFaqModal()"></button>
            </header>
            <section class="modal-card-body">
              <input type="hidden" id="faqId">
              
              <div class="field">
                <label class="label">ì§ˆë¬¸ <span class="has-text-danger">*</span></label>
                <div class="control">
                  <input class="input" type="text" id="faqQuestion" placeholder="ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
              </div>
              
              <div class="field">
                <label class="label">ë‹µë³€ <span class="has-text-danger">*</span></label>
                <div class="control">
                  <textarea class="textarea" id="faqAnswer" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" rows="10"></textarea>
                </div>
              </div>
              
              <div class="columns">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">ë…¸ì¶œ ì—¬ë¶€</label>
                    <div class="control">
                      <label class="checkbox">
                        <input type="checkbox" id="faqIsActive" checked>
                        í™œì„±í™” (ê³ ê° í˜ì´ì§€ì— í‘œì‹œ)
                      </label>
                    </div>
                  </div>
                </div>
                <div class="column is-6">
                  <div class="field">
                    <label class="label">ì •ë ¬ ìˆœì„œ</label>
                    <div class="control">
                      <input class="input" type="number" id="faqDisplayOrder" value="0" min="0">
                    </div>
                    <p class="help">ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ìœ„ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                  </div>
                </div>
              </div>
            </section>
            <footer class="modal-card-foot">
              <button class="button is-primary" onclick="saveFaq()">ì €ì¥</button>
              <button class="button" onclick="closeFaqModal()">ì·¨ì†Œ</button>
            </footer>
          </div>
        </div>
      `;
      
      await loadFaqList();
    }
    
    async function loadFaqList() {
      try {
        const response = await fetch('/admin/api/faqs', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const data = await response.json();
        const tbody = document.getElementById('faqTableBody');
        
        if (!data.faqs || data.faqs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="has-text-centered">FAQê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.faqs.map(faq => {
          const statusTag = faq.is_active 
            ? '<span class="tag is-success">í™œì„±</span>' 
            : '<span class="tag is-light">ë¹„í™œì„±</span>';
          
          return `
            <tr>
              <td>${faq.display_order}</td>
              <td>
                <a href="#" onclick="viewFaqDetail('${faq.faq_id}'); return false;" class="has-text-link">
                  ${faq.question}
                </a>
              </td>
              <td>${statusTag}</td>
              <td>${new Date(faq.created_at).toLocaleDateString('ko-KR')}</td>
              <td>${new Date(faq.updated_at).toLocaleDateString('ko-KR')}</td>
              <td>
                <div class="buttons are-small">
                  <button class="button is-info is-small" onclick="editFaq('${faq.faq_id}')">
                    <span class="icon"><i class="fas fa-edit"></i></span>
                  </button>
                  <button class="button is-danger is-small" onclick="deleteFaq('${faq.faq_id}')">
                    <span class="icon"><i class="fas fa-trash"></i></span>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        console.error('FAQ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('faqTableBody').innerHTML = 
          '<tr><td colspan="6" class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
      }
    }
    
    function openFaqModal() {
      document.getElementById('faqModalTitle').textContent = 'FAQ ì‘ì„±';
      document.getElementById('faqId').value = '';
      document.getElementById('faqQuestion').value = '';
      document.getElementById('faqAnswer').value = '';
      document.getElementById('faqIsActive').checked = true;
      document.getElementById('faqDisplayOrder').value = '0';
      document.getElementById('faqModal').classList.add('is-active');
    }
    
    function closeFaqModal() {
      document.getElementById('faqModal').classList.remove('is-active');
    }
    
    async function editFaq(faqId) {
      try {
        const response = await fetch('/admin/api/faqs', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const data = await response.json();
        const faq = data.faqs.find(f => f.faq_id === faqId);
        
        if (!faq) {
          alert('FAQë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        document.getElementById('faqModalTitle').textContent = 'FAQ ìˆ˜ì •';
        document.getElementById('faqId').value = faq.faq_id;
        document.getElementById('faqQuestion').value = faq.question;
        document.getElementById('faqAnswer').value = faq.answer;
        document.getElementById('faqIsActive').checked = faq.is_active;
        document.getElementById('faqDisplayOrder').value = faq.display_order;
        document.getElementById('faqModal').classList.add('is-active');
        
      } catch (error) {
        console.error('FAQ ì¡°íšŒ ì˜¤ë¥˜:', error);
        alert('FAQë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    async function saveFaq() {
      const faqId = document.getElementById('faqId').value;
      const question = document.getElementById('faqQuestion').value.trim();
      const answer = document.getElementById('faqAnswer').value.trim();
      const is_active = document.getElementById('faqIsActive').checked;
      const display_order = parseInt(document.getElementById('faqDisplayOrder').value);
      
      if (!question || !answer) {
        alert('ì§ˆë¬¸ê³¼ ë‹µë³€ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const url = faqId 
          ? '/admin/api/faqs/' + faqId 
          : '/admin/api/faqs';
        const method = faqId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token'),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            question,
            answer,
            is_active,
            display_order
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(faqId ? 'FAQê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'FAQê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeFaqModal();
          loadFaqList();
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
        
      } catch (error) {
        console.error('FAQ ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    async function deleteFaq(faqId) {
      if (!confirm('ì •ë§ ì´ FAQë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        const response = await fetch('/admin/api/faqs/' + faqId, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('FAQê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadFaqList();
        } else {
          alert('ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
        
      } catch (error) {
        console.error('FAQ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    function viewFaqDetail(faqId) {
      editFaq(faqId);
    }

    // ===========================
    // í”Œëœ ê´€ë¦¬ í˜ì´ì§€
    // ===========================
    
    async function loadPlansPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <h1 class="title">í”Œëœ ê´€ë¦¬</h1>
        
        <div class="box">
          <div class="level">
            <div class="level-left">
              <div class="level-item">
                <h5 class="title is-5">êµ¬ë… í”Œëœ ëª©ë¡</h5>
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                <button class="button is-primary" onclick="openPlanModal()">
                  <span class="icon"><i class="fas fa-plus"></i></span>
                  <span>í”Œëœ ì¶”ê°€</span>
                </button>
              </div>
            </div>
          </div>
          
          <div class="table-container">
            <table class="table is-fullwidth is-hoverable">
              <thead>
                <tr>
                  <th>í”Œëœ ì½”ë“œ</th>
                  <th>í”Œëœëª…</th>
                  <th>ì›” ìš”ê¸ˆ</th>
                  <th>ì¼ì¼ í•œë„</th>
                  <th>ì„¤ëª…</th>
                  <th style="width: 100px;">ìƒíƒœ</th>
                  <th style="width: 150px;">ìƒì„±ì¼</th>
                  <th style="width: 150px;">ê´€ë¦¬</th>
                </tr>
              </thead>
              <tbody id="planTableBody">
                <tr>
                  <td colspan="8" class="has-text-centered">ë¡œë”© ì¤‘...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- í”Œëœ ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
        <div class="modal" id="planModal">
          <div class="modal-background" onclick="closePlanModal()"></div>
          <div class="modal-card" style="width: 700px;">
            <header class="modal-card-head">
              <p class="modal-card-title" id="planModalTitle">í”Œëœ ì¶”ê°€</p>
              <button class="delete" aria-label="close" onclick="closePlanModal()"></button>
            </header>
            <section class="modal-card-body">
              <input type="hidden" id="planId">
              
              <div class="columns">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">í”Œëœ ì½”ë“œ <span class="has-text-danger">*</span></label>
                    <div class="control">
                      <input class="input" type="text" id="planCode" placeholder="ì˜ˆ: basic, premium">
                    </div>
                    <p class="help">ê³ ìœ í•œ ì˜ë¬¸ ì½”ë“œ (ë³€ê²½ ë¶ˆê°€ ê¶Œì¥)</p>
                  </div>
                </div>
                <div class="column is-6">
                  <div class="field">
                    <label class="label">í”Œëœëª… <span class="has-text-danger">*</span></label>
                    <div class="control">
                      <input class="input" type="text" id="planName" placeholder="ì˜ˆ: ë² ì´ì§ í”Œëœ">
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="columns">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">ì›” ìš”ê¸ˆ (ì›) <span class="has-text-danger">*</span></label>
                    <div class="control">
                      <input class="input" type="number" id="planPrice" placeholder="ì˜ˆ: 50000" min="0">
                    </div>
                  </div>
                </div>
                <div class="column is-6">
                  <div class="field">
                    <label class="label">ì¼ì¼ ì¡°ì œ í•œë„</label>
                    <div class="control">
                      <input class="input" type="number" id="planLimit" placeholder="ë¹„ì›Œë‘ë©´ ë¬´ì œí•œ" min="0">
                    </div>
                    <p class="help">ë¹„ì›Œë‘ë©´ ì œí•œ ì—†ìŒ</p>
                  </div>
                </div>
              </div>
              
              <div class="field">
                <label class="label">í”Œëœ ì„¤ëª…</label>
                <div class="control">
                  <textarea class="textarea" id="planDescription" placeholder="í”Œëœì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" rows="4"></textarea>
                </div>
              </div>
              
              <div class="field">
                <label class="label">íŒë§¤ ìƒíƒœ</label>
                <div class="control">
                  <label class="checkbox">
                    <input type="checkbox" id="planIsActive" checked>
                    í™œì„±í™” (ì‹ ê·œ ê°€ì… ê°€ëŠ¥)
                  </label>
                </div>
                <p class="help">ë¹„í™œì„±í™” ì‹œ ê¸°ì¡´ ì‚¬ìš©ìëŠ” ìœ ì§€ë˜ì§€ë§Œ ì‹ ê·œ ê°€ì… ë¶ˆê°€</p>
              </div>
            </section>
            <footer class="modal-card-foot">
              <button class="button is-primary" onclick="savePlan()">ì €ì¥</button>
              <button class="button" onclick="closePlanModal()">ì·¨ì†Œ</button>
            </footer>
          </div>
        </div>
      `;
      
      await loadPlanList();
    }
    
    async function loadPlanList() {
      try {
        const response = await fetch('/admin/api/plans', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const data = await response.json();
        const tbody = document.getElementById('planTableBody');
        
        if (!data.plans || data.plans.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered">í”Œëœì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.plans.map(plan => {
          const statusTag = plan.is_active 
            ? '<span class="tag is-success">íŒë§¤ì¤‘</span>' 
            : '<span class="tag is-light">ë¹„í™œì„±</span>';
          
          const limitText = plan.daily_rx_limit 
            ? plan.daily_rx_limit.toLocaleString() + 'ê±´'
            : '<span class="tag is-info">ë¬´ì œí•œ</span>';
          
          return `
            <tr>
              <td><strong>${plan.plan_code}</strong></td>
              <td>${plan.plan_name}</td>
              <td><strong>${plan.monthly_price.toLocaleString()}ì›</strong></td>
              <td>${limitText}</td>
              <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${plan.description || ''}">${plan.description || '-'}</td>
              <td>${statusTag}</td>
              <td>${new Date(plan.created_at).toLocaleDateString('ko-KR')}</td>
              <td>
                <div class="buttons are-small">
                  <button class="button is-info is-small" onclick="editPlan('${plan.plan_id}')">
                    <span class="icon"><i class="fas fa-edit"></i></span>
                  </button>
                  <button class="button is-danger is-small" onclick="deletePlan('${plan.plan_id}')">
                    <span class="icon"><i class="fas fa-trash"></i></span>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        console.error('í”Œëœ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('planTableBody').innerHTML = 
          '<tr><td colspan="8" class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
      }
    }
    
    function openPlanModal() {
      document.getElementById('planModalTitle').textContent = 'í”Œëœ ì¶”ê°€';
      document.getElementById('planId').value = '';
      document.getElementById('planCode').value = '';
      document.getElementById('planName').value = '';
      document.getElementById('planPrice').value = '';
      document.getElementById('planLimit').value = '';
      document.getElementById('planDescription').value = '';
      document.getElementById('planIsActive').checked = true;
      document.getElementById('planCode').disabled = false;
      document.getElementById('planModal').classList.add('is-active');
    }
    
    function closePlanModal() {
      document.getElementById('planModal').classList.remove('is-active');
    }
    
    async function editPlan(planId) {
      try {
        const response = await fetch('/admin/api/plans', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const data = await response.json();
        const plan = data.plans.find(p => p.plan_id === planId);
        
        if (!plan) {
          alert('í”Œëœì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        document.getElementById('planModalTitle').textContent = 'í”Œëœ ìˆ˜ì •';
        document.getElementById('planId').value = plan.plan_id;
        document.getElementById('planCode').value = plan.plan_code;
        document.getElementById('planName').value = plan.plan_name;
        document.getElementById('planPrice').value = plan.monthly_price;
        document.getElementById('planLimit').value = plan.daily_rx_limit || '';
        document.getElementById('planDescription').value = plan.description || '';
        document.getElementById('planIsActive').checked = plan.is_active;
        document.getElementById('planCode').disabled = false;
        document.getElementById('planModal').classList.add('is-active');
        
      } catch (error) {
        console.error('í”Œëœ ì¡°íšŒ ì˜¤ë¥˜:', error);
        alert('í”Œëœì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    async function savePlan() {
      const planId = document.getElementById('planId').value;
      const plan_code = document.getElementById('planCode').value.trim();
      const plan_name = document.getElementById('planName').value.trim();
      const monthly_price = document.getElementById('planPrice').value;
      const daily_rx_limit = document.getElementById('planLimit').value;
      const description = document.getElementById('planDescription').value.trim();
      const is_active = document.getElementById('planIsActive').checked;
      
      if (!plan_code || !plan_name || !monthly_price) {
        alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const url = planId 
          ? '/admin/api/plans/' + planId 
          : '/admin/api/plans';
        const method = planId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token'),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            plan_code,
            plan_name,
            monthly_price: parseInt(monthly_price),
            daily_rx_limit: daily_rx_limit ? parseInt(daily_rx_limit) : null,
            description,
            is_active
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(planId ? 'í”Œëœì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'í”Œëœì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closePlanModal();
          loadPlanList();
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
        
      } catch (error) {
        console.error('í”Œëœ ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    async function deletePlan(planId) {
      if (!confirm('ì •ë§ ì´ í”Œëœì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í”Œëœì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
      }
      
      try {
        const response = await fetch('/admin/api/plans/' + planId, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('í”Œëœì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadPlanList();
        } else {
          alert('ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
        
      } catch (error) {
        console.error('í”Œëœ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ===========================
    // í”„ë¡œëª¨ì…˜ ê´€ë¦¬ í˜ì´ì§€
    // ===========================
    
    async function loadPromotionsPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <h1 class="title">í”„ë¡œëª¨ì…˜ ê´€ë¦¬</h1>
        
        <div class="box">
          <div class="level">
            <div class="level-left">
              <div class="level-item">
                <h5 class="title is-5">í”„ë¡œëª¨ì…˜ ëª©ë¡</h5>
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                <button class="button is-primary" onclick="openPromotionModal()">
                  <span class="icon"><i class="fas fa-plus"></i></span>
                  <span>í”„ë¡œëª¨ì…˜ ì¶”ê°€</span>
                </button>
              </div>
            </div>
          </div>
          
          <div class="table-container">
            <table class="table is-fullwidth is-hoverable">
              <thead>
                <tr>
                  <th>ì½”ë“œ</th>
                  <th>í”„ë¡œëª¨ì…˜ëª…</th>
                  <th>í• ì¸ ìœ í˜•</th>
                  <th>í• ì¸ ê°’</th>
                  <th>ë¬´ë£Œ ê°œì›”</th>
                  <th>ê¸°ê°„</th>
                  <th style="width: 100px;">ìƒíƒœ</th>
                  <th style="width: 150px;">ê´€ë¦¬</th>
                </tr>
              </thead>
              <tbody id="promotionTableBody">
                <tr>
                  <td colspan="8" class="has-text-centered">ë¡œë”© ì¤‘...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- í”„ë¡œëª¨ì…˜ ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
        <div class="modal" id="promotionModal">
          <div class="modal-background" onclick="closePromotionModal()"></div>
          <div class="modal-card" style="width: 800px;">
            <header class="modal-card-head">
              <p class="modal-card-title" id="promotionModalTitle">í”„ë¡œëª¨ì…˜ ì¶”ê°€</p>
              <button class="delete" aria-label="close" onclick="closePromotionModal()"></button>
            </header>
            <section class="modal-card-body">
              <input type="hidden" id="promotionId">
              
              <div class="columns">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">í”„ë¡œëª¨ì…˜ ì½”ë“œ <span class="has-text-danger">*</span></label>
                    <div class="control">
                      <input class="input" type="text" id="promotionCode" placeholder="ì˜ˆ: FREE_1MONTH">
                    </div>
                    <p class="help">ì˜ë¬¸, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´ë§Œ ì‚¬ìš©</p>
                  </div>
                </div>
                <div class="column is-6">
                  <div class="field">
                    <label class="label">í”„ë¡œëª¨ì…˜ëª… <span class="has-text-danger">*</span></label>
                    <div class="control">
                      <input class="input" type="text" id="promotionName" placeholder="ì˜ˆ: 1ê°œì›” ë¬´ë£Œ ì´ë²¤íŠ¸">
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="columns">
                <div class="column is-4">
                  <div class="field">
                    <label class="label">í• ì¸ ìœ í˜• <span class="has-text-danger">*</span></label>
                    <div class="control">
                      <div class="select is-fullwidth">
                        <select id="promotionDiscountType" onchange="updateDiscountFields()">
                          <option value="free">ì™„ì „ ë¬´ë£Œ</option>
                          <option value="percent">í¼ì„¼íŠ¸ í• ì¸</option>
                          <option value="amount">ì •ì•¡ í• ì¸</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="column is-4">
                  <div class="field" id="discountValueField">
                    <label class="label">í• ì¸ ê°’</label>
                    <div class="control">
                      <input class="input" type="number" id="promotionDiscountValue" placeholder="ì˜ˆ: 10 ë˜ëŠ” 5000" min="0">
                    </div>
                    <p class="help" id="discountValueHelp">í¼ì„¼íŠ¸ ë˜ëŠ” ì› ë‹¨ìœ„</p>
                  </div>
                </div>
                <div class="column is-4">
                  <div class="field">
                    <label class="label">ë¬´ë£Œ ì œê³µ ê°œì›”</label>
                    <div class="control">
                      <input class="input" type="number" id="promotionFreeMonths" placeholder="ì˜ˆ: 1" min="0">
                    </div>
                    <p class="help">ë¹„ì›Œë‘ë©´ ì œí•œ ì—†ìŒ</p>
                  </div>
                </div>
              </div>
              
              <div class="columns">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">ì‹œì‘ì¼ì‹œ</label>
                    <div class="control">
                      <input class="input" type="datetime-local" id="promotionStartAt">
                    </div>
                    <p class="help">ë¹„ì›Œë‘ë©´ ì¦‰ì‹œ ì ìš©</p>
                  </div>
                </div>
                <div class="column is-6">
                  <div class="field">
                    <label class="label">ì¢…ë£Œì¼ì‹œ</label>
                    <div class="control">
                      <input class="input" type="datetime-local" id="promotionEndAt">
                    </div>
                    <p class="help">ë¹„ì›Œë‘ë©´ ë¬´ì œí•œ</p>
                  </div>
                </div>
              </div>
              
              <div class="field">
                <label class="label">í™œì„±í™” ìƒíƒœ</label>
                <div class="control">
                  <label class="checkbox">
                    <input type="checkbox" id="promotionIsActive" checked>
                    í™œì„±í™” (ì‹ ê·œ ì‚¬ìš© ê°€ëŠ¥)
                  </label>
                </div>
              </div>
            </section>
            <footer class="modal-card-foot">
              <button class="button is-primary" onclick="savePromotion()">ì €ì¥</button>
              <button class="button" onclick="closePromotionModal()">ì·¨ì†Œ</button>
            </footer>
          </div>
        </div>
      `;
      
      await loadPromotionList();
    }
    
    function updateDiscountFields() {
      const discountType = document.getElementById('promotionDiscountType').value;
      const discountValueField = document.getElementById('discountValueField');
      const discountValueInput = document.getElementById('promotionDiscountValue');
      const discountValueHelp = document.getElementById('discountValueHelp');
      
      if (discountType === 'free') {
        discountValueField.style.display = 'none';
        discountValueInput.value = '';
      } else {
        discountValueField.style.display = 'block';
        if (discountType === 'percent') {
          discountValueHelp.textContent = 'í¼ì„¼íŠ¸ (ì˜ˆ: 50 = 50% í• ì¸)';
          discountValueInput.placeholder = 'ì˜ˆ: 50';
        } else if (discountType === 'amount') {
          discountValueHelp.textContent = 'ì› ë‹¨ìœ„ (ì˜ˆ: 5000 = 5,000ì› í• ì¸)';
          discountValueInput.placeholder = 'ì˜ˆ: 5000';
        }
      }
    }
    
    async function loadPromotionList() {
      try {
        const response = await fetch('/admin/api/promotions', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const data = await response.json();
        const tbody = document.getElementById('promotionTableBody');
        
        if (!data.promotions || data.promotions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered">í”„ë¡œëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.promotions.map(promo => {
          const statusTag = promo.is_active 
            ? '<span class="tag is-success">í™œì„±</span>' 
            : '<span class="tag is-light">ë¹„í™œì„±</span>';
          
          let discountText = '';
          if (promo.discount_type === 'free') {
            discountText = '<span class="tag is-success">ì™„ì „ ë¬´ë£Œ</span>';
          } else if (promo.discount_type === 'percent') {
            discountText = `${promo.discount_value}% í• ì¸`;
          } else if (promo.discount_type === 'amount') {
            discountText = `${(promo.discount_value || 0).toLocaleString()}ì› í• ì¸`;
          }
          
          const freeMonthsText = promo.free_months 
            ? `${promo.free_months}ê°œì›”` 
            : '-';
          
          const periodText = (() => {
            if (promo.start_at && promo.end_at) {
              return `${new Date(promo.start_at).toLocaleDateString()} ~ ${new Date(promo.end_at).toLocaleDateString()}`;
            } else if (promo.start_at) {
              return `${new Date(promo.start_at).toLocaleDateString()} ~`;
            } else if (promo.end_at) {
              return `~ ${new Date(promo.end_at).toLocaleDateString()}`;
            } else {
              return 'ë¬´ì œí•œ';
            }
          })();
          
          return `
            <tr>
              <td><strong>${promo.promotion_code}</strong></td>
              <td>${promo.promotion_name}</td>
              <td>${discountText}</td>
              <td>${promo.discount_value || '-'}</td>
              <td>${freeMonthsText}</td>
              <td style="font-size: 0.85rem;">${periodText}</td>
              <td>${statusTag}</td>
              <td>
                <div class="buttons are-small">
                  <button class="button is-info is-small" onclick="editPromotion('${promo.promotion_id}')">
                    <span class="icon"><i class="fas fa-edit"></i></span>
                  </button>
                  <button class="button is-danger is-small" onclick="deletePromotion('${promo.promotion_id}')">
                    <span class="icon"><i class="fas fa-trash"></i></span>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        console.error('í”„ë¡œëª¨ì…˜ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('promotionTableBody').innerHTML = 
          '<tr><td colspan="8" class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
      }
    }
    
    function openPromotionModal() {
      document.getElementById('promotionModalTitle').textContent = 'í”„ë¡œëª¨ì…˜ ì¶”ê°€';
      document.getElementById('promotionId').value = '';
      document.getElementById('promotionCode').value = '';
      document.getElementById('promotionName').value = '';
      document.getElementById('promotionDiscountType').value = 'free';
      document.getElementById('promotionDiscountValue').value = '';
      document.getElementById('promotionFreeMonths').value = '';
      document.getElementById('promotionStartAt').value = '';
      document.getElementById('promotionEndAt').value = '';
      document.getElementById('promotionIsActive').checked = true;
      updateDiscountFields();
      document.getElementById('promotionModal').classList.add('is-active');
    }
    
    function closePromotionModal() {
      document.getElementById('promotionModal').classList.remove('is-active');
    }
    
    async function editPromotion(promotionId) {
      try {
        const response = await fetch('/admin/api/promotions', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const data = await response.json();
        const promo = data.promotions.find(p => p.promotion_id === promotionId);
        
        if (!promo) {
          alert('í”„ë¡œëª¨ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        document.getElementById('promotionModalTitle').textContent = 'í”„ë¡œëª¨ì…˜ ìˆ˜ì •';
        document.getElementById('promotionId').value = promo.promotion_id;
        document.getElementById('promotionCode').value = promo.promotion_code;
        document.getElementById('promotionName').value = promo.promotion_name;
        document.getElementById('promotionDiscountType').value = promo.discount_type;
        document.getElementById('promotionDiscountValue').value = promo.discount_value || '';
        document.getElementById('promotionFreeMonths').value = promo.free_months || '';
        document.getElementById('promotionStartAt').value = promo.start_at ? new Date(promo.start_at).toISOString().slice(0, 16) : '';
        document.getElementById('promotionEndAt').value = promo.end_at ? new Date(promo.end_at).toISOString().slice(0, 16) : '';
        document.getElementById('promotionIsActive').checked = promo.is_active;
        updateDiscountFields();
        document.getElementById('promotionModal').classList.add('is-active');
        
      } catch (error) {
        console.error('í”„ë¡œëª¨ì…˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
        alert('í”„ë¡œëª¨ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    async function savePromotion() {
      const promotionId = document.getElementById('promotionId').value;
      const promotion_code = document.getElementById('promotionCode').value.trim();
      const promotion_name = document.getElementById('promotionName').value.trim();
      const discount_type = document.getElementById('promotionDiscountType').value;
      const discount_value = document.getElementById('promotionDiscountValue').value;
      const free_months = document.getElementById('promotionFreeMonths').value;
      const start_at = document.getElementById('promotionStartAt').value;
      const end_at = document.getElementById('promotionEndAt').value;
      const is_active = document.getElementById('promotionIsActive').checked;
      
      if (!promotion_code || !promotion_name || !discount_type) {
        alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const url = promotionId 
          ? '/admin/api/promotions/' + promotionId 
          : '/admin/api/promotions';
        const method = promotionId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token'),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            promotion_code,
            promotion_name,
            discount_type,
            discount_value: discount_value ? parseInt(discount_value) : null,
            free_months: free_months ? parseInt(free_months) : null,
            start_at: start_at || null,
            end_at: end_at || null,
            is_active
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(promotionId ? 'í”„ë¡œëª¨ì…˜ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'í”„ë¡œëª¨ì…˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closePromotionModal();
          loadPromotionList();
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
        
      } catch (error) {
        console.error('í”„ë¡œëª¨ì…˜ ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    async function deletePromotion(promotionId) {
      if (!confirm('ì •ë§ ì´ í”„ë¡œëª¨ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì‚¬ìš© ì¤‘ì´ê±°ë‚˜ ì¶”ì²œì¸ ì½”ë“œì™€ ì—°ê²°ëœ í”„ë¡œëª¨ì…˜ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
      }
      
      try {
        const response = await fetch('/admin/api/promotions/' + promotionId, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('í”„ë¡œëª¨ì…˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadPromotionList();
        } else {
          alert('ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
        
      } catch (error) {
        console.error('í”„ë¡œëª¨ì…˜ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ===========================
    // ì¶”ì²œì¸ ì½”ë“œ ê´€ë¦¬ í˜ì´ì§€
    // ===========================
    
    async function loadReferralCodesPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <h1 class="title">ì¶”ì²œì¸ ì½”ë“œ ê´€ë¦¬</h1>
        
        <div class="box">
          <div class="level">
            <div class="level-left">
              <div class="level-item">
                <h5 class="title is-5">ì¶”ì²œì¸ ì½”ë“œ ëª©ë¡</h5>
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                <button class="button is-primary" onclick="openReferralCodeModal()">
                  <span class="icon"><i class="fas fa-plus"></i></span>
                  <span>ì¶”ì²œì¸ ì½”ë“œ ì¶”ê°€</span>
                </button>
              </div>
            </div>
          </div>
          
          <div class="table-container">
            <table class="table is-fullwidth is-hoverable">
              <thead>
                <tr>
                  <th>ì½”ë“œ</th>
                  <th>ì—°ê²° í”„ë¡œëª¨ì…˜</th>
                  <th>ì„¤ëª…</th>
                  <th>ì‚¬ìš© íšŸìˆ˜</th>
                  <th>ìµœëŒ€ ì‚¬ìš©</th>
                  <th>ë§Œë£Œì¼</th>
                  <th style="width: 100px;">ìƒíƒœ</th>
                  <th style="width: 150px;">ê´€ë¦¬</th>
                </tr>
              </thead>
              <tbody id="referralCodeTableBody">
                <tr>
                  <td colspan="8" class="has-text-centered">ë¡œë”© ì¤‘...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- ì¶”ì²œì¸ ì½”ë“œ ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
        <div class="modal" id="referralCodeModal">
          <div class="modal-background" onclick="closeReferralCodeModal()"></div>
          <div class="modal-card" style="width: 700px;">
            <header class="modal-card-head">
              <p class="modal-card-title" id="referralCodeModalTitle">ì¶”ì²œì¸ ì½”ë“œ ì¶”ê°€</p>
              <button class="delete" aria-label="close" onclick="closeReferralCodeModal()"></button>
            </header>
            <section class="modal-card-body">
              <input type="hidden" id="referralCodeId">
              
              <div class="columns">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">ì¶”ì²œì¸ ì½”ë“œ <span class="has-text-danger">*</span></label>
                    <div class="control">
                      <input class="input" type="text" id="referralCode" placeholder="ì˜ˆ: WELCOME2025">
                    </div>
                    <p class="help">ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš© ê¶Œì¥</p>
                  </div>
                </div>
                <div class="column is-6">
                  <div class="field">
                    <label class="label">ì—°ê²° í”„ë¡œëª¨ì…˜ <span class="has-text-danger">*</span></label>
                    <div class="control">
                      <div class="select is-fullwidth">
                        <select id="referralPromotionId">
                          <option value="">ë¡œë”© ì¤‘...</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="field">
                <label class="label">ì„¤ëª…</label>
                <div class="control">
                  <textarea class="textarea" id="referralDescription" placeholder="ì˜ì—…ìš©, ì´ë²¤íŠ¸ìš© ë“±" rows="2"></textarea>
                </div>
              </div>
              
              <div class="columns">
                <div class="column is-6">
                  <div class="field">
                    <label class="label">ìµœëŒ€ ì‚¬ìš© íšŸìˆ˜</label>
                    <div class="control">
                      <input class="input" type="number" id="referralMaxUses" placeholder="ë¹„ì›Œë‘ë©´ ë¬´ì œí•œ" min="0">
                    </div>
                    <p class="help">ë¹„ì›Œë‘ë©´ ì œí•œ ì—†ìŒ</p>
                  </div>
                </div>
                <div class="column is-6">
                  <div class="field">
                    <label class="label">ë§Œë£Œì¼</label>
                    <div class="control">
                      <input class="input" type="datetime-local" id="referralExpiresAt">
                    </div>
                    <p class="help">ë¹„ì›Œë‘ë©´ ë¬´ì œí•œ</p>
                  </div>
                </div>
              </div>
              
              <div class="field">
                <label class="label">í™œì„±í™” ìƒíƒœ</label>
                <div class="control">
                  <label class="checkbox">
                    <input type="checkbox" id="referralIsActive" checked>
                    í™œì„±í™” (ì‚¬ìš© ê°€ëŠ¥)
                  </label>
                </div>
              </div>
            </section>
            <footer class="modal-card-foot">
              <button class="button is-primary" onclick="saveReferralCode()">ì €ì¥</button>
              <button class="button" onclick="closeReferralCodeModal()">ì·¨ì†Œ</button>
            </footer>
          </div>
        </div>
      `;
      
      await loadReferralCodeList();
      await loadPromotionsForSelect();
    }
    
    async function loadPromotionsForSelect() {
      try {
        const response = await fetch('/admin/api/promotions', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const data = await response.json();
        const select = document.getElementById('referralPromotionId');
        
        if (data.promotions && data.promotions.length > 0) {
          select.innerHTML = '<option value="">í”„ë¡œëª¨ì…˜ ì„ íƒ</option>' + 
            data.promotions
              .filter(p => p.is_active)
              .map(p => `<option value="${p.promotion_id}">${p.promotion_name} (${p.promotion_code})</option>`)
              .join('');
        } else {
          select.innerHTML = '<option value="">ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œëª¨ì…˜ ì—†ìŒ</option>';
        }
      } catch (error) {
        console.error('í”„ë¡œëª¨ì…˜ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
      }
    }
    
    async function loadReferralCodeList() {
      try {
        const response = await fetch('/admin/api/referral-codes', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const data = await response.json();
        const tbody = document.getElementById('referralCodeTableBody');
        
        if (!data.referralCodes || data.referralCodes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered">ì¶”ì²œì¸ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.referralCodes.map(code => {
          const statusTag = code.is_active 
            ? '<span class="tag is-success">í™œì„±</span>' 
            : '<span class="tag is-light">ë¹„í™œì„±</span>';
          
          const promotionName = code.subscription_promotions?.promotion_name || '(ì‚­ì œë¨)';
          const maxUsesText = code.max_uses ? code.max_uses.toLocaleString() : 'ë¬´ì œí•œ';
          const expiresText = code.expires_at 
            ? new Date(code.expires_at).toLocaleDateString('ko-KR')
            : 'ë¬´ì œí•œ';
          
          return `
            <tr>
              <td><strong>${code.code}</strong></td>
              <td>${promotionName}</td>
              <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${code.description || '-'}</td>
              <td><strong>${code.used_count}</strong></td>
              <td>${maxUsesText}</td>
              <td>${expiresText}</td>
              <td>${statusTag}</td>
              <td>
                <div class="buttons are-small">
                  <button class="button is-info is-small" onclick="editReferralCode('${code.referral_code_id}')">
                    <span class="icon"><i class="fas fa-edit"></i></span>
                  </button>
                  <button class="button is-danger is-small" onclick="deleteReferralCode('${code.referral_code_id}')">
                    <span class="icon"><i class="fas fa-trash"></i></span>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        console.error('ì¶”ì²œì¸ ì½”ë“œ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('referralCodeTableBody').innerHTML = 
          '<tr><td colspan="8" class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
      }
    }
    
    function openReferralCodeModal() {
      document.getElementById('referralCodeModalTitle').textContent = 'ì¶”ì²œì¸ ì½”ë“œ ì¶”ê°€';
      document.getElementById('referralCodeId').value = '';
      document.getElementById('referralCode').value = '';
      document.getElementById('referralPromotionId').value = '';
      document.getElementById('referralDescription').value = '';
      document.getElementById('referralMaxUses').value = '';
      document.getElementById('referralExpiresAt').value = '';
      document.getElementById('referralIsActive').checked = true;
      document.getElementById('referralCodeModal').classList.add('is-active');
    }
    
    function closeReferralCodeModal() {
      document.getElementById('referralCodeModal').classList.remove('is-active');
    }
    
    async function editReferralCode(referralCodeId) {
      try {
        const response = await fetch('/admin/api/referral-codes', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const data = await response.json();
        const code = data.referralCodes.find(c => c.referral_code_id === referralCodeId);
        
        if (!code) {
          alert('ì¶”ì²œì¸ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        document.getElementById('referralCodeModalTitle').textContent = 'ì¶”ì²œì¸ ì½”ë“œ ìˆ˜ì •';
        document.getElementById('referralCodeId').value = code.referral_code_id;
        document.getElementById('referralCode').value = code.code;
        document.getElementById('referralPromotionId').value = code.promotion_id;
        document.getElementById('referralDescription').value = code.description || '';
        document.getElementById('referralMaxUses').value = code.max_uses || '';
        document.getElementById('referralExpiresAt').value = code.expires_at ? new Date(code.expires_at).toISOString().slice(0, 16) : '';
        document.getElementById('referralIsActive').checked = code.is_active;
        document.getElementById('referralCodeModal').classList.add('is-active');
        
      } catch (error) {
        console.error('ì¶”ì²œì¸ ì½”ë“œ ì¡°íšŒ ì˜¤ë¥˜:', error);
        alert('ì¶”ì²œì¸ ì½”ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    async function saveReferralCode() {
      const referralCodeId = document.getElementById('referralCodeId').value;
      const code = document.getElementById('referralCode').value.trim();
      const promotion_id = document.getElementById('referralPromotionId').value;
      const description = document.getElementById('referralDescription').value.trim();
      const max_uses = document.getElementById('referralMaxUses').value;
      const expires_at = document.getElementById('referralExpiresAt').value;
      const is_active = document.getElementById('referralIsActive').checked;
      
      if (!code || !promotion_id) {
        alert('ì¶”ì²œì¸ ì½”ë“œì™€ í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const url = referralCodeId 
          ? '/admin/api/referral-codes/' + referralCodeId 
          : '/admin/api/referral-codes';
        const method = referralCodeId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token'),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            code,
            promotion_id,
            description,
            max_uses: max_uses ? parseInt(max_uses) : null,
            expires_at: expires_at || null,
            is_active
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(referralCodeId ? 'ì¶”ì²œì¸ ì½”ë“œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì¶”ì²œì¸ ì½”ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeReferralCodeModal();
          loadReferralCodeList();
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
        
      } catch (error) {
        console.error('ì¶”ì²œì¸ ì½”ë“œ ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    async function deleteReferralCode(referralCodeId) {
      if (!confirm('ì •ë§ ì´ ì¶”ì²œì¸ ì½”ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ë¯¸ ì‚¬ìš©ëœ ì½”ë“œëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
      }
      
      try {
        const response = await fetch('/admin/api/referral-codes/' + referralCodeId, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('ì¶”ì²œì¸ ì½”ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadReferralCodeList();
        } else {
          alert('ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
        
      } catch (error) {
        console.error('ì¶”ì²œì¸ ì½”ë“œ ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ===========================
    // ===========================
    // ===========================
    // í”„ë¡œëª¨ì…˜ í• ë‹¹ í˜ì´ì§€ (LLM ì„¤ê³„ ê¸°ë°˜ ì „ë©´ ì¬êµ¬ì„±)
    // ===========================
    
    async function loadAssignPromotionPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <style>
          .has-tooltip-arrow {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted #aaa;
          }
          
          .candidate-row:hover {
            background-color: #f0f8ff;
          }
          
          .status-reserved { color: #3273dc; }
          .status-selected { color: #ff9800; }
          .status-applied { color: #48c774; }
          .status-expired { color: #888; }
          .status-cancelled { color: #f14668; }
        </style>
        
        <div id="promotionAssignPage">
          <h1 class="title">í”„ë¡œëª¨ì…˜ í• ë‹¹ ê´€ë¦¬</h1>
          <p class="subtitle">ì²« ê²°ì œ ì˜ˆì • ê³ ê° ëŒ€ìƒ í”„ë¡œëª¨ì…˜ ìš´ì˜</p>

          <!-- â‘  ìƒë‹¨: í”„ë¡œëª¨ì…˜ ëŒ€ìƒ íšŒì› ë¦¬ìŠ¤íŠ¸ (ë©”ì¸ í…Œì´ë¸”) -->
          <div class="box">
            <div class="level">
              <div class="level-left">
                <div class="level-item">
                  <h5 class="title is-5">ğŸ“‹ ì²« ê²°ì œ ì˜ˆì • ê³ ê° ëª©ë¡</h5>
                </div>
              </div>
              <div class="level-right">
                <div class="level-item">
                  <div class="field has-addons">
                    <div class="control">
                      <input class="input" type="text" placeholder="ì•½ì‚¬ëª… ê²€ìƒ‰" id="filterPharmacistName">
                    </div>
                    <div class="control">
                      <input class="input" type="text" placeholder="ì•½êµ­ëª… ê²€ìƒ‰" id="filterPharmacyName">
                    </div>
                    <div class="control">
                      <button class="button is-info" onclick="assignPromotionLoadCandidates()">
                        <span class="icon"><i class="fas fa-search"></i></span>
                        <span>ê²€ìƒ‰</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="table-container">
              <table class="table is-fullwidth is-hoverable is-striped">
                <thead>
                  <tr>
                    <th style="width: 50px;">
                      <input type="checkbox" id="selectAllCandidates" onchange="assignPromotionToggleSelectAll()">
                    </th>
                    <th>íšŒì›ëª… / ì•½êµ­ëª…</th>
                    <th>ì‚¬ì—…ìë²ˆí˜¸</th>
                    <th>ê°€ì…ì¼</th>
                    <th>êµ¬ë… ìƒíƒœ</th>
                    <th>
                      <span class="has-tooltip-arrow" data-tooltip="billing_payments ê¸°ì¤€ ì²« ê²°ì œ ì—¬ë¶€">
                        ì²« ê²°ì œ ì—¬ë¶€ â„¹ï¸
                      </span>
                    </th>
                    <th>ë‹¤ìŒ ê²°ì œ ì˜ˆì •ì¼</th>
                    <th>í”„ë¡œëª¨ì…˜ ìƒíƒœ</th>
                    <th style="width: 150px;">ì•¡ì…˜</th>
                  </tr>
                </thead>
                <tbody id="candidatesTableBody">
                  <tr>
                    <td colspan="9" class="has-text-centered">ë¡œë”© ì¤‘...</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- ì„ íƒëœ íšŒì› ìˆ˜ í‘œì‹œ -->
            <div class="notification is-light" id="selectedCountNotification" style="display: none;">
              <strong id="selectedCountText">0ëª… ì„ íƒë¨</strong>
              <button class="delete" onclick="assignPromotionClearSelection()"></button>
            </div>

            <!-- í•˜ë‹¨: í”„ë¡œëª¨ì…˜ í• ë‹¹ ì˜ì—­ -->
            <div class="box has-background-light" id="bulkAssignSection" style="display: none;">
              <h6 class="title is-6">ğŸ ì„ íƒí•œ íšŒì›ì—ê²Œ í”„ë¡œëª¨ì…˜ í• ë‹¹</h6>
              
              <div class="columns">
                <div class="column is-8">
                  <div class="field">
                    <label class="label">í”„ë¡œëª¨ì…˜ ì„ íƒ <span class="has-text-danger">*</span></label>
                    <div class="control">
                      <div class="select is-fullwidth">
                        <select id="bulkPromotionSelect">
                          <option value="">í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                      </div>
                    </div>
                    <p class="help">âœ… ì²« ê²°ì œ ì „ìš© í”„ë¡œëª¨ì…˜ë§Œ í‘œì‹œë©ë‹ˆë‹¤</p>
                  </div>
                </div>
                <div class="column is-4">
                  <label class="label">ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
                  <div class="control">
                    <input class="input" type="text" placeholder="ì˜ˆ: ì˜¤í”ˆ ì´ë²¤íŠ¸" id="bulkAssignMemo">
                  </div>
                </div>
              </div>

              <div class="field">
                <div class="control">
                  <button class="button is-primary" onclick="assignPromotionExecuteBulkAssign()">
                    <span class="icon"><i class="fas fa-paper-plane"></i></span>
                    <span id="bulkAssignButtonText">0ëª…ì—ê²Œ í”„ë¡œëª¨ì…˜ í• ë‹¹</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- â‘¡ íšŒì› ìƒì„¸ íŒ¨ë„ (Modal) -->
          <div class="modal" id="userDetailModal">
            <div class="modal-background" onclick="assignPromotionCloseUserDetailModal()"></div>
            <div class="modal-card" style="width: 900px;">
              <header class="modal-card-head">
                <p class="modal-card-title">ğŸ” íšŒì› ìƒì„¸ ì •ë³´ ë° í”„ë¡œëª¨ì…˜ íŒë‹¨</p>
                <button class="delete" aria-label="close" onclick="assignPromotionCloseUserDetailModal()"></button>
              </header>
              <section class="modal-card-body">
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="box">
                  <h6 class="title is-6">ê¸°ë³¸ ì •ë³´</h6>
                  <div class="columns is-multiline" id="userBasicInfo">
                    <div class="column is-6">
                      <strong>ì•½ì‚¬ëª…:</strong> <span id="detailPharmacistName">-</span>
                    </div>
                    <div class="column is-6">
                      <strong>ì•½êµ­ëª…:</strong> <span id="detailPharmacyName">-</span>
                    </div>
                    <div class="column is-6">
                      <strong>ì´ë©”ì¼:</strong> <span id="detailEmail">-</span>
                    </div>
                    <div class="column is-6">
                      <strong>ì „í™”ë²ˆí˜¸:</strong> <span id="detailPhone">-</span>
                    </div>
                    <div class="column is-12">
                      <strong>ì‚¬ì—…ìë²ˆí˜¸:</strong> <span id="detailBusinessNumber">-</span>
                    </div>
                  </div>
                </div>

                <!-- (A) í”„ë¡œëª¨ì…˜ ì´ë ¥ ìš”ì•½ -->
                <div class="box has-background-warning-light">
                  <h6 class="title is-6">ğŸ“Š í”„ë¡œëª¨ì…˜ ì´ë ¥ ìš”ì•½</h6>
                  <div id="promotionHistorySummary">
                    <p class="has-text-centered">ë¡œë”© ì¤‘...</p>
                  </div>
                </div>

                <!-- (B) êµ¬ë… / ê²°ì œ ìƒíƒœ ìš”ì•½ -->
                <div class="box has-background-info-light">
                  <h6 class="title is-6">ğŸ’³ êµ¬ë… / ê²°ì œ ìƒíƒœ</h6>
                  <div id="subscriptionSummary">
                    <p class="has-text-centered">ë¡œë”© ì¤‘...</p>
                  </div>
                </div>

                <!-- (C) ì˜ˆì•½ëœ í”„ë¡œëª¨ì…˜ -->
                <div class="box has-background-success-light">
                  <h6 class="title is-6">ğŸ ì˜ˆì•½ëœ í”„ë¡œëª¨ì…˜</h6>
                  <div id="pendingPromotionsList">
                    <p class="has-text-centered">ë¡œë”© ì¤‘...</p>
                  </div>
                </div>

                <!-- â‘¢ í”„ë¡œëª¨ì…˜ í• ë‹¹ ì•¡ì…˜ -->
                <div class="box has-background-light">
                  <h6 class="title is-6">ğŸ¯ ì´ íšŒì›ì—ê²Œ í”„ë¡œëª¨ì…˜ í• ë‹¹</h6>
                  
                  <div id="assignmentEligibilityCheck">
                    <!-- ìê²© íŒë‹¨ ë©”ì‹œì§€ê°€ ì—¬ê¸° í‘œì‹œë¨ -->
                  </div>

                  <div class="field">
                    <label class="label">í”„ë¡œëª¨ì…˜ ì„ íƒ</label>
                    <div class="control">
                      <div class="select is-fullwidth">
                        <select id="singlePromotionSelect">
                          <option value="">í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="field">
                    <label class="label">ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
                    <div class="control">
                      <input class="input" type="text" placeholder="ì˜ˆ: CS ëŒ€ì‘, ì˜ì—…ìš©" id="singleAssignMemo">
                    </div>
                  </div>

                  <div class="field">
                    <div class="control">
                      <button class="button is-primary" id="singleAssignButton" onclick="assignPromotionExecuteSingleAssign()">
                        <span class="icon"><i class="fas fa-paper-plane"></i></span>
                        <span>í”„ë¡œëª¨ì…˜ í• ë‹¹</span>
                      </button>
                    </div>
                  </div>
                </div>
              </section>
              <footer class="modal-card-foot">
                <button class="button" onclick="assignPromotionCloseUserDetailModal()">ë‹«ê¸°</button>
              </footer>
            </div>
          </div>

          <!-- â‘¡ ì˜ˆì•½ ê´€ë¦¬ ì„¹ì…˜ (ì•„ì§ ì ìš©ë˜ì§€ ì•Šì€ ì˜ˆì•½) -->
          <div class="box">
            <div class="level">
              <div class="level-left">
                <div class="level-item">
                  <h5 class="title is-5">ğŸ“ í”„ë¡œëª¨ì…˜ ì˜ˆì•½ ê´€ë¦¬</h5>
                  <p class="subtitle is-6 ml-3">ì•„ì§ ê²°ì œì— ì ìš©ë˜ì§€ ì•Šì€ ì˜ˆì•½ ëª©ë¡</p>
                </div>
              </div>
              <div class="level-right">
                <div class="level-item">
                  <button class="button is-light" onclick="assignPromotionLoadReservations()">
                    <span class="icon"><i class="fas fa-sync"></i></span>
                    <span>ìƒˆë¡œê³ ì¹¨</span>
                  </button>
                </div>
              </div>
            </div>

            <div class="table-container">
              <table class="table is-fullwidth is-hoverable">
                <thead>
                  <tr>
                    <th>íšŒì›</th>
                    <th>í”„ë¡œëª¨ì…˜</th>
                    <th>í• ì¸ ì •ë³´</th>
                    <th>ì˜ˆì•½ì¼</th>
                    <th>ìƒíƒœ</th>
                    <th>ì†ŒìŠ¤</th>
                    <th style="width: 100px;">ê´€ë¦¬</th>
                  </tr>
                </thead>
                <tbody id="reservationTableBody">
                  <tr>
                    <td colspan="7" class="has-text-centered">ë¡œë”© ì¤‘...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- â‘¢ í”„ë¡œëª¨ì…˜ ì ìš© ì´ë ¥ ì„¹ì…˜ (ì‹¤ì œ ê²°ì œì— ì‚¬ìš©ëœ í”„ë¡œëª¨ì…˜) -->
          <div class="box">
            <div class="level">
              <div class="level-left">
                <div class="level-item">
                  <h5 class="title is-5">ğŸ’° í”„ë¡œëª¨ì…˜ ì ìš© ì´ë ¥</h5>
                  <p class="subtitle is-6 ml-3">ì‹¤ì œ ê²°ì œì— ì‚¬ìš©ëœ í”„ë¡œëª¨ì…˜ ê¸°ë¡</p>
                </div>
              </div>
              <div class="level-right">
                <div class="level-item">
                  <button class="button is-light" onclick="assignPromotionLoadAppliedHistory()">
                    <span class="icon"><i class="fas fa-sync"></i></span>
                    <span>ìƒˆë¡œê³ ì¹¨</span>
                  </button>
                </div>
              </div>
            </div>

            <div class="table-container">
              <table class="table is-fullwidth is-hoverable">
                <thead>
                  <tr>
                    <th>íšŒì›</th>
                    <th>í”„ë¡œëª¨ì…˜</th>
                    <th>í• ì¸ ì •ë³´</th>
                    <th>ê²°ì œì¼</th>
                    <th>ê²°ì œ ê¸ˆì•¡</th>
                    <th>í”Œëœ</th>
                    <th>ì†ŒìŠ¤</th>
                    <th style="width: 100px;">ìƒì„¸</th>
                  </tr>
                </thead>
                <tbody id="appliedHistoryTableBody">
                  <tr>
                    <td colspan="8" class="has-text-centered">ë¡œë”© ì¤‘...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- íšŒì› ê²°ì œ ì´ë ¥ ìƒì„¸ ëª¨ë‹¬ -->
          <div class="modal" id="paymentDetailModal">
            <div class="modal-background" onclick="closePaymentDetailModal()"></div>
            <div class="modal-card" style="width: 900px;">
              <header class="modal-card-head">
                <p class="modal-card-title">ğŸ’³ íšŒì› í”„ë¡œëª¨ì…˜ ì ìš© ìƒì„¸</p>
                <button class="delete" aria-label="close" onclick="closePaymentDetailModal()"></button>
              </header>
              <section class="modal-card-body">
                <!-- íšŒì› ê¸°ë³¸ ì •ë³´ -->
                <div class="box">
                  <h6 class="title is-6">íšŒì› ì •ë³´</h6>
                  <div id="paymentDetailUserInfo">
                    <p class="has-text-centered">ë¡œë”© ì¤‘...</p>
                  </div>
                </div>

                <!-- í˜„ì¬ êµ¬ë… ìƒíƒœ -->
                <div class="box has-background-info-light">
                  <h6 class="title is-6">ğŸ“Š í˜„ì¬ êµ¬ë… ìƒíƒœ</h6>
                  <div id="paymentDetailSubscription">
                    <p class="has-text-centered">ë¡œë”© ì¤‘...</p>
                  </div>
                </div>

                <!-- í”„ë¡œëª¨ì…˜ ì ìš© ê²°ì œ ì´ë ¥ -->
                <div class="box has-background-warning-light">
                  <h6 class="title is-6">ğŸ’° í”„ë¡œëª¨ì…˜ ì ìš© ê²°ì œ ì´ë ¥</h6>
                  <div id="paymentDetailHistory">
                    <p class="has-text-centered">ë¡œë”© ì¤‘...</p>
                  </div>
                </div>
              </section>
              <footer class="modal-card-foot">
                <button class="button" onclick="closePaymentDetailModal()">ë‹«ê¸°</button>
              </footer>
            </div>
          </div>
        </div>
      `;
      
      await assignPromotionInitPage();
    }
    
    // ==== í”„ë¡œëª¨ì…˜ í• ë‹¹ ê´€ë ¨ í•¨ìˆ˜ë“¤ ====
    
    // ì „ì—­ ë³€ìˆ˜
    let promotionCandidatesList = [];
    let promotionSelectedCandidates = [];
    let promotionCurrentUserDetail = null;

    /**
     * í”„ë¡œëª¨ì…˜ í• ë‹¹ í˜ì´ì§€ ì´ˆê¸°í™”
     */
    async function assignPromotionInitPage() {
      await assignPromotionLoadCandidates();
      await assignPromotionLoadFirstPaymentPromotions();
      await assignPromotionLoadReservations();
      await assignPromotionLoadAppliedHistory();
      await assignPromotionLoadAssignmentList();
    }

    /**
     * ì²« ê²°ì œ ì˜ˆì • í›„ë³´ ëª©ë¡ ì¡°íšŒ
     */
    async function assignPromotionLoadCandidates() {
      const pharmacistName = document.getElementById('filterPharmacistName').value.trim();
      const pharmacyName = document.getElementById('filterPharmacyName').value.trim();

      try {
        const params = new URLSearchParams();
        if (pharmacistName) params.append('pharmacist_name', pharmacistName);
        if (pharmacyName) params.append('pharmacy_name', pharmacyName);

        const response = await fetch('/admin/api/assign-promotion/candidates?' + params, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });

        const data = await response.json();
        promotionCandidatesList = data.candidates || [];

        assignPromotionRenderCandidatesTable();
      } catch (error) {
        console.error('í›„ë³´ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('candidatesTableBody').innerHTML = 
          '<tr><td colspan="9" class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
      }
    }

    /**
     * í›„ë³´ ëª©ë¡ í…Œì´ë¸” ë Œë”ë§
     */
    function assignPromotionRenderCandidatesTable() {
      const tbody = document.getElementById('candidatesTableBody');

      if (promotionCandidatesList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="has-text-centered">ì²« ê²°ì œ ì˜ˆì • ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
      }

      tbody.innerHTML = promotionCandidatesList.map((user, index) => {
        const firstPaymentBadge = user.is_first_payment 
          ? '<span class="tag is-success">âœ… ì²« ê²°ì œ</span>' 
          : '<span class="tag is-danger">âŒ ê¸°ì¡´ ê³ ê°</span>';

        const subscriptionBadge = user.subscription_status 
          ? '<span class="tag is-info">' + user.subscription_status + '</span>' 
          : '<span class="tag is-light">ì—†ìŒ</span>';

        const promotionStatusBadge = user.has_pending_promotion
          ? '<span class="tag is-warning">ì˜ˆì•½ë¨</span>'
          : '<span class="tag is-light">ì—†ìŒ</span>';

        return `
          <tr class="candidate-row">
            <td class="has-text-centered">
              <input type="checkbox" class="candidate-checkbox" value="${user.user_id}" 
                data-index="${index}" onchange="assignPromotionUpdateSelectionState()">
            </td>
            <td>
              <strong>${user.pharmacist_name || '-'}</strong><br>
              <small>${user.pharmacy_name || '-'}</small>
            </td>
            <td><small>${user.business_number || '-'}</small></td>
            <td><small>${new Date(user.created_at).toLocaleDateString('ko-KR')}</small></td>
            <td>${subscriptionBadge}</td>
            <td>${firstPaymentBadge}</td>
            <td>${user.next_billing_at ? new Date(user.next_billing_at).toLocaleString('ko-KR') : '-'}</td>
            <td>${promotionStatusBadge}</td>
            <td>
              <button class="button is-small is-info" onclick="assignPromotionOpenUserDetailModal('${user.user_id}')">
                <span class="icon"><i class="fas fa-search"></i></span>
                <span>ìƒì„¸</span>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    /**
     * ì „ì²´ ì„ íƒ/í•´ì œ
     */
    function assignPromotionToggleSelectAll() {
      const selectAll = document.getElementById('selectAllCandidates').checked;
      const checkboxes = document.querySelectorAll('.candidate-checkbox');
      
      checkboxes.forEach(cb => cb.checked = selectAll);
      assignPromotionUpdateSelectionState();
    }

    /**
     * ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
     */
    function assignPromotionUpdateSelectionState() {
      const checkboxes = document.querySelectorAll('.candidate-checkbox:checked');
      promotionSelectedCandidates = Array.from(checkboxes).map(cb => {
        const index = parseInt(cb.dataset.index);
        return promotionCandidatesList[index];
      });

      const count = promotionSelectedCandidates.length;
      const notification = document.getElementById('selectedCountNotification');
      const bulkSection = document.getElementById('bulkAssignSection');
      const countText = document.getElementById('selectedCountText');
      const buttonText = document.getElementById('bulkAssignButtonText');

      if (count > 0) {
        notification.style.display = 'block';
        bulkSection.style.display = 'block';
        countText.textContent = count + 'ëª… ì„ íƒë¨';
        buttonText.textContent = count + 'ëª…ì—ê²Œ í”„ë¡œëª¨ì…˜ í• ë‹¹';
      } else {
        notification.style.display = 'none';
        bulkSection.style.display = 'none';
      }
    }

    /**
     * ì„ íƒ ì´ˆê¸°í™”
     */
    function assignPromotionClearSelection() {
      document.getElementById('selectAllCandidates').checked = false;
      document.querySelectorAll('.candidate-checkbox').forEach(cb => cb.checked = false);
      assignPromotionUpdateSelectionState();
    }

    /**
     * ì²« ê²°ì œ ì „ìš© í”„ë¡œëª¨ì…˜ ëª©ë¡ ë¡œë“œ
     */
    async function assignPromotionLoadFirstPaymentPromotions() {
      try {
        const response = await fetch('/admin/api/promotions', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });

        const data = await response.json();
        const promotions = (data.promotions || []).filter(p => p.is_active && p.first_payment_only);

        const options = promotions.map(p => {
          let discountInfo = '';
          if (p.discount_type === 'free') {
            discountInfo = p.free_months + 'ê°œì›” ë¬´ë£Œ';
          } else if (p.discount_type === 'percent') {
            discountInfo = p.discount_value + '% í• ì¸';
          } else if (p.discount_type === 'amount') {
            discountInfo = p.discount_value.toLocaleString() + 'ì› í• ì¸';
          }
          return '<option value="' + p.promotion_id + '">' + p.promotion_name + ' (' + discountInfo + ')</option>';
        }).join('');

        document.getElementById('bulkPromotionSelect').innerHTML = 
          '<option value="">í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>' + options;
        document.getElementById('singlePromotionSelect').innerHTML = 
          '<option value="">í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>' + options;

      } catch (error) {
        console.error('í”„ë¡œëª¨ì…˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
      }
    }

    /**
     * ì¼ê´„ í• ë‹¹ ì‹¤í–‰
     */
    async function assignPromotionExecuteBulkAssign() {
      const promotionId = document.getElementById('bulkPromotionSelect').value;
      const memo = document.getElementById('bulkAssignMemo').value.trim();

      if (!promotionId) {
        alert('í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (promotionSelectedCandidates.length === 0) {
        alert('í• ë‹¹ ëŒ€ìƒ íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!confirm(promotionSelectedCandidates.length + 'ëª…ì—ê²Œ í”„ë¡œëª¨ì…˜ì„ í• ë‹¹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        const response = await fetch('/admin/api/assign-promotion', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token'),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            promotion_id: promotionId,
            user_ids: promotionSelectedCandidates.map(u => u.user_id),
            memo: memo || null,
            source: 'admin_assigned'
          })
        });

        const result = await response.json();

        if (result.success) {
          alert(result.message || 'í”„ë¡œëª¨ì…˜ì´ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.');
          assignPromotionClearSelection();
          await assignPromotionLoadCandidates();
          await assignPromotionLoadAssignmentList();
        } else {
          alert('í• ë‹¹ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }

      } catch (error) {
        console.error('ì¼ê´„ í• ë‹¹ ì˜¤ë¥˜:', error);
        alert('í• ë‹¹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    /**
     * íšŒì› ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
     */
    async function assignPromotionOpenUserDetailModal(userId) {
      document.getElementById('userDetailModal').classList.add('is-active');
      
      const user = promotionCandidatesList.find(u => u.user_id === userId);
      if (!user) {
        alert('íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      promotionCurrentUserDetail = user;

      // ê¸°ë³¸ ì •ë³´ í‘œì‹œ
      document.getElementById('detailPharmacistName').textContent = user.pharmacist_name || '-';
      document.getElementById('detailPharmacyName').textContent = user.pharmacy_name || '-';
      document.getElementById('detailEmail').textContent = user.email || '-';
      document.getElementById('detailPhone').textContent = user.pharmacist_phone || '-';
      document.getElementById('detailBusinessNumber').textContent = user.business_number || '-';

      // í”„ë¡œëª¨ì…˜ ë“œë¡­ë‹¤ìš´ ë¡œë“œ
      await assignPromotionLoadFirstPaymentPromotions();

      // ìƒì„¸ ì •ë³´ ë¡œë“œ
      await assignPromotionLoadUserPromotionHistory(userId, user.business_number);
      await assignPromotionLoadUserSubscriptionStatus(userId);
      await assignPromotionLoadUserPendingPromotions(userId);
      assignPromotionCheckAssignmentEligibility(user);
    }

    /**
     * íšŒì› ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
     */
    function assignPromotionCloseUserDetailModal() {
      document.getElementById('userDetailModal').classList.remove('is-active');
      promotionCurrentUserDetail = null;
    }

    /**
     * íšŒì› í”„ë¡œëª¨ì…˜ ì´ë ¥ ì¡°íšŒ
     */
    async function assignPromotionLoadUserPromotionHistory(userId, businessNumber) {
      try {
        const response = await fetch('/admin/api/users/' + userId + '/promotion-history?business_number=' + businessNumber, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });

        const data = await response.json();
        const history = data.history || [];

        const summaryDiv = document.getElementById('promotionHistorySummary');

        if (history.length === 0) {
          summaryDiv.innerHTML = '<p class="has-text-centered">âœ… í”„ë¡œëª¨ì…˜ ì‚¬ìš© ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤ (ì‹ ê·œ ê³ ê°)</p>';
          return;
        }

        summaryDiv.innerHTML = `
          <table class="table is-fullwidth is-narrow">
            <thead>
              <tr>
                <th>í”„ë¡œëª¨ì…˜ ì½”ë“œ</th>
                <th>ì‚¬ìš© ê°œì›”</th>
                <th>ì†Œì§„ ì—¬ë¶€</th>
                <th>ë§ˆì§€ë§‰ ì‚¬ìš©</th>
              </tr>
            </thead>
            <tbody>
              ${history.map(h => `
                <tr>
                  <td>${h.promotion_code}</td>
                  <td>${h.used_months}ê°œì›”</td>
                  <td>${h.is_exhausted ? '<span class="tag is-danger">ì†Œì§„</span>' : '<span class="tag is-success">ê°€ëŠ¥</span>'}</td>
                  <td>${h.last_applied_at ? new Date(h.last_applied_at).toLocaleString('ko-KR') : '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <p class="notification is-warning is-light">
            âš ï¸ ì´ ì‚¬ì—…ìëŠ” ê³¼ê±° í”„ë¡œëª¨ì…˜ í˜œíƒì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ì²« ê²°ì œ ì „ìš© í”„ë¡œëª¨ì…˜ì€ í• ë‹¹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
          </p>
        `;

      } catch (error) {
        console.error('í”„ë¡œëª¨ì…˜ ì´ë ¥ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('promotionHistorySummary').innerHTML = 
          '<p class="has-text-danger">ì¡°íšŒ ì‹¤íŒ¨</p>';
      }
    }

    /**
     * íšŒì› êµ¬ë… ìƒíƒœ ì¡°íšŒ
     */
    async function assignPromotionLoadUserSubscriptionStatus(userId) {
      try {
        const response = await fetch('/admin/api/users/' + userId + '/subscription-status', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });

        const data = await response.json();
        const sub = data.subscription || {};
        const payments = data.payments || [];

        const summaryDiv = document.getElementById('subscriptionSummary');

        summaryDiv.innerHTML = `
          <div class="columns is-multiline">
            <div class="column is-6">
              <strong>í˜„ì¬ êµ¬ë… ìƒíƒœ:</strong> ${sub.status || 'ì—†ìŒ'}
            </div>
            <div class="column is-6">
              <strong>ë‹¤ìŒ ê²°ì œì¼:</strong> ${sub.next_billing_at ? new Date(sub.next_billing_at).toLocaleString('ko-KR') : '-'}
            </div>
            <div class="column is-6">
              <strong>ìµœê·¼ ê²°ì œ ê¸ˆì•¡:</strong> ${payments.length > 0 ? payments[0].amount.toLocaleString() + 'ì›' : '-'}
            </div>
            <div class="column is-6">
              <strong>ìë™ê²°ì œ ì—¬ë¶€:</strong> ${sub.status === 'active' ? '<span class="tag is-success">ON</span>' : '<span class="tag is-light">OFF</span>'}
            </div>
          </div>
        `;

      } catch (error) {
        console.error('êµ¬ë… ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('subscriptionSummary').innerHTML = 
          '<p class="has-text-danger">ì¡°íšŒ ì‹¤íŒ¨</p>';
      }
    }

    /**
     * íšŒì› ì˜ˆì•½ í”„ë¡œëª¨ì…˜ ì¡°íšŒ
     */
    async function assignPromotionLoadUserPendingPromotions(userId) {
      try {
        const response = await fetch('/admin/api/users/' + userId + '/pending-promotions', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });

        const data = await response.json();
        const pending = data.pending || [];

        const listDiv = document.getElementById('pendingPromotionsList');

        if (pending.length === 0) {
          listDiv.innerHTML = '<p class="has-text-centered">ì˜ˆì•½ëœ í”„ë¡œëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</p>';
          return;
        }

        listDiv.innerHTML = `
          <table class="table is-fullwidth is-narrow">
            <thead>
              <tr>
                <th>í”„ë¡œëª¨ì…˜ëª…</th>
                <th>ì˜ˆì•½ ì‹œê°</th>
                <th>ìƒíƒœ</th>
                <th>ì ìš© ì˜ˆì •</th>
              </tr>
            </thead>
            <tbody>
              ${pending.map(p => {
                let statusBadge = '';
                if (p.applied_at) {
                  statusBadge = '<span class="tag is-success status-applied">ì ìš© ì™„ë£Œ</span>';
                } else {
                  statusBadge = '<span class="tag is-warning status-reserved">ì˜ˆì•½ë¨</span>';
                }

                return `
                  <tr>
                    <td>${p.promotion_name}</td>
                    <td>${new Date(p.created_at).toLocaleString('ko-KR')}</td>
                    <td>${statusBadge}</td>
                    <td>${p.applied_at ? new Date(p.applied_at).toLocaleString('ko-KR') : 'ë‹¤ìŒ ê²°ì œ ì‹œ'}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;

      } catch (error) {
        console.error('ì˜ˆì•½ í”„ë¡œëª¨ì…˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('pendingPromotionsList').innerHTML = 
          '<p class="has-text-danger">ì¡°íšŒ ì‹¤íŒ¨</p>';
      }
    }

    /**
     * í• ë‹¹ ìê²© í™•ì¸
     */
    function assignPromotionCheckAssignmentEligibility(user) {
      const checkDiv = document.getElementById('assignmentEligibilityCheck');
      const assignButton = document.getElementById('singleAssignButton');

      if (!user.is_first_payment) {
        checkDiv.innerHTML = `
          <div class="notification is-danger is-light">
            <strong>âŒ í• ë‹¹ ë¶ˆê°€</strong><br>
            ì´ íšŒì›ì€ ì´ë¯¸ ê²°ì œ ì´ë ¥ì´ ìˆê±°ë‚˜, ê³¼ê±° í”„ë¡œëª¨ì…˜ í˜œíƒì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.<br>
            ì²« ê²°ì œ ì „ìš© í”„ë¡œëª¨ì…˜ì€ í• ë‹¹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
          </div>
        `;
        assignButton.disabled = true;
        return;
      }

      checkDiv.innerHTML = `
        <div class="notification is-success is-light">
          <strong>âœ… í• ë‹¹ ê°€ëŠ¥</strong><br>
          ì´ íšŒì›ì€ ì²« ê²°ì œ ì˜ˆì • ê³ ê°ì…ë‹ˆë‹¤. í”„ë¡œëª¨ì…˜ì„ í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      `;
      assignButton.disabled = false;
    }

    /**
     * ê°œë³„ í• ë‹¹ ì‹¤í–‰
     */
    async function assignPromotionExecuteSingleAssign() {
      if (!promotionCurrentUserDetail) {
        alert('íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const promotionId = document.getElementById('singlePromotionSelect').value;
      const memo = document.getElementById('singleAssignMemo').value.trim();

      if (!promotionId) {
        alert('í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!confirm(promotionCurrentUserDetail.pharmacist_name + 'ë‹˜ì—ê²Œ í”„ë¡œëª¨ì…˜ì„ í• ë‹¹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        const response = await fetch('/admin/api/assign-promotion', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token'),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            promotion_id: promotionId,
            user_ids: [promotionCurrentUserDetail.user_id],
            memo: memo || null,
            source: 'admin_assigned'
          })
        });

        const result = await response.json();

        if (result.success) {
          alert('í”„ë¡œëª¨ì…˜ì´ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.');
          assignPromotionCloseUserDetailModal();
          await assignPromotionLoadCandidates();
          await assignPromotionLoadAssignmentList();
        } else {
          alert('í• ë‹¹ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }

      } catch (error) {
        console.error('ê°œë³„ í• ë‹¹ ì˜¤ë¥˜:', error);
        alert('í• ë‹¹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    /**
     * ì˜ˆì•½ ê´€ë¦¬ ëª©ë¡ ì¡°íšŒ
     */
    async function assignPromotionLoadReservations() {
      try {
        const response = await fetch('/admin/api/assign-promotion/assignments', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });

        const data = await response.json();
        const tbody = document.getElementById('reservationTableBody');

        if (!data.assignments || data.assignments.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="has-text-centered">ì˜ˆì•½ëœ í”„ë¡œëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }

        tbody.innerHTML = data.assignments.map(assign => {
          const user = assign.users || {};
          const promo = assign.subscription_promotions || {};

          let statusBadge = '<span class="tag is-warning">ì˜ˆì•½ë¨</span>';
          if (assign.status === 'selected') {
            statusBadge = '<span class="tag is-info">ì„ íƒë¨</span>';
          }

          let discountInfo = '';
          if (promo.discount_type === 'free') {
            discountInfo = promo.free_months + 'ê°œì›” ë¬´ë£Œ';
          } else if (promo.discount_type === 'percent') {
            discountInfo = promo.discount_value + '% í• ì¸';
          } else if (promo.discount_type === 'amount') {
            discountInfo = promo.discount_value.toLocaleString() + 'ì› í• ì¸';
          }

          const sourceBadge = assign.source === 'admin_assigned' 
            ? '<span class="tag is-info">ê´€ë¦¬ì</span>' 
            : (assign.source === 'referral' 
              ? '<span class="tag is-link">ì¶”ì²œì¸</span>' 
              : '<span class="tag is-light">ì‚¬ìš©ì</span>');

          return `
            <tr>
              <td>
                <strong>${user.pharmacy_name || '(ì•Œ ìˆ˜ ì—†ìŒ)'}</strong><br>
                <small>${user.email || ''}</small>
              </td>
              <td>${promo.promotion_name || '(ì•Œ ìˆ˜ ì—†ìŒ)'}<br><small>${promo.promotion_code || ''}</small></td>
              <td>${discountInfo}</td>
              <td>${new Date(assign.created_at).toLocaleString('ko-KR')}</td>
              <td>${statusBadge}</td>
              <td>${sourceBadge}</td>
              <td>
                <button class="button is-danger is-small" onclick="assignPromotionCancelReservation('${assign.pending_id}')">
                  <span class="icon"><i class="fas fa-times"></i></span>
                  <span>ì·¨ì†Œ</span>
                </button>
              </td>
            </tr>
          `;
        }).join('');

      } catch (error) {
        console.error('ì˜ˆì•½ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('reservationTableBody').innerHTML = 
          '<tr><td colspan="7" class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
      }
    }

    /**
     * í”„ë¡œëª¨ì…˜ ì ìš© ì´ë ¥ ì¡°íšŒ
     */
    async function assignPromotionLoadAppliedHistory() {
      try {
        const response = await fetch('/admin/api/promotion-applied-history', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });

        const data = await response.json();
        const tbody = document.getElementById('appliedHistoryTableBody');

        if (!data.history || data.history.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered">ì ìš©ëœ í”„ë¡œëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }

        tbody.innerHTML = data.history.map(record => {
          const user = record.users || {};
          const promo = record.subscription_promotions || {};
          const payment = record.billing_payments || {};

          let discountInfo = '';
          if (promo.discount_type === 'free') {
            discountInfo = promo.free_months + 'ê°œì›” ë¬´ë£Œ';
          } else if (promo.discount_type === 'percent') {
            discountInfo = promo.discount_value + '% í• ì¸';
          } else if (promo.discount_type === 'amount') {
            discountInfo = promo.discount_value.toLocaleString() + 'ì› í• ì¸';
          }

          const sourceBadge = record.source === 'admin_assigned' 
            ? '<span class="tag is-info">ê´€ë¦¬ì</span>' 
            : (record.source === 'referral' 
              ? '<span class="tag is-link">ì¶”ì²œì¸</span>' 
              : '<span class="tag is-light">ì‚¬ìš©ì</span>');

          const planBadge = payment.subscription_type === 'monthly' 
            ? '<span class="tag is-light">ì›”ê°„</span>' 
            : '<span class="tag is-primary">ì—°ê°„</span>';

          return `
            <tr>
              <td>
                <strong>${user.pharmacy_name || '(ì•Œ ìˆ˜ ì—†ìŒ)'}</strong><br>
                <small>${user.email || ''}</small>
              </td>
              <td>${promo.promotion_name || '(ì•Œ ìˆ˜ ì—†ìŒ)'}<br><small>${promo.promotion_code || ''}</small></td>
              <td>${discountInfo}</td>
              <td>${new Date(payment.payment_date).toLocaleString('ko-KR')}</td>
              <td><strong>${payment.amount ? payment.amount.toLocaleString() : 0}ì›</strong></td>
              <td>${planBadge}</td>
              <td>${sourceBadge}</td>
              <td>
                <button class="button is-info is-small" onclick="openPaymentDetailModal('${user.user_id}')">
                  <span class="icon"><i class="fas fa-eye"></i></span>
                  <span>ìƒì„¸</span>
                </button>
              </td>
            </tr>
          `;
        }).join('');

      } catch (error) {
        console.error('ì ìš© ì´ë ¥ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('appliedHistoryTableBody').innerHTML = 
          '<tr><td colspan="8" class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
      }
    }

    /**
     * ì˜ˆì•½ ì·¨ì†Œ
     */
    async function assignPromotionCancelReservation(pendingId) {
      if (!confirm('ì´ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\në‹¤ìŒ ê²°ì œ ì‹œ í•´ë‹¹ í”„ë¡œëª¨ì…˜ì´ ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
        return;
      }

      try {
        const response = await fetch('/admin/api/assign-promotion/' + pendingId, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });

        const result = await response.json();

        if (result.success) {
          alert('ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          await assignPromotionLoadReservations();
          await assignPromotionLoadCandidates();
        } else {
          alert('ì·¨ì†Œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }

      } catch (error) {
        console.error('ì˜ˆì•½ ì·¨ì†Œ ì˜¤ë¥˜:', error);
        alert('ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    /**
     * íšŒì›ë³„ í”„ë¡œëª¨ì…˜ ì ìš© ìƒì„¸ ëª¨ë‹¬
     */
    async function openPaymentDetailModal(userId) {
      document.getElementById('paymentDetailModal').classList.add('is-active');

      try {
        const response = await fetch('/admin/api/users/' + userId + '/promotion-applied-detail', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });

        const data = await response.json();

        const userInfo = data.user || {};
        document.getElementById('paymentDetailUserInfo').innerHTML = `
          <div class="columns">
            <div class="column">
              <p><strong>ì•½êµ­ëª…:</strong> ${userInfo.pharmacy_name || '-'}</p>
              <p><strong>ì•½ì‚¬ëª…:</strong> ${userInfo.pharmacist_name || '-'}</p>
            </div>
            <div class="column">
              <p><strong>ì´ë©”ì¼:</strong> ${userInfo.email || '-'}</p>
              <p><strong>ì‚¬ì—…ìë²ˆí˜¸:</strong> ${userInfo.business_number || '-'}</p>
            </div>
          </div>
        `;

        const subscription = data.subscription || {};
        const nextAmount = data.next_payment_amount || 0;
        document.getElementById('paymentDetailSubscription').innerHTML = `
          <div class="columns">
            <div class="column">
              <p><strong>êµ¬ë… í”Œëœ:</strong> ${subscription.subscription_type === 'yearly' ? 'ì—°ê°„' : 'ì›”ê°„'}</p>
              <p><strong>ë‹¤ìŒ ê²°ì œì¼:</strong> ${subscription.next_billing_at ? new Date(subscription.next_billing_at).toLocaleDateString('ko-KR') : '-'}</p>
            </div>
            <div class="column">
              <p><strong>ë‹¤ìŒ ê²°ì œ ì˜ˆì • ê¸ˆì•¡:</strong> <span class="tag is-success is-large">${nextAmount.toLocaleString()}ì›</span></p>
              <p><small>${nextAmount === 0 ? 'í”„ë¡œëª¨ì…˜ì´ ì ìš©ëœ ë¬´ë£Œ ê²°ì œì…ë‹ˆë‹¤' : ''}</small></p>
            </div>
          </div>
        `;

        const payments = data.payments || [];
        if (payments.length === 0) {
          document.getElementById('paymentDetailHistory').innerHTML = 
            '<p class="has-text-centered">í”„ë¡œëª¨ì…˜ì´ ì ìš©ëœ ê²°ì œ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        } else {
          document.getElementById('paymentDetailHistory').innerHTML = `
            <table class="table is-fullwidth is-narrow">
              <thead>
                <tr>
                  <th>ê²°ì œì¼</th>
                  <th>í”„ë¡œëª¨ì…˜</th>
                  <th>í• ì¸ ì •ë³´</th>
                  <th>ê²°ì œ ê¸ˆì•¡</th>
                  <th>í”Œëœ</th>
                </tr>
              </thead>
              <tbody>
                ${payments.map(p => {
                  const promo = p.subscription_promotions || {};
                  let discountInfo = '';
                  if (promo.discount_type === 'free') {
                    discountInfo = promo.free_months + 'ê°œì›” ë¬´ë£Œ';
                  } else if (promo.discount_type === 'percent') {
                    discountInfo = promo.discount_value + '% í• ì¸';
                  } else if (promo.discount_type === 'amount') {
                    discountInfo = promo.discount_value.toLocaleString() + 'ì› í• ì¸';
                  }

                  return `
                    <tr>
                      <td>${new Date(p.payment_date).toLocaleDateString('ko-KR')}</td>
                      <td>${promo.promotion_name || '(ì•Œ ìˆ˜ ì—†ìŒ)'}<br><small>${promo.promotion_code || ''}</small></td>
                      <td>${discountInfo}</td>
                      <td><strong>${p.amount ? p.amount.toLocaleString() : 0}ì›</strong></td>
                      <td>${p.subscription_type === 'yearly' ? 'ì—°ê°„' : 'ì›”ê°„'}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
        }

      } catch (error) {
        console.error('íšŒì› ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
        document.getElementById('paymentDetailUserInfo').innerHTML = 
          '<p class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>';
      }
    }

    function closePaymentDetailModal() {
      document.getElementById('paymentDetailModal').classList.remove('is-active');
    }

    async function assignPromotionLoadAssignmentList() {
      await assignPromotionLoadReservations();
    }
  
  </script>
</body>
</html>
